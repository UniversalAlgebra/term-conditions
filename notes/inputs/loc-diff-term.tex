Let $\bp = (p_0, p_1, \dots, p_n)$ be an $(n+1)$-tuple of ternary terms, where
$p_0(x,y,z) \approx x$ and $p_n(x,y,z) \approx z$, the first and third
ternary projections, respectively. 
Let $\bA=\< A, \dots\>$ be an algebra.
In~\cite{MR3239624},
Valeriote and Willard define an \defn{$\bA$-triple for $\bp$}
to be a triple $(a,b,i)$ such that $a, b \in A$ and
$p_i(a,b,b) = p_{i+1}(a,a,b)$. They use this to define 
a ``local Hagemannâ€“Mitschke sequence'' on which they base an efficient algorithm
for deciding for a given $n$ whether an idempotent variety is $n$-permutable.
This inspired us to develop a related construct, called
a ``local difference term,'' that we expect will be useful for the
purpose of deciding, given a finite idempotent algebra $\bA$, whether the variety
generated by $\bA$ has a difference term.

Let $\bA=\< A, \dots\>$ be an algebra, fix $a, b \in A$ and
$i \in \{0,1\}$.
An
\defn{$\bA$-local difference term for
  $(a,b,i)$} is a ternary term $p$ satisfying the following:
\begin{align}
\text{ if $i=0$, then } & a \comm{\Cg^{\bA}(a,b)}{\Cg^{\bA}(a,b)} p(a,b,b); \label{eq:diff-triple}\\
\text{ if $i=1$, then } &p(a,a,b) = b. \nonumber
\end{align}
When often drop the
$\bA$ when the algebra is clear from context.
For example, we write $\Cg$ in place of $\Cg^{\bA}$, and 
call the term $p$ above a local difference term for 
$(a,b,i)$.
If $p$ satisfies~(\ref{eq:diff-triple}) for all triples
in some subset $S\subseteq A \times A \times \{0,1\}$, then we call $p$
a \defn{local difference term for $S$}.

Let 
$\sS = A \times A \times \{0,1\}$ and
suppose that every pair
$((a_0, b_0, \chi_0), (a_1, b_1, \chi_1))$
in $\sS^2$ has a local difference term.
That is, for each pair $((a_0, b_0, \chi_0), (a_1, b_1, \chi_1))$, there exists
$p$ such that for each $i \in \{0,1\}$ we have
\begin{align}
  a_i \comm{\Cg(a_i,b_i)}{\Cg(a_i,b_i)} p(a_i,b_i,b_i), & \;
  \text{ if $\chi_i=0$, and }  \label{eq:d-trip-i1}\\
  p(a_i,a_i,b_i) =b_i, & \;
  \text{ if $\chi_i=1$.}\nonumber
\end{align}
Under these hypothesis we will prove that every subset $S\subseteq \sS$
has a local difference term.
That is, there is a single term $p$ that works (i.e., satisfies
(\ref{eq:d-trip-i1})) for all $(a_i, b_i, \chi_i) \in S$.
The statement and proof of this new result follows.

\begin{thm}[\protect{cf.~\cite[Theorem 2.2]{MR3239624}}]
  Let $\sV$ be an idempotent variety and
  $\bA \in \sV$. Define
  $\sS= A \times A \times \{0,1\}$
  and suppose that every pair
  $((a_0, b_0, \chi_0), (a_1, b_1, \chi_1)) \in \sS^2$
  has a local difference term.
  Then every subset $S \subseteq \sS$,
  has a local difference term.
\end{thm}
\begin{proof}
The proof is by induction on the size of $S$.  In the base case, $|S| = 2$,
the claim holds by assumption.
Fix $n>2$ and assume that every subset of $\sS$ of size $2\leq k \leq n$ has a local
difference term. Let
$S = \{(a_0, b_0, \chi_0), (a_1, b_1, \chi_1), \dots, (a_{n}, b_{n},\chi_{n})\} \subseteq \sS$,
so that $|S| = n+1$.  We prove $S$ has a local difference term.

Since $|S| \geq 3$ and $\chi_i \in \{0,1\}$ for all $i$, there must exist
indices $i\neq j$ such that $\chi_i = \chi_j$. Assume without loss of generality
that one of these indices is $j=0$.  Define
the set
$S' = S \setminus \{(a_0, b_0, \chi_0)\}$.
Since $|S'| < |S|$, the set $S'$ has a local difference term $p$.
We split the remainder of the proof into two cases. In the first case
$\chi_0 = 0$ and in the second
$\chi_0 = 1$.

\vskip3mm

%--------------------------------------
\noindent \underline{Case 1:} $\chi_0 = 0$.
\\[4pt]
Assume $\chi_0 = 0$ and, 
without loss of generality, suppose $\chi_1 = \chi_2 =\cdots =\chi_k = 1$,
and $\chi_{k+1} = \chi_{k+2} = \cdots = \chi_{n} = 0$. Define
\[
T = \{(a_0, p(a_0, b_0, b_0), 0),
(a_1, b_1, 1), (a_2, b_2 1), \dots, (a_k, b_k, 1)\}.
\]
Let $t$ be a local difference term for $T$.
Define
\[
d(x,y,z) = t(x, p(x,y,y), p(x,y,z)).
\]
Since $\chi_0 =0$, we want $d(a_0,b_0,b_0)\comm{\Cg(a_0,b_0)}{\Cg(a_0,b_0)} a_0$.
We have
\begin{equation}
    \label{eq:100000}
  d(a_0,b_0,b_0) =
  t(a_0, p(a_0,b_0,b_0), p(a_0,b_0,b_0))\comm{\tau}{\tau} a_0,
\end{equation}
where $\tau:=\Cg(a_0, p(a_0,b_0,b_0))$.
Notice that
\[
(a_0, p(a_0,b_0,b_0)) = (p(a_0,a_0,a_0), p(a_0,b_0,b_0)) \in \Cg(a_0, b_0),
\]
so $\tau\leq \Cg(a_0,b_0)$. Therefore, 
$\comm{\tau}{\tau} {\leq} \comm{\Cg(a_0,b_0)}{\Cg(a_0,b_0)}$,
by monotonicity of the commutator.
It follows from this and (\ref{eq:100000}) that
$d(a_0,b_0,b_0)\comm{\Cg(a_0,b_0)}{\Cg(a_0,b_0)} a_0$,
as desired.

For $1\leq i \leq k$ we have $\chi_i =1$, so we want  $d(a_i,a_i,b_i) = b_i$. Indeed,
\begin{equation}
  \label{eq:200000}
  d(a_i,a_i,b_i) =
  t(a_i, p(a_i,a_i,a_i), p(a_i,a_i,b_i))=
  t(a_i, a_i, b_i) =b_i.
\end{equation}
The first equality in~(\ref{eq:200000}) holds by definition of $d$;
the second, because $p$ is an idempotent local difference term for
$S'$; the third, because $t$ is a local difference term for $T$.

The remaining triples in our original set $S$
have index $j$ satisfying $k<j\leq n$ and $\chi_j = 0$.
Thus, for these triples we want
$d(a_j,b_j,b_j)\comm{\Cg(a_j,b_j)}{\Cg(a_j,b_j)} a_j$. Indeed,
this holds since $p$ is a local difference term for $S'$, whence
$p(a_j,b_j,b_j))  \comm{\Cg(a_j,b_j)}{\Cg(a_j,b_j)} a_j$, so
\begin{equation*}
    %% \label{eq:300000}
  d(a_j,b_j,b_j) =
  t(a_j, p(a_j,b_j,b_j), p(a_j,b_j,b_j))
  \comm{\Cg(a_j,b_j)}{\Cg(a_j,b_j)} t(a_j,a_j,a_j) = a_j,
\end{equation*}
as desired.
\\[6pt]
%--------------------------------------
\underline{Case 2:}
$\chi_0 = 1$.
\\[4pt]
Assume $\chi_0 = 1$ and, 
without loss of generality, suppose $\chi_1 = \chi_2 =\cdots =\chi_k = 0$,
and $\chi_{k+1} = \chi_{k+2} = \cdots = \chi_{n} = 1$. Define
\[
T = \{(p(a_0, a_0, b_0), b_0, 1),
(a_1, b_1, 0), (a_2, b_2 0), \dots, (a_k, b_k, 0)\}.
\]
Let $t$ be a local difference term for $T$.
Define
\[d(x,y,z) = t(p(x,y,z), p(y,y,z), z).\] 
Since $\chi_0 =1$, we want $d(a_0,a_0,b_0) = b_0$. By the definition of
$d$,
\begin{equation*}
  d(a_0,a_0,b_0) =
  t(p(a_0,a_0,b_0), p(a_0,a_0,b_0), b_0) =b_0.
\end{equation*}
The last equality holds since $t$ is a local difference term for $T$, thus,
for $(p(a_0, a_0, b_0), b_0, 1)$.

For $1\leq i \leq k$ we have $\chi_i =0$, so we want
$d(a_i,b_i,b_i) \comm{\Cg(a_i,b_i)}{\Cg(a_i,b_i)} a_i$.
Again, starting from the definition of $d$ and using idempotence of $p$, we have
\begin{equation}
  \label{eq:40000}
  d(a_i,b_i,b_i) =
  t(p(a_i,b_i,b_i), p(b_i,b_i,b_i), b_i)=
  t(p(a_i,b_i,b_i), b_i, b_i).
\end{equation}
Next, since $p$ is a local difference term for $S'$, we have
\begin{equation}
  \label{eq:50000}
  t(p(a_i,b_i,b_i), b_i, b_i)
 \comm{\Cg(a_i,b_i)}{\Cg(a_i,b_i)}
 t(a_i, b_i, b_i).
\end{equation}
Finally, since $t$ is a local difference term for $T$, hence for
$(a_i, b_i, b_i)$ $(1\leq i \leq k)$, we have 
$t(a_i, b_i, b_i) \comm{\Cg(a_i,b_i)}{\Cg(a_i,b_i)} a_i$.
Combining this with (\ref{eq:40000}) and (\ref{eq:50000}) yields
\[
d(a_i,b_i,b_i) \comm{\Cg(a_i,b_i)}{\Cg(a_i,b_i)} a_i,
\]
as desired.

The remaining elements of our original set $S$
have indices $j$ satisfying $k<j\leq n$ and $\chi_j = 1$.
For these we want $d(a_j,a_j,b_j) = b_j$.
Since $p$ is a local difference term for $S'$, we have
$p(a_j,a_j,b_j) = b_j$, and this along with idempotence of $t$ yields
\begin{equation*}
d(a_j,a_j,b_j) =
  t(p(a_j,a_j,b_j), p(a_j,a_j,b_j), b_i)=
  t(b_j, b_j, b_j) =b_j,
\end{equation*}
as desired.
\end{proof}
