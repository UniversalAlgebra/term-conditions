%% FILE: math_notes_template.tex
%% AUTHOR: William DeMeo
%% DATE: 25 July 2016
%% COPYRIGHT: (C) 2016 William DeMeo,

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                         BIBLIOGRAPHY FILE            %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% The `filecontents` command will crete a file in the inputs directory called 
%% refs.bib containing the references in the document, in case this file does 
%% not exist already.
%% If you want to add a BibTeX entry, please don't add it directly to the
%% refs.bib file.  Instead, add it in this file between the
%% \begin{filecontents*}{refs.bib} and \end{filecontents*} lines
%% then delete the existing refs.bib file so it will be automatically generated 
%% again with your new entry the next time you run pdfaltex.
\begin{filecontents*}{inputs/refs.bib}
@article {MR1358491,
    AUTHOR = {Kearnes, Keith A.},
     TITLE = {Varieties with a difference term},
   JOURNAL = {J. Algebra},
  FJOURNAL = {Journal of Algebra},
    VOLUME = {177},
      YEAR = {1995},
    NUMBER = {3},
     PAGES = {926--960},
      ISSN = {0021-8693},
     CODEN = {JALGA4},
   MRCLASS = {08B10 (08B05)},
  MRNUMBER = {1358491},
MRREVIEWER = {H. Peter Gumm},
       DOI = {10.1006/jabr.1995.1334},
       URL = {http://dx.doi.org/10.1006/jabr.1995.1334},
}
@book {MR2839398,
    AUTHOR = {Bergman, Clifford},
     TITLE = {Universal algebra},
    SERIES = {Pure and Applied Mathematics (Boca Raton)},
    VOLUME = {301},
      NOTE = {Fundamentals and selected topics},
 PUBLISHER = {CRC Press, Boca Raton, FL},
      YEAR = {2012},
     PAGES = {xii+308},
      ISBN = {978-1-4398-5129-6},
   MRCLASS = {08-02 (06-02 08A40 08B05 08B10 08B26)},
  MRNUMBER = {2839398 (2012k:08001)},
MRREVIEWER = {Konrad P. Pi{\'o}ro},
}
@article {MR0434928,
    AUTHOR = {Taylor, Walter},
     TITLE = {Varieties obeying homotopy laws},
   JOURNAL = {Canad. J. Math.},
  FJOURNAL = {Canadian Journal of Mathematics. Journal Canadien de
              Math\'ematiques},
    VOLUME = {29},
      YEAR = {1977},
    NUMBER = {3},
     PAGES = {498--527},
      ISSN = {0008-414X},
   MRCLASS = {08A25},
  MRNUMBER = {0434928 (55 \#7891)},
MRREVIEWER = {James B. Nation},
}
  @BOOK{HM:1988,
    AUTHOR = {Hobby, David and McKenzie, Ralph},
    TITLE = {The structure of finite algebras},
    SERIES = {Contemporary Mathematics},
    VOLUME = {76},
    PUBLISHER = {American Mathematical Society},
    ADDRESS = {Providence, RI},
    YEAR = {1988},
    PAGES = {xii+203},
    ISBN = {0-8218-5073-3},
    MRCLASS = {08A05 (03C05 08-02 08B05)},
    MRNUMBER = {958685 (89m:08001)},
    MRREVIEWER = {Joel Berman},
    note = {Available from:
      \href{http://math.hawaii.edu/~ralph/Classes/619/HobbyMcKenzie-FiniteAlgebras.pdf}{math.hawaii.edu}}
  }
  @article {Freese:2009,
    AUTHOR = {Freese, Ralph and Valeriote, Matthew A.},
    TITLE = {On the complexity of some {M}altsev conditions},
    JOURNAL = {Internat. J. Algebra Comput.},
    FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {19},
    YEAR = {2009},
    NUMBER = {1},
    PAGES = {41--77},
    ISSN = {0218-1967},
    MRCLASS = {08B05 (03C05 08B10 68Q25)},
    MRNUMBER = {2494469 (2010a:08008)},
    MRREVIEWER = {Clifford H. Bergman},
    DOI = {10.1142/S0218196709004956},
    URL = {http://dx.doi.org/10.1142/S0218196709004956}
  }
@article {MR3076179,
    AUTHOR = {Kearnes, Keith A. and Kiss, Emil W.},
     TITLE = {The shape of congruence lattices},
   JOURNAL = {Mem. Amer. Math. Soc.},
  FJOURNAL = {Memoirs of the American Mathematical Society},
    VOLUME = {222},
      YEAR = {2013},
    NUMBER = {1046},
     PAGES = {viii+169},
      ISSN = {0065-9266},
      ISBN = {978-0-8218-8323-5},
   MRCLASS = {08B05 (08B10)},
  MRNUMBER = {3076179},
MRREVIEWER = {James B. Nation},
       DOI = {10.1090/S0065-9266-2012-00667-8},
       URL = {http://dx.doi.org/10.1090/S0065-9266-2012-00667-8},
}
@incollection {MR1404955,
    AUTHOR = {Kearnes, Keith A.},
     TITLE = {Idempotent simple algebras},
 BOOKTITLE = {Logic and algebra ({P}ontignano, 1994)},
    SERIES = {Lecture Notes in Pure and Appl. Math.},
    VOLUME = {180},
     PAGES = {529--572},
 PUBLISHER = {Dekker, New York},
      YEAR = {1996},
   MRCLASS = {08B05 (06F25 08A05 08A30)},
  MRNUMBER = {1404955 (97k:08004)},
MRREVIEWER = {E. W. Kiss},
}
@misc{william_demeo_2016_53936,
  author       = {DeMeo, William and Freese, Ralph},
  title        = {AlgebraFiles v1.0.1},
  month        = May,
  year         = 2016,
  doi          = {10.5281/zenodo.53936},
  url          = {http://dx.doi.org/10.5281/zenodo.53936}
}
@article{FreeseMcKenzie2016,
	Author = {Freese, Ralph and McKenzie, Ralph},
	Date-Added = {2016-08-22 19:43:56 +0000},
	Date-Modified = {2016-08-22 19:45:50 +0000},
	Journal = {Algebra Universalis},
	Title = {Maltsev families of varieties closed under join or Maltsev product},
	Year = {to appear}
}
@article {MR2333368,
    AUTHOR = {Kearnes, Keith A. and Tschantz, Steven T.},
     TITLE = {Automorphism groups of squares and of free algebras},
   JOURNAL = {Internat. J. Algebra Comput.},
  FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {17},
      YEAR = {2007},
    NUMBER = {3},
     PAGES = {461--505},
      ISSN = {0218-1967},
   MRCLASS = {08A35 (08B20 20B25)},
  MRNUMBER = {2333368},
MRREVIEWER = {Giovanni Ferrero},
       DOI = {10.1142/S0218196707003615},
       URL = {http://dx.doi.org/10.1142/S0218196707003615},
}
@article {MR2504025,
    AUTHOR = {Valeriote, Matthew A.},
     TITLE = {A subalgebra intersection property for congruence distributive
              varieties},
   JOURNAL = {Canad. J. Math.},
  FJOURNAL = {Canadian Journal of Mathematics. Journal Canadien de
              Math\'ematiques},
    VOLUME = {61},
      YEAR = {2009},
    NUMBER = {2},
     PAGES = {451--464},
      ISSN = {0008-414X},
     CODEN = {CJMAAB},
   MRCLASS = {08B10 (08A30 08B05)},
  MRNUMBER = {2504025},
MRREVIEWER = {Jarom{\'{\i}}r Duda},
       DOI = {10.4153/CJM-2009-023-2},
       URL = {http://dx.doi.org/10.4153/CJM-2009-023-2},
}
@misc{UACalc,
	Author = {Ralph Freese and Emil Kiss and Matthew Valeriote},
	Date-Added = {2014-11-20 01:52:20 +0000},
	Date-Modified = {2014-11-20 01:52:20 +0000},
	Note = {Available at: {\verb+www.uacalc.org+}},
	Title = {Universal {A}lgebra {C}alculator},
	Year = {2011}
}
@article{Freese2008,
	Author = {Freese, Ralph},
	Date-Added = {2016-08-29 01:31:23 +0000},
	Date-Modified = {2016-08-29 01:32:09 +0000},
	Journal = {Alg. Univ.},
	Pages = {337--343},
	Title = {Computing congruences efficiently},
	Volume = {59},
	Year = {2008}
}	
@incollection {MR1191235,
    AUTHOR = {Szendrei, {\'A}gnes.},
     TITLE = {A survey on strictly simple algebras and minimal varieties},
 BOOKTITLE = {Universal algebra and quasigroup theory ({J}adwisin, 1989)},
    SERIES = {Res. Exp. Math.},
    VOLUME = {19},
     PAGES = {209--239},
 PUBLISHER = {Heldermann, Berlin},
      YEAR = {1992},
   MRCLASS = {08-02 (08A40 08B05)},
  MRNUMBER = {1191235 (93h:08001)},
MRREVIEWER = {Ivan Chajda},
}
@unpublished{Bergman-DeMeo,
    AUTHOR = {Bergman, Clifford and DeMeo, William},
    TITLE = {Universal Algebraic Methods for Constraint Satisfaction Problems:
      with applications to commutative idempotent binars},
    YEAR = {2016},
    NOTE = {unpublished notes; soon to be available online},
    URL = {https://github.com/UniversalAlgebra/algebraic-csp}
}
\end{filecontents*}
%:biblio
\documentclass[12pt]{amsart}
% The following \documentclass options may be useful:
% preprint      Remove this option only once the paper is in final form.
% 10pt          To set in 10-point type instead of 9-point.
% 11pt          To set in 11-point type instead of 9-point.
% numbers       To obtain numeric citation style instead of author/year.

\usepackage{setspace}\onehalfspacing
\usepackage[normalem]{ulem} % for \sout (strikeout)
\usepackage{amsmath}
\usepackage{amscd,amssymb,amsthm} %, amsmath are included by default
\usepackage{latexsym,stmaryrd,mathrsfs,enumerate,scalefnt,ifthen}
\usepackage{mathtools}
\usepackage[mathcal]{euscript}
\usepackage[colorlinks=true,urlcolor=black,linkcolor=black,citecolor=black]{hyperref}
\usepackage{url}
\usepackage{scalefnt}
\usepackage{tikz}
\usepackage{color}
\usepackage[margin=1in]{geometry}
\usepackage{scrextend}

%%////////////////////////////////////////////////////////////////////////////////
%% Theorem styles
\numberwithin{equation}{section}
\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{prop}[theorem]{Proposition}
\theoremstyle{definition}
\newtheorem{claim}[theorem]{Claim}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{notation}[theorem]{Notation}
\newtheorem{Fact}[theorem]{Fact}
\newtheorem{question}{Question}
\newtheorem*{fact}{Fact}
\newtheorem{example}[theorem]{Example}
\newtheorem{examples}[theorem]{Examples}
\newtheorem{exercise}{Exercise}
\newtheorem*{lem}{Lemma}
\newtheorem*{cor}{Corollary}
\newtheorem*{remark}{Remark}
\newtheorem*{remarks}{Remarks}
\newtheorem*{obs}{Observation}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{inputs/proof-dashed}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Put new macros in the macros.sty file
\usepackage{inputs/macros}

\usepackage[backend=bibtex]{biblatex}
\bibliography{inputs/refs.bib}

\begin{document}

\title[Difference Terms and Semilattice Terms]{%
  Notes on Complexity of Deciding Existence of \\ Difference Terms and Semilattice Terms}
\date{\today}
\author{DeMeo}
\address{University of Hawaii}
\email{williamdemeo@gmail.com}
\author{Freese}
\email{ralph@math.hawaii.edu}
\author{Guillen}
\email{guillena@math.hawaii.edu}
\author{Holmes}
\email{tristanh@hawaii.edu}
\author{Lampe}
\email{bill@math.hawaii.edu}
\author{Nation}
\email{jb@math.hawaii.edu}


%% \thanks{The authors would like to extend special thanks to...}

\maketitle

%% \begin{abstract}\end{abstract}

\section{Introduction}
\label{sec:introduction}
The question motivating this effort is the following:
\begin{question}
Is there a polynomial-time algorithm to decide for a finite,
idempotent algebra $\bA$ if $V(\bA)$ has a difference term.
\end{question}
Kearnes proved in~\cite{MR1358491} that $\bA$ has a difference term iff
$V(\bA)$ has a Taylor term and no type-2 tails
(equivalently, $V(\bA)$ has no 1's and no type-2 tails).
No 1's is poly-time decidable by Valeriote's subtype theorem.
In~\cite{Freese:2009}, Freese and Valeriote solved an analogous problem, by
giving a positive answer to the following
\begin{question}
  Is there a polynomial-time algorithm to decide for a finite,
  idempotent algebra $\bA$ if $V(\bA)$ is \ac{cm}?
\end{question}
Congruence modularity is characterized by no 1's, no 5's and no tails.
Again no 1's and no 5's can be decided by the subtype theorem,
and in~\cite{Freese:2009} the authors prove that if there is
a tail in $V(\bA)$, there is a tail ``near the bottom.''
More precisely, if $\bA$ is finite and idempotent, and $V(\bA)$ has no
1's or 5's and has tails, then there is a tail in a 3-generated subalgebra of $\bA^2$.
Using this it is proved that deciding \cm is polynomial-time.

But the proof of the no tails part uses that in a variety with no 1's or 5's,
the congruence lattice modulo the {\it solvability congruence} (defined below)
is (join) semidistributive.
Now, restricting to just testing no type-2 tails (vs no tails of any type) is
not a problem. So, for example, there is a poly-time algorithm for testing if
$V(\bA)$ has no 1's, no 5's and no type-2 tails.  

Here is a related problem.
\begin{question}
  Is there an $\bA$, idempotent and having a Taylor term, no type-2 tail in 
  subalgebras of $\bA^k$, for $k < n$, but having a type-2 tail in a subalgebra
  of $\bA^n$. 
\end{question}
Perhaps we could construct such an algebra using congruence lattice
representation techniques. 

%% Hobby and McKenzie give some info about the types in a $D_2$
%% embedded in $\Con (\bA)$. (See~\cite[Lemma 6.3]{HM:1988}).
%% Exercise 7 of that section considers 4-element
%% algebras whose congruence lattice is the concrete embedding of $D_2$
%% in $\Eq(4)$; the one with coatoms $01|23$, $02|13$, and $0|123$, and with atoms
%% $0|1|23$ and $0|2|13$. By~\cite[Lemma 6.3]{HM:1988}, the middle-top
%% interval must be type 5 (assuming a Taylor term). But all the others can be 5's,
%% or all the others can be 4's, or all the others can be 3's.
%% One might attempt to find an example where they are all 2's, but that not possible
%% since otherwise $0|123$ would be a solvable congruence,
%% which would imply the two atoms would permute.


\section{Background, definitions, and notations}
\label{sec:defin-notat}
Our starting point is the set of lemmas at the beginning of Section 3 in
the Freese-Valeriote paper~\cite{Freese:2009}.
We first review some of the basic \ac{tct}
that comes up in the proofs in that paper. (In fact, most of this section 
is copied from the nice presentation of \tct background that appears
in~\cite[Sec.~2]{Freese:2009}.)

The reference for \tct is the book by Hobby and McKenzie
\cite{HM:1988}, according to which,
for each covering $\alpha \prec \beta$ in the congruence lattice of a finite
algebra $\bA$, the local behaviour of the $\beta$-classes is captured by the
so-called $(\alpha, \beta)$-traces~\cite[Def.~2.15]{HM:1988}.
Modulo $\alpha$, the induced structure on the traces is limited to one
of five possible types:

\begin{enumerate}[(1)]
\item unary algebra whose basic operations are all permutations (unary type);
\item one-dimensional vector space over some finite field (affine type);
\item 2-element boolean algebra (boolean type);
\item 2-element lattice (lattice type);
\item 2-element semilattice (semilattice type).
\end{enumerate}

Thus to each covering $\alpha \prec \beta$
corresponds a type in $\{1,2,3,4,5\}$ (see~\cite[Def.~5.1]{HM:1988}),
denoted by $\typ(\alpha, \beta)$.
The set of all types that are realized by covering pairs of congruences of a
finite algebra $\bA$ is denoted by $\typ\{\bA\}$, and if $\sK$ is a class of algebras,
then $\typ\{\sK\}$ denotes the union of the typesets of all finite algebras in $\sK$.
The set of types is ordered by the lattice of types given here:

\newcommand{\dotsize}{0.8pt}
%% To create nodes of lattices in a uniform and consistent way, we define
\tikzstyle{lat} = [circle,draw,inner sep=\dotsize]
% To scale all diagrams uniformly, change this setting:
\begin{center}
  
\newcommand{\figscale}{.8}
\begin{tikzpicture}[scale=\figscale]
  \node[lat] (1) at (0,0) {};
  \node[lat] (2) at (-1,1.5) {};
  \node[lat] (3) at (0,3) {};
  \node[lat] (4) at (.8,2.1) {};
  \node[lat] (5) at (.8,.9) {};
  \draw (1) node [below] {$1$};
  \draw (2) node [left] {$2$};
  \draw (3) node [above] {$3$};
  \draw (4) node [right] {$4$};
  \draw (5) node [right] {$5$};
  \draw[semithick] 
  (1) -- (2) -- (3) -- (4) -- (5) -- (1);
\end{tikzpicture}

\end{center}

The following results demonstrate that, for a finite idempotent algebra $\bA$,
whether or not $V(\bA)$ omits one of the order ideals of the lattice of types can be
determined locally. An algebra is strictly simple if it is simple (i.e. has no non-trivial
congruences) and has no non-trivial subalgebras (i.e. has no proper subalgebras with
more than one element).

\begin{prop}[Prop.~2.1~\cite{Freese:2009}]
If A is a finite idempotent algebra and $i \in \typ(V(\bA))$ then there
is a finite strictly simple algebra $\bS$ of type $j$ for some $j \leq i$ in $\sansH \sansS (\bA)$.
If
\begin{enumerate}[(1)]
\item 
  $j = 1$ then $\bS$ is term equivalent to a 2-element set;
\item
  $j = 2$ then $\bS$ is term equivalent to the idempotent reduct of a module;
\item
  $j = 3$ then $\bS$ is functionally complete;
\item
  $j = 4$ then $\bS$ is polynomially equivalent to a 2-element lattice;
\item
  $j = 5$ then $\bS$ is term equivalent to a 2-element semilattice.
\end{enumerate}
\end{prop}
\begin{proof}
  This is a combination of~\cite[Prop.~3.1]{MR2504025} and~\cite[Thm.~6.1]{MR1191235}.
\end{proof}

\begin{corollary}[Cor.~2.2~\cite{Freese:2009}]
  \label{cor:2.2}
  Let $\bA$ be a finite idempotent algebra and $T$ an order ideal in the
  lattice of types. Then $V(\bA)$ omits $T$ if and only if $\sansS(\bA)$ does.
  In particular, $V(\bA)$ omits 1 and 2 if and only if $S(\bA)$ omits 1 and 2.
\end{corollary}

%% The following lemma ties in with the previous proposition and will be used
%% in Sec. 6.
%% \begin{lemma}[Lemma 2.3~\cite{Freese:2009}] 
%%   Let $\bA$ be a finite idempotent algebra and let $\bS \in \sansH \sansS(\bA)$
%%   be strictly simple. Then there are elements $a, b \in A$ such that, if
%%   $\bB = \Sg^{\bA} (a, b)$, then $1_B = \Cg^{\bB} (a, b)$ and is join irreducible
%%   with unique lower cover $\rho$ such that $\bS = \bB/\rho$.
%% \end{lemma}
%% \begin{proof}
%%   Choose $\bB \in \sansS (\bA)$ as small as possible having $\bS$ as a homomorphic image,
%%   say $\bS = \bB/\rho$. We claim that if $a, b \in B$ with
%%   $(a, b) \in \notin \rho$ then they generate $\bB$. To
%%   see this, let $\bB'= \Sg^{\bB} (a, b)$ and let $h$ be the quotient map from B to S with kernel
%%   ρ. Then h(B  ) is a non-trivial subuniverse of S and so must equal S. Thus B  = B.
%%   Now let a, b ∈ B with (a, b) ∈
%%   / ρ. Since the block of Cg B (a, b) containing a
%%   and b is a subuniverse of B then from the previous paragraph, we conclude that
%%   Cg B (a, b) = 1 B and that ρ is its unique lower cover.
%% \end{proof}

In~\cite{Freese:2009}, Corollary~\ref{cor:2.2} is the starting point of the
development of a polynomial-time algorithm that determines if a given finite
idempotent algebra generates a \cm variety. According to the characterization
in~\cite[Ch.~8]{HM:1988} of locally finite congruence modular (resp.,
distributive) varieties, a finite algebra $\bA$ generates a congruence modular
(resp., distributive) variety $\sV$ if and only if the typeset of $\sV$ is
contained in $\{2, 3, 4\}$ (resp., $\{3, 4\}$) and all minimal sets of prime
quotients of finite algebras in $\sV$ have empty
tails~\cite[Def.~2.15]{HM:1988}. Note that in the distributive 
case the empty tails condition is equivalent to the minimal sets all having exactly
two elements.
It follows from Corollary~\ref{cor:2.2} that if $\bA$ is idempotent then one can
test the first condition, on omitting types 1 and 5 (or 1, 2, and 5) by searching
for a 2-generated subalgebra of $\bA$ whose typeset is not contained in
$\{2, 3, 4\}$ ($\{3, 4\}$). In~\cite[Sec. 6]{Freese:2009}, the authors prove that this
test can be performed in polynomial time, as a function of the size of $\bA$.
They use the following sequence of lemmas to establish that,
if $\bA$ is finite and idempotent, and if $\sV = V (\bA)$ omits types 1 and 5,
then to test for the existence of tails in $\sV$ it suffices to look for them
in the 3-generated subalgebras of $\bA^2$.

\section{The Freese-Valeriote Lemmas Revisited}
We take the previous section, which is essentially lifted directly
from~\cite{Freese:2009}, as our starting point.  From here we will
revisit each of the lemmas of \cite[Sec.~3]{Freese:2009}, and consider
whether they can be proved under modified hypotheses.
Specifically, Freese and Valeriote assume
that the type set of $V(\bA)$ contains no 1's and no 5's, and under this
assumption they prove that (non-empty) tails either do not occur in $V(\bA)$, or they occur
in 3-generated subalgebras of $\bA^2$.  We will assume
that the type set of $V(\bA)$ contains no 1's, and then prove that
either there are no type-2 tails in $V(\bA)$, or else type-2 tails can be
found ``quickly,'' say, in 3-generated subalgebras of $\bA^2$.
Thus, we continue to quote~\cite[Sec.~3]{Freese:2009} (verbatim
when possible), while modifying the assumptions and adjusting the arguments
as necessary.

Throughout the remainder of this section, let $\sS$ be a finite set of finite,
similar, idempotent algebras closed under the taking of subalgebras such that
$\sV = V (\sS)$ omits 1 \sout{and 5}. We will suppose that some finite algebra
$\bB$ in $\sV$ has a prime quotient whose minimal sets have non-empty
\emph{type-2} tails and show that there is a 3-generated subalgebra of the
product of two members of $\sS$ with this property.

Since $\sS$ is closed under the taking of subalgebras,
we may assume that the algebra $\bB$ from the previous paragraph is a subdirect
product of a finite number of members of $\sS$. Choose $n$ minimal such that for
some $\bA_i \in \sS$, the product $\prod_{i\leq n} \bA_i$
has a subdirect product $\bB$ that has a prime quotient with non-empty
\emph{type-2} tails. Under the assumption that $n > 1$ we will prove that $n = 2$.

For this $n$, select the $\bA_i$ and $\bB$ so that $|B|$ is as small as possible.
Let $\alpha \prec \beta$ be a prime quotient of $\bB$ with non-empty
\emph{type-2} tails and choose $\beta$ minimal with this property.
Let $U$ be an $(\alpha, \beta)$-minimal set and let $N$ be an
 $(\alpha, \beta)$-trace of $U$. Let 0 and 1 be
two distinct members of $N$ with $(0, 1) \notin \alpha$.

\begin{lemma}[Lem.~3.1~\cite{Freese:2009}]
Let $t$ be a member of the tail of $U$. Then $\beta$ is the congruence of $\bB$
generated by the pair $(0, 1)$ and $\bB$ is generated by $\{0, 1, t\}$.
\end{lemma}

For $i \leq n$, let $\pi_i$ be the projection homomorphism from $\bB$ onto
$\bA_i$ and let $\rho_i$ be the kernel of $\pi_i$. By the minimality of $n$ we
know that the intersection of any  proper subset of the
$\rho_i$, $1 \leq i \leq n$ is strictly above $0_B$.

\begin{lemma}[Lem.~3.2~\cite{Freese:2009}]
Let $\rho$ be the intersection of a proper subset of the $\rho_i$, $1 \leq i \leq n$.
Either $\beta \leq \rho$ or $\alpha \join \rho = 1_B$.
\end{lemma}

\begin{lemma}[Lem.~3.3~\cite{Freese:2009}]
  $\alpha \join \rho_i < 1_B$ for at least one $i$ and $\alpha \join \rho_j = 1_B$
  for at least one $j$.  
\end{lemma}

\begin{theorem}[Thm.~3.4~\cite{Freese:2009}]
  Let $\sV$ be the variety generated by some finite set $\sS$ of finite,
  idempotent algebras that is closed under taking subalgebras. If $\sV$
  omits type 1 \sout{and 5} and some finite member of $\sV$ has a prime quotient
  whose minimal sets have non-empty \emph{type-2} tails then there is some
  3-generated algebra B with this property that belongs to $\sS$ or is a subdirect
  product of two algebras from $\sS$. 
\end{theorem}

\section{Some Useful Tools}
This section presents some lemmas about congruences, centralizers, and abelian
algebras that we have recently found very useful (see~\cite{Bergman-DeMeo}).
They seem relevant and perhaps useful for the purpose of proving some of the
results in the previous section.

In previous work, nonabelian algebras played the following useful role:
a theorem would begin with the assumption that a particular algebra $\bA$ is
nonabelian and then proceed to show that if the result to be proved were false,
then $\bA$ would have to be abelian.
Such arguments employ some basic facts about abelian algebras that we now review.
%% (Much of the notation we adopt here is similar to that used
%% in~\cite{MR3076179}.)

\subsection{Definitions} %: tolerance, centralizing, abelian}
Let $\bA = \<A, F^{\bA}\>$ be an algebra.
A reflexive, symmetric, compatible binary relation $T\subseteq A^2$ is called a
\defn{tolerance of $\bA$}.  
As a compatible binary relation, a tolerance is a subuniverse of $\bA^2$.
If $T$ is a tolerance of $\bA$, and if $(\bu, \bv) \in A^m\times A^m$
is a pair of $m$-tuples of $A$, then we write 
$\bu \mathrel{\bT} \bv$ just in case $\bu(i) \mathrel{T} \bv(i)$ for all $i\in \mm$. 
(Here we have surreptitiously introduced another very convenient notation, namely,
$\mm := \{0, 1, 2, \dots, m-1\}$.)

Suppose $S$ and $T$ are tolerances on $\bA$.  An \defn{$S,T$-matrix} 
is a $2\times 2$ array of the form
\[
\begin{bmatrix*}[r] t(\ba,\bu) & t(\ba,\bv)\\ t(\bb,\bu)&t(\bb,\bv)\end{bmatrix*},
\]
where $t$, $\ba$, $\bb$, $\bu$, $\bv$ have the following properties:
\begin{enumerate}[(i)]
\item $t\in \Clo_{\ell + m}(\bA)$,
\item $(\ba, \bb)\in A^\ell\times A^\ell$ and $\ba \mathrel{\bS} \bb$,
\item $(\bu, \bv)\in A^m\times A^m$ and $\bu \mathrel{\bT} \bv$.
\end{enumerate}
Let $\delta$ be a congruence relation of $\bA$.
If the entries of every $S,T$-matrix satisfy
\begin{equation}
  \label{eq:22}
t(\ba,\bu) \mathrel{\delta} t(\ba,\bv)\quad \iff \quad t(\bb,\bu) \mathrel{\delta} t(\bb,\bv),
\end{equation}
then we say that $S$ \defn{centralizes $T$ modulo} $\delta$ and we write 
$\sansC(S, T; \delta)$.
That is, $\sansC(S, T; \delta)$ holds iff 
(\ref{eq:22}) holds \emph{for all}
$\ell$, $m$, $t$, $\ba$, $\bb$, $\bu$, $\bv$ satisfying properties (i)--(iii).
The condition $\sansC(S, T; 0_{A})$ is sometimes called the 
\defn{$S, T$-term condition}, and when it holds we say  that
$S$ \defn{centralizes} $T$, and write
$\sansC(S, T)$.
%% REMOVING THIS since I don't think we ever use the commutator notation again.
%% The \defn{commutator} of $\bS$ and $\bT$, denoted by $[\bS, \bT]$,
%% is the least congruence $\delta$ such that $\sansC(\bS, \bT; \delta)$ 
%% holds.  

A tolerance $T$ is called \defn{abelian} if
$\sansC(T, T)$. %(i.e., $[\bT, \bT] = 0_A$).  
An algebra $\bA$ is called \defn{abelian} if $1_A$ is abelian.
%% (i.e., $[1_A, 1_A] = 0_A$).
%% The \defn{centralizer of $\bT$ modulo $\delta$}, denoted by
%% $(\delta : \bT )$, is the largest congruence $\alpha$ on $\bA$ such that 
%% $\sansC(\alpha, \bT ; \delta)$ holds.

\begin{remark}
An algebra $\bA$ is abelian iff $\sansC(1_A, 1_A)$ iff
\[
\forall \ell \in \{0,1,2,\dots \}, 
\quad \forall m \in  \{1,2,\dots \},
\quad \forall t\in \Clo_{\ell + m}(\bA),
\quad \forall (a, b)\in A^\ell\times A^\ell,
\]
\[
\ker t(a, \cdot)=\ker t(b, \cdot).
\]
\end{remark}

\subsection{Alternative development}
Here is the development of similar notions from Hobby and McKenzie~\cite[Ch.~3]{HM:1988}.
Let $\alpha$, $\beta$, $\delta$ be congruences of an algebra $\bA$.
We use the formula $\sansC(\alpha, \beta; \delta)$
(in words, $\alpha$ centralizes $\beta$ modulo $\delta$) as an abbreviation for the
following property: For every $n > 1$, for every $f \in \Pol_n(\bA)$,
for all $(u,v)\in \alpha$, and for all $(x_i, y_i)\in \beta$ $(1< i<n)$, 
the following equivalence holds:
\begin{equation}
  \label{eq:1}
  f(u, x_1, \dots, x_{n-1}) \mathrel{\delta}  f(u, y_1, \dots, y_{n-1})
  \quad \iff \quad
  f(v, x_1, \dots, x_{n-1}) \mathrel{\delta}  f(v, y_1, \dots, y_{n-1}).
\end{equation}


\subsection{Facts}
We now collect some useful facts about centralizers of congruence relations.
These facts are well-known and not very hard to prove. (See, for
example,~\cite{MR3076179}.)

\noindent [{\it wjd: I'm not sure about item
    (\ref{fact:dual_monotone_centralizers}) in the next lemma.}]

\begin{lemma}
\label{lem:centralizers}
Let $\bA$ be an algebra with congruences 
$\alpha, \beta, \gamma, \alpha', \beta' \in \Con(\bA)$, and let 
$\bB$ be a subalgebra of $\bA$. Then,
\begin{enumerate}
\item \label{fact:centralizing_over_meet}
  $\sansC(\alpha, \beta; \alpha \meet \beta)$;
\item \label{fact:centralizing_over_meet2}
  if $\sansC(\alpha, \beta; \gamma)$ and $\sansC(\alpha, \beta; \gamma')$, then
  $\sansC(\alpha, \beta; \gamma \meet \gamma')$;
\item \label{fact:centralizing_over_join1}
  if $\sansC(\alpha, \beta; \gamma)$ and $\sansC(\alpha', \beta; \gamma)$, then
  $\sansC(\alpha \join \alpha', \beta; \gamma)$;
%% \item \label{fact:centralizing_over_join2}
%%   if $\sansC(\alpha, \beta; \gamma)$ and $\sansC(\alpha, \beta'; \gamma)$, then
%%   $\sansC(\alpha, \beta \join \beta'; \gamma)$;
\item \label{fact:monotone_centralizers1}
  if $\sansC(\alpha, \beta; \gamma)$ and $\alpha' \leq \alpha$, then 
  $\sansC(\alpha', \beta; \gamma)$;
\item \label{fact:monotone_centralizers2}
  if $\sansC(\alpha, \beta; \gamma)$ and $\beta' \leq \beta$, then
  $\sansC(\alpha, \beta'; \gamma)$;
\item \label{fact:dual_monotone_centralizers}
  if $\sansC(\alpha, \beta; \gamma)$ and $\gamma \leq \gamma'$, then
  $\sansC(\alpha, \beta; \gamma')$;
\item \label{item:subalg}
  if $\sansC(\alpha, \beta; \delta)$ holds in $\bA$, 
  then $\sansC(\alpha\cap B^2, \beta\cap B^2;\delta\cap B^2)$ holds in $\bB$;
\item \label{item:factors}
  if $\delta' \leq \delta$, then $\sansC(\alpha, \beta; \delta)$ holds 
  in $\bA$ if and only if $\sansC(\alpha/\delta', \beta/\delta'; \delta/\delta')$
  holds in $\bA/\delta'$.
\end{enumerate}
\end{lemma}

\noindent [{\it wjd: I don't remember what made me think (\ref{fact:dual_monotone_centralizers})
is true. Maybe it holds in the \cm case?}]

\begin{remark}
By (\ref{fact:centralizing_over_meet}), 
if $\alpha \meet \beta = 0_{\bA}$,  
then $\sansC(\beta, \alpha)$ and $\sansC(\alpha, \beta)$.
By (\ref{fact:dual_monotone_centralizers}),
if an algebra $\bA$ is abelian, 
then $\sansC(1_A, 1_A; \theta)$ for all $\theta \in \Con(\bA)$, so
in this case (\ref{item:factors}) implies that %$\sansC(1_{\bA/\theta}, 1_{\bA/\theta})$ 
$\bA/\theta$ is abelian for every $\theta \in \Con(\bA)$.
\end{remark}

We close this section with a collection of lemmas that can be useful for showing 
that an algebra is abelian.  Proofs of these facts appear in Appendix
Section~\ref{sec:proofs-elem-facts}.

We denote the diagonal of $A$ by $D(A) := \{(a,a): a \in A\}$. 
\begin{lemma}
\label{lem:diagonal}
An algebra $\bA$ is abelian if and only if there is some $\theta \in \Con (\bA^2)$ that has
the diagonal set $D(A)$ as a congruence class.
\end{lemma}

Lemma~\ref{lem:diagonal} can be used to prove the next result
which states that if there is a congruence of $\bA_1 \times \bA_2$ that has the
graph of a bijection between $A_1$ and $A_2$ as a block, then both $\bA_1$ and
$\bA_2$ are abelian algebras.

\begin{lemma}
  \label{lem:bijection_abelian}
Suppose $\rho \colon A_0 \to A_1$ is a bijection and suppose the graph
$\{(x, \rho x) \mid x \in A_0\}$ is a block of some congruence
$\beta \in \Con (A_0 \times A_1)$.  Then both $\bA_0$ and $\bA_1$ are abelian.
\end{lemma}

\begin{lemma}
\label{lem:triv-clone-implies-abelian}
If $\Clo(\bA)$ is trivial (i.e., generated by the projections),
then $\bA$ is abelian.
\end{lemma}

\begin{lemma}\label{lem:M3-abelian}
If $\alpha_1$, $\alpha_2$, $\alpha_3 \in \Con(\bA)$ are pairwise complements,
then $\sansC(1_A, \alpha_i)$ for each $i=1,2,3$.  If, in addition, $\bA$ is
idempotent and has a Taylor term operation, then $\sansC(1_A, 1_A)$; that is, $\bA$ is abelian.
\end{lemma}

The last lemma is okay, but we can do better.  Here are is a refinement.

\newpage

\appendix
\section{Omitted Proofs}

\subsection{Facts about centralizers and abelian algebras}
\label{sec:proofs-elem-facts}

\begin{lemma}[Lemma~\ref{lem:triv-clone-implies-abelian}]
If $\Clo(\bA)$ is trivial (i.e., generated by the projections),
then $\bA$ is abelian.
\end{lemma}
In fact, it can be shown that $\bA$ is \emph{strongly abelian} in this case, but
we won't prove this stronger result. The proof that $\bA$ is abelian is
elementary is a nice and easy example of a standard proof technique---induction on
term height.\footnote{This proof would be a good one to try in a proof assistant
  like Coq, since such tools excel at inductive arguments like this one.}
\begin{proof}
We want to show $\sansC(1_A, 1_A)$.  Equivalently, we must show
that for all $t\in \Clo(\bA)$ (say, $(\ell+m)$-ary) 
and all $a, b \in A^\ell$, we have $\ker t(a,\cdot)=\ker t(b,\cdot)$.
We prove this by induction on the height of the term $t$.  Height-one terms are
projections and the result is obvious for these.  Let $n>1$ and assume the result
holds for all terms  of height less than
$n$.  Let $t$ be a term of height $n$, say, $k$-ary.  Then for some terms 
$g_1, \dots, q_k$ of height less than $n$ and for some $j\leq k$, we have
$t = p^k_j [q_1, q_2, \dots, q_k] = q_j$ and since $q_j$ has height less than
$n$, we have
\[
\ker t(a,\cdot)=\ker g_j(a,\cdot) = \ker g_j(b,\cdot)=\ker t(b,\cdot).
\]\end{proof}

\begin{lemma}[Lemma \ref{lem:M3-abelian}]
If $\alpha_1$, $\alpha_2$, $\alpha_3 \in \Con(\bA)$ are pairwise complements,
then $\sansC(1_A, \alpha_i)$ for each $i=1,2,3$.  If, in addition, $\bA$ is
idempotent and has a Taylor term operation, then $\sansC(1_A, 1_A)$; that is, $\bA$ is abelian.
\end{lemma}
\begin{proof}
  The goal is to prove $\sansC(1_A, 1_A)$.
  By Lemma~\ref{lem:centralizers}~(\ref{fact:centralizing_over_meet}), we have
  $\sansC(\alpha_1, \alpha_2; \alpha_1 \meet \alpha_2)$.  
  Since $\alpha_1 \meet \alpha_2= 0_A$, this means
  $\sansC(\alpha_1, \alpha_2)$.
  Similarly, $\sansC(\alpha_3, \alpha_2)$.  Therefore, by 
  Lemma~\ref{lem:centralizers}~(\ref{fact:centralizing_over_join1}), we have
  $\sansC(\alpha_1 \join \alpha_3, \alpha_2)$. This is equivalent to 
  $\sansC(1_A, \alpha_2)$, since $\alpha_1 \join \alpha_3 = 1_A$. 
  The same argument \emph{mutatis-mutandis} yields
  $\sansC(1_A,\alpha_1)$ and $\sansC(1_A,\alpha_3)$. 
  Before proceeding, note that $\sansC(\alpha_1, \alpha_1)$, by 
  Lemma~\ref{lem:centralizers}~(\ref{fact:monotone_centralizers1}).
  Now, if $\bA$ is idempotent and has a Taylor term operation, then
  by \ref{thm:kearnes-kiss-3.27} we have 
  $\sansC(\alpha_1 \join \alpha_2,\alpha_1 \join \alpha_2; \alpha_2)$.
  That is, $\sansC(1_A,1_A; \alpha_2)$.
  Similarly, $\sansC(1_A,1_A; \alpha_3)$.
  By~\ref{lem:centralizers}~(\ref{fact:centralizing_over_meet2}) then, 
  $\sansC(1_A,1_A; \alpha_2 \meet\alpha_3)$. 
  That is, $\sansC(1_A,1_A)$.
\end{proof}

\begin{lemma}[Lemma \ref{lem:diagonal}]
 An algebra $\bA$ is abelian if and only if there is some 
 $\theta \in \Con (\bA^2)$ that has the diagonal $D(A):= \{(a,a): a \in A\}$ 
 as a congruence class.
\end{lemma}
\begin{proof}
($\Leftarrow$) Assume $\Theta$ is such a congruence.  Fix 
  $k<\omega$,
  $t^{\bA}\in \Clo_{k+1}(\bA)$, 
  $u, v \in A$, and
  $\bx, \by \in A^k$.
  We will prove the implication~(\ref{eq:22}), which in the present context is
\begin{equation*}
t^\bA(\bx,u) = t^\bA(\by,u) \quad \Longrightarrow \quad 
t^{\bA}(\bx,v) = t^{\bA}(\by,v).
\end{equation*}
Since $D(A)$ is a class of $\Theta$, we have 
  $(u,u) \mathrel{\Theta} (v,v)$, and since $\Theta$ is a reflexive relation, we have
  $(x_i,y_i)  \mathrel{\Theta} (x_i,y_i)$ for all $i$.  Therefore,
\begin{equation}
  \label{eq:9}  
  t^{\bA\times \bA}((x_1,y_1), \dots, (x_k,y_k), (u,u))
  \mathrel{\Theta}
  t^{\bA\times \bA}((x_1,y_1), \dots, (x_k,y_k), (v,v)).
\end{equation}
  since $t^{\bA \times \bA}$ is a term operation of $\bA\times \bA$.
  Note that~(\ref{eq:9}) is equivalent to
  \begin{equation}
    \label{eq:13}
    (t^{\bA}(\bx, u), t^{\bA}(\by,u))
    \mathrel{\Theta}
    (t^{\bA}(\bx, v), t^{\bA}(\by, v)).
  \end{equation}
  If $t^{\bA}(\bx, u)= t^{\bA}(\by, u)$ then 
  the first pair in~(\ref{eq:13}) belongs to the $\Theta$-class
  $D(A)$, so the second pair must also belong this $\Theta$-class.
  That is, $t^{\bA}(\bx, v)= t^{\bA}(\by, v)$, as desired.

  \vskip2mm

  \noindent ($\Rightarrow$) Assume $\bA$ is abelian. We show
  $\Cg^{\bA^2}(D(A)^2)$ has $D(A)$ as a block.  Assume
  \begin{equation}
    \label{eq:16}
  ((x,x), (c,c')) \in \Cg^{\bA^2}(D(A)^2).
  \end{equation}
  It suffices to prove that $c=c'$.  Recall, Mal'tsev's congruence generation
  theorem states that (\ref{eq:16}) holds iff
  %$(x,x) \theta (c,c') \in \Cg^{\bA^2}(D(A)^2)$ iff %% for $0\leq i \leq n$ and 
  %% $0\leq j \leq n-1$, there exist
  \begin{align*}
  \exists \,& (z_0,z_0'), (z_1,z_1'), \dots, (z_n,z_n') \in A^2\\
    \exists \,& ((x_0,x_0'), (y_0,y_0')), ((x_1,x_1'), (y_1,y_1')), \dots, 
    ((x_{n-1},x_{n-1}'), (y_{n-1},y_{n-1}')) \in D(A)^2\\
    \exists \, & f_0, f_1, \dots, f_{n-1}\in F^*_{\bA^2}
  \end{align*}
  %% \begin{align*}
  %% (z_i,z_i') &\in A^2\\
  %% ((x_j,x_j'), (y_j,y_j')) &\in D(A)^2\\
  %% f_j &\in F^*_{\bA^2}
  %% \end{align*}
  such that 
  \begin{align}
    \label{eq:7}
    \{(x, x),(z_1,z_1')\} &= \{f_0(x_0,x_0'), f_0(y_0,y_0')\}\\
\nonumber
     \{(z_1,z_1'),(z_2,z_2')\} &= \{f_1(x_1,x_1'), f_1(y_1,y_1')\}\\
\nonumber
     & \vdots\\
    \label{eq:8}
     \{(z_{n-1},z_{n-1}'),(c, c')\} &= \{f_{n-1}(x_{n-1},x_{n-1}'), f_{n-1}(y_{n-1},y_{n-1}')\}
 \end{align}
The notation $f_i\in F^*_{\bA^2}$ means 
\begin{align*}
f_i(x, x') &= g_i^{\bA^2}((a_1, a_1'), (a_2, a_2'), \dots, (a_k, a_k'), (x, x'))\\
&= (g_i^{\bA}(a_1, a_2, \dots, a_k, x), g_i^{\bA}(a_1', a_2', \dots, a_k', x')),
\end{align*}
for some $g_i^{\bA} \in \Clo_{k+1}(\bA)$ and some constants 
$\ba = (a_1, \dots, a_k)$ and $\ba' = (a_1', \dots, a_k')$ in $A^k$. 
Now, $((x_i,x_i'), (y_i,y_i'))\in D(A)^2$ implies 
$x_i=x_i'$, and $y_i=y_i'$, so in fact we have 
\[
     \{(z_i,z_i'),(z_{i+1},z_{i+1}')\} = \{f_i(x_i,x_i), f_i(y_i,y_i)\} \quad (0\leq i < n).
\]
Therefore, by Equation~(\ref{eq:7}) we have either 
\[
     (x,x)= (g_i^{\bA}(\ba, x_0), g_i^{\bA}(\ba', x_0)) \quad \text{ or } \quad 
     (x,x)= (g_i^{\bA}(\ba, y_0), g_i^{\bA}(\ba', y_0)).
\]
Thus, either $g_i^{\bA}(\ba, x_0) =  g_i^{\bA}(\ba', x_0)$ %\quad \text{ or } \quad 
or $g_i^{\bA}(\ba, y_0) =  g_i^{\bA}(\ba', y_0)$.
By the abelian assumption, if one of these equations holds, then so does the
other. This and and Equation (\ref{eq:7}) imply $z_1 = z_1'$.  Applying the same
argument inductively, we find that $z_i = z_i'$ for all $1\leq i < n$ and so, by
(\ref{eq:8}) and the abelian property, we have $c= c'$.
\end{proof}

\begin{lemma}[Lemma~\ref{lem:bijection_abelian}]
Suppose $\rho\colon A_1 \to A_2$ is a bijection and suppose the graph
$\{(x, \rho x) \mid x \in A_1\}$ is a block of some congruence
$\beta \in \Con (A_1 \times A_2)$.  Then both $\bA_1$ and $\bA_2$ are abelian.
\end{lemma}
\begin{proof}
  Define the relation $\alpha\subseteq (A_1\times A_1)^2$ as follows: for
  $((a,a'), (b,b')) \in (A_1\times A_1)^2$,
  \[
  (a,a')\mathrel{\alpha} (b,b')
  \quad \iff \quad
  (a, \rho a') \mathrel{\beta} (b, \rho b')
  \]
  We prove that the diagonal $D(A_1)$ is a block of $\alpha$ by showing that
  $(a, a) \mathrel{\alpha} (b,b')$ implies $b = b'$.
  Indeed, if $(a, a) \mathrel{\alpha} (b,b')$, then
  $(a, \rho a) \mathrel{\beta} (b, \rho b')$, which means that
  $(b, \rho b')$ belongs to the block and
  $(a, \rho a)/\beta = \{(x, \rho x): x\in A_1\}$.  Therefore,
  $\rho b  = \rho b'$, so $b = b'$ since $\rho$ is injective.
  This proves that $\bA_1$ is abelian.

  To prove $\bA_2$ is abelian, we reverse the roles of $A_1$ and $A_2$ in the
  foregoing argument.  
  If $\{(x, \rho x) \mid x \in A_1\}$ is a block of $\beta$,
  then 
  $\{(\rho^{-1}(\rho x), \rho x) \mid \rho x \in A_2\}$ is a block of $\beta$; that
  is, $\{(\rho^{-1} y, y) \mid y \in A_2\}$ is a block of $\beta$.  Define 
  the relation $\alpha\subseteq (A_2\times A_2)^2$ as follows: for
  $((a,a'), (b,b')) \in (A_2\times A_2)^2$,
  \[
  (a,a')\mathrel{\alpha} (b,b')
  \quad \iff \quad
  (\rho^{-1}a, \rho a') \mathrel{\beta} (\rho^{-1}b, \rho b').
  \]
  As above, we can prove that the diagonal $D(A_2)$ is a block of $\alpha$
  by using the injectivity of $\rho^{-1}$ to show that $(a, a) \mathrel{\alpha}
  (b,b')$
  implies $b = b'$.
\end{proof}

%% This is the text of the appendix, if you need one.

%\bibliographystyle{amsplain} %% or amsalpha
%% \bibliographystyle{plain-url}
\printbibliography


\end{document}
