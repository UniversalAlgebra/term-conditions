%% FILE: diffTerm.tex
%% AUTHOR: William DeMeo, Ralph Freese, Matthew Valeriote
%% DATE: 13 April 2017
%% COPYRIGHT: (C) 2017 DeMeo, Freese, Valeriote

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                         BIBLIOGRAPHY FILE            %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% The `filecontents` command will crete a file in the inputs directory called 
%% refs.bib containing the references in the document, in case this file does 
%% not exist already.
%% If you want to add a BibTeX entry, please don't add it directly to the
%% refs.bib file.  Instead, add it in this file between the
%% \begin{filecontents*}{refs.bib} and \end{filecontents*} lines
%% then delete the existing refs.bib file so it will be automatically generated 
%% again with your new entry the next time you run pdfaltex.
\begin{filecontents*}{inputs/refs.bib}
@article {MR3350334,
    AUTHOR = {Horowitz, Jonah},
     TITLE = {Testing for edge terms is decidable},
   JOURNAL = {Algebra Universalis},
  FJOURNAL = {Algebra Universalis},
    VOLUME = {73},
      YEAR = {2015},
    NUMBER = {3-4},
     PAGES = {321--334},
      ISSN = {0002-5240},
   MRCLASS = {03C05 (03B25 08A40 08B05)},
  MRNUMBER = {3350334},
MRREVIEWER = {David Casperson},
       DOI = {10.1007/s00012-015-0325-4},
       URL = {http://dx.doi.org/10.1007/s00012-015-0325-4},
}
@article {MR3109457,
    AUTHOR = {Horowitz, Jonah},
     TITLE = {Computational complexity of various {M}al'cev conditions},
   JOURNAL = {Internat. J. Algebra Comput.},
  FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {23},
      YEAR = {2013},
    NUMBER = {6},
     PAGES = {1521--1531},
      ISSN = {0218-1967},
   MRCLASS = {03C05 (08B05 68Q25)},
  MRNUMBER = {3109457},
MRREVIEWER = {Klaus Denecke},
       DOI = {10.1142/S0218196713500343},
       URL = {http://dx.doi.org/10.1142/S0218196713500343},
}
@ARTICLE{2017arXiv170302764D,
   author = {{DeMeo}, W.},
    title = "{The Commutator as Least Fixed Point of a Closure Operator}",
  journal = {ArXiv e-prints},
archivePrefix = "arXiv",
   eprint = {1703.02764},
 primaryClass = "math.LO",
 keywords = {Mathematics - Logic, Mathematics - Rings and Algebras},
     year = 2017,
    month = mar,
   adsurl = {http://adsabs.harvard.edu/abs/2017arXiv170302764D},
  adsnote = {Provided by the SAO/NASA Astrophysics Data System}
}
@article {MR1871085,
    AUTHOR = {Bergman, Clifford and Slutzki, Giora},
     TITLE = {Computational complexity of some problems involving
              congruences on algebras},
   JOURNAL = {Theoret. Comput. Sci.},
  FJOURNAL = {Theoretical Computer Science},
    VOLUME = {270},
      YEAR = {2002},
    NUMBER = {1-2},
     PAGES = {591--608},
      ISSN = {0304-3975},
     CODEN = {TCSDI},
   MRCLASS = {08A30 (05C85 08A35 68Q17)},
  MRNUMBER = {1871085 (2002i:08002)},
MRREVIEWER = {Radim B{\v{e}}lohl{\'a}vek},
       DOI = {10.1016/S0304-3975(01)00009-3},
       URL = {http://dx.doi.org/10.1016/S0304-3975(01)00009-3},
}
@article {MR1695293,
    AUTHOR = {Bergman, Clifford and Juedes, David and Slutzki, Giora},
     TITLE = {Computational complexity of term-equivalence},
   JOURNAL = {Internat. J. Algebra Comput.},
  FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {9},
      YEAR = {1999},
    NUMBER = {1},
     PAGES = {113--128},
      ISSN = {0218-1967},
   MRCLASS = {68Q17 (08A70 68Q15)},
  MRNUMBER = {1695293 (2000b:68088)},
       DOI = {10.1142/S0218196799000084},
       URL = {http://dx.doi.org/10.1142/S0218196799000084},
}
@article {MR3449235,
    AUTHOR = {Kearnes, Keith and Szendrei, {\'A}gnes and Willard, Ross},
     TITLE = {A finite basis theorem for difference-term varieties with a
              finite residual bound},
   JOURNAL = {Trans. Amer. Math. Soc.},
  FJOURNAL = {Transactions of the American Mathematical Society},
    VOLUME = {368},
      YEAR = {2016},
    NUMBER = {3},
     PAGES = {2115--2143},
      ISSN = {0002-9947},
   MRCLASS = {03C05 (08B05 08B10)},
  MRNUMBER = {3449235},
       DOI = {10.1090/tran/6509},
       URL = {http://dx.doi.org/10.1090/tran/6509},
}
@article {MR1663558,
    AUTHOR = {Kearnes, Keith A. and Szendrei, {\'A}gnes},
     TITLE = {The relationship between two commutators},
   JOURNAL = {Internat. J. Algebra Comput.},
  FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {8},
      YEAR = {1998},
    NUMBER = {4},
     PAGES = {497--531},
      ISSN = {0218-1967},
   MRCLASS = {08A05 (08A30)},
  MRNUMBER = {1663558},
MRREVIEWER = {M. G. Stone},
       DOI = {10.1142/S0218196798000247},
       URL = {http://dx.doi.org/10.1142/S0218196798000247},
}
@article{KSW,
title = {Simpler {M}altsev conditions for (weak) difference terms in locally finite varieties},
author = {Kearnes, Keith and Szendrei, \'{A}gnes and Willard, Ross},
note = {to appear}
}

@article {MR3239624,
    AUTHOR = {Valeriote, M. and Willard, R.},
     TITLE = {Idempotent {$n$}-permutable varieties},
   JOURNAL = {Bull. Lond. Math. Soc.},
  FJOURNAL = {Bulletin of the London Mathematical Society},
    VOLUME = {46},
      YEAR = {2014},
    NUMBER = {4},
     PAGES = {870--880},
      ISSN = {0024-6093},
   MRCLASS = {08A05 (06F99 68Q25)},
  MRNUMBER = {3239624},
       DOI = {10.1112/blms/bdu044},
       URL = {http://dx.doi.org/10.1112/blms/bdu044},
}
@article {MR3350327,
    AUTHOR = {Kozik, Marcin and Krokhin, Andrei and Valeriote, Matt and
              Willard, Ross},
     TITLE = {Characterizations of several {M}altsev conditions},
   JOURNAL = {Algebra Universalis},
  FJOURNAL = {Algebra Universalis},
    VOLUME = {73},
      YEAR = {2015},
    NUMBER = {3-4},
     PAGES = {205--224},
      ISSN = {0002-5240},
   MRCLASS = {08B05 (08A70 08B10)},
  MRNUMBER = {3350327},
MRREVIEWER = {David Hobby},
       DOI = {10.1007/s00012-015-0327-2},
       URL = {http://dx.doi.org/10.1007/s00012-015-0327-2},
}
@article {MR1358491,
    AUTHOR = {Kearnes, Keith A.},
     TITLE = {Varieties with a difference term},
   JOURNAL = {J. Algebra},
  FJOURNAL = {Journal of Algebra},
    VOLUME = {177},
      YEAR = {1995},
    NUMBER = {3},
     PAGES = {926--960},
      ISSN = {0021-8693},
     CODEN = {JALGA4},
   MRCLASS = {08B10 (08B05)},
  MRNUMBER = {1358491},
MRREVIEWER = {H. Peter Gumm},
       DOI = {10.1006/jabr.1995.1334},
       URL = {http://dx.doi.org/10.1006/jabr.1995.1334},
}
@book {MR2839398,
    AUTHOR = {Bergman, Clifford},
     TITLE = {Universal algebra},
    SERIES = {Pure and Applied Mathematics (Boca Raton)},
    VOLUME = {301},
      NOTE = {Fundamentals and selected topics},
 PUBLISHER = {CRC Press, Boca Raton, FL},
      YEAR = {2012},
     PAGES = {xii+308},
      ISBN = {978-1-4398-5129-6},
   MRCLASS = {08-02 (06-02 08A40 08B05 08B10 08B26)},
  MRNUMBER = {2839398 (2012k:08001)},
MRREVIEWER = {Konrad P. Pi{\'o}ro},
}
@article {MR0434928,
    AUTHOR = {Taylor, Walter},
     TITLE = {Varieties obeying homotopy laws},
   JOURNAL = {Canad. J. Math.},
  FJOURNAL = {Canadian Journal of Mathematics. Journal Canadien de
              Math\'ematiques},
    VOLUME = {29},
      YEAR = {1977},
    NUMBER = {3},
     PAGES = {498--527},
      ISSN = {0008-414X},
   MRCLASS = {08A25},
  MRNUMBER = {0434928 (55 \#7891)},
MRREVIEWER = {James B. Nation},
}
@BOOK{HM:1988,
    AUTHOR = {Hobby, David and McKenzie, Ralph},
    TITLE = {The structure of finite algebras},
    SERIES = {Contemporary Mathematics},
    VOLUME = {76},
    PUBLISHER = {American Mathematical Society},
    ADDRESS = {Providence, RI},
    YEAR = {1988},
    PAGES = {xii+203},
    ISBN = {0-8218-5073-3},
    MRCLASS = {08A05 (03C05 08-02 08B05)},
    MRNUMBER = {958685 (89m:08001)},
    MRREVIEWER = {Joel Berman},
    note = {Available from:
      \href{http://math.hawaii.edu/~ralph/Classes/619/HobbyMcKenzie-FiniteAlgebras.pdf}{math.hawaii.edu}}
  }
@article {MR0455543,
    AUTHOR = {Jones, Neil D. and Laaser, William T.},
     TITLE = {Complete problems for deterministic polynomial time},
   JOURNAL = {Theoret. Comput. Sci.},
  FJOURNAL = {Theoretical Computer Science},
    VOLUME = {3},
      YEAR = {1976},
    NUMBER = {1},
     PAGES = {105--117 (1977)},
      ISSN = {0304-3975},
   MRCLASS = {68A20},
  MRNUMBER = {0455543},
MRREVIEWER = {Forbes D. Lewis},
       DOI = {10.1016/0304-3975(76)90068-2},
       URL = {http://dx.doi.org/10.1016/0304-3975(76)90068-2},
}
	
@article{Freese:2009,
    AUTHOR = {Freese, Ralph and Valeriote, Matthew A.},
    TITLE = {On the complexity of some {M}altsev conditions},
    JOURNAL = {Internat. J. Algebra Comput.},
    FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {19},
    YEAR = {2009},
    NUMBER = {1},
    PAGES = {41--77},
    ISSN = {0218-1967},
    MRCLASS = {08B05 (03C05 08B10 68Q25)},
    MRNUMBER = {2494469 (2010a:08008)},
    MRREVIEWER = {Clifford H. Bergman},
    DOI = {10.1142/S0218196709004956},
    URL = {http://dx.doi.org/10.1142/S0218196709004956}
  }

@ARTICLE{KearnesKiss1999,
    AUTHOR = {Kearnes, Keith A. and Kiss, Emil W.},
     TITLE = {Modularity prevents tails},
   JOURNAL = {Proc. Amer. Math. Soc.},
  FJOURNAL = {Proceedings of the American Mathematical Society},
    VOLUME = {127},
      YEAR = {1999},
    NUMBER = {1},
     PAGES = {11--19},
      ISSN = {0002-9939},
     CODEN = {PAMYAR},
   MRCLASS = {08A05 (08A30 08B10)},
  MRNUMBER = {99m:08003},
MRREVIEWER = {Branimir {\v{S}}e{\v{s}}elja},
}
  
  
  
@article {MR3076179,
    AUTHOR = {Kearnes, Keith A. and Kiss, Emil W.},
     TITLE = {The shape of congruence lattices},
   JOURNAL = {Mem. Amer. Math. Soc.},
  FJOURNAL = {Memoirs of the American Mathematical Society},
    VOLUME = {222},
      YEAR = {2013},
    NUMBER = {1046},
     PAGES = {viii+169},
      ISSN = {0065-9266},
      ISBN = {978-0-8218-8323-5},
   MRCLASS = {08B05 (08B10)},
  MRNUMBER = {3076179},
MRREVIEWER = {James B. Nation},
       DOI = {10.1090/S0065-9266-2012-00667-8},
       URL = {http://dx.doi.org/10.1090/S0065-9266-2012-00667-8},
}
@incollection {MR1404955,
    AUTHOR = {Kearnes, Keith A.},
     TITLE = {Idempotent simple algebras},
 BOOKTITLE = {Logic and algebra ({P}ontignano, 1994)},
    SERIES = {Lecture Notes in Pure and Appl. Math.},
    VOLUME = {180},
     PAGES = {529--572},
 PUBLISHER = {Dekker, New York},
      YEAR = {1996},
   MRCLASS = {08B05 (06F25 08A05 08A30)},
  MRNUMBER = {1404955 (97k:08004)},
MRREVIEWER = {E. W. Kiss},
}
@misc{william_demeo_2016_53936,
  author       = {DeMeo, William and Freese, Ralph},
  title        = {AlgebraFiles v1.0.1},
  month        = May,
  year         = 2016,
  doi          = {10.5281/zenodo.53936},
  url          = {http://dx.doi.org/10.5281/zenodo.53936}
}
@article{FreeseMcKenzie2016,
	Author = {Freese, Ralph and McKenzie, Ralph},
	Date-Added = {2016-08-22 19:43:56 +0000},
	Date-Modified = {2016-08-22 19:45:50 +0000},
	Journal = {Algebra Universalis},
	Title = {Mal'tsev families of varieties closed under join or Mal'tsev product},
	Year = {to appear}
}
@article {MR2333368,
    AUTHOR = {Kearnes, Keith A. and Tschantz, Steven T.},
     TITLE = {Automorphism groups of squares and of free algebras},
   JOURNAL = {Internat. J. Algebra Comput.},
  FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {17},
      YEAR = {2007},
    NUMBER = {3},
     PAGES = {461--505},
      ISSN = {0218-1967},
   MRCLASS = {08A35 (08B20 20B25)},
  MRNUMBER = {2333368},
MRREVIEWER = {Giovanni Ferrero},
       DOI = {10.1142/S0218196707003615},
       URL = {http://dx.doi.org/10.1142/S0218196707003615},
}
@article {MR2504025,
    AUTHOR = {Valeriote, Matthew A.},
     TITLE = {A subalgebra intersection property for congruence distributive
              varieties},
   JOURNAL = {Canad. J. Math.},
  FJOURNAL = {Canadian Journal of Mathematics. Journal Canadien de
              Math\'ematiques},
    VOLUME = {61},
      YEAR = {2009},
    NUMBER = {2},
     PAGES = {451--464},
      ISSN = {0008-414X},
     CODEN = {CJMAAB},
   MRCLASS = {08B10 (08A30 08B05)},
  MRNUMBER = {2504025},
MRREVIEWER = {Jarom{\'{\i}}r Duda},
       DOI = {10.4153/CJM-2009-023-2},
       URL = {http://dx.doi.org/10.4153/CJM-2009-023-2},
}
@misc{UACalc,
	Author = {Ralph Freese and Emil Kiss and Matthew Valeriote},
	Date-Added = {2014-11-20 01:52:20 +0000},
	Date-Modified = {2014-11-20 01:52:20 +0000},
	Note = {Available at: {\verb+www.uacalc.org+}},
	Title = {Universal {A}lgebra {C}alculator},
	Year = {2011}
}
@article{Freese2008,
	Author = {Freese, Ralph},
	Date-Added = {2016-08-29 01:31:23 +0000},
	Date-Modified = {2016-08-29 01:32:09 +0000},
	Journal = {Alg. Univ.},
	Pages = {337--343},
	Title = {Computing congruences efficiently},
	Volume = {59},
	Year = {2008}
}	
@article {MR2470585,
    AUTHOR = {Freese, Ralph},
     TITLE = {Computing congruences efficiently},
   JOURNAL = {Algebra Universalis},
  FJOURNAL = {Algebra Universalis},
    VOLUME = {59},
      YEAR = {2008},
    NUMBER = {3-4},
     PAGES = {337--343},
      ISSN = {0002-5240},
   MRCLASS = {08A30 (08A40 68W30 68W40)},
  MRNUMBER = {2470585 (2009j:08003)},
MRREVIEWER = {Clifford H. Bergman},
       DOI = {10.1007/s00012-008-2073-1},
       URL = {http://dx.doi.org/10.1007/s00012-008-2073-1},
}
@incollection {MR1191235,
    AUTHOR = {Szendrei, {\'A}gnes.},
     TITLE = {A survey on strictly simple algebras and minimal varieties},
 BOOKTITLE = {Universal algebra and quasigroup theory ({J}adwisin, 1989)},
    SERIES = {Res. Exp. Math.},
    VOLUME = {19},
     PAGES = {209--239},
 PUBLISHER = {Heldermann, Berlin},
      YEAR = {1992},
   MRCLASS = {08-02 (08A40 08B05)},
  MRNUMBER = {1191235 (93h:08001)},
MRREVIEWER = {Ivan Chajda},
}
@unpublished{Bergman-DeMeo,
    AUTHOR = {Bergman, Clifford and DeMeo, William},
    TITLE = {Universal Algebraic Methods for Constraint Satisfaction Problems:
      with applications to commutative idempotent binars},
    YEAR = {2016},
    NOTE = {unpublished notes; soon to be available online},
    URL = {https://github.com/UniversalAlgebra/algebraic-csp}
}
\end{filecontents*}
%:biblio
%\documentclass[12pt]{amsart}
\documentclass[12pt]{amsart}


%%%%%%% wjd: added these packages vvvvvvvvvvvvvvvvvvvvvvvvv
\usepackage{url,amssymb,enumerate,tikz,scalefnt} 
\usepackage[normalem]{ulem} % for \sout (strikeout)   wjd: could remove this in final draft
\usepackage[colorlinks=true,urlcolor=blue,linkcolor=blue,citecolor=blue]{hyperref}
\usepackage{algorithm2e}

\newcommand{\mysetminus}{\ensuremath{-}}
%% uncomment the next line if we want to revert to the "set" minus notation
%% \renewcommand{\mysetminus}{\ensuremath{\setminus}}

\usepackage[yyyymmdd,hhmmss]{datetime}
\usepackage{background}
\backgroundsetup{
  position=current page.east,
  angle=-90,
  nodeanchor=east,
  vshift=-1cm,
  hshift=8cm,
  opacity=1,
  scale=1,
  contents={\textcolor{gray!80}{WORK IN PROGRESS.  DO NOT DISTRIBUTE. (compiled on \today\ at \currenttime)}}
}
%%%%%%  (end wjd addition of packages)


\usepackage{pdfcomment}
\usepackage{color}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amscd}
%% \usepackage{exers}
\usepackage{inputs/rflatexmacs}
\usepackage{inputs/wjdlatexmacs}

\usepackage[mathcal]{euscript}
\usepackage{comment}

\renewcommand{\th}[2]{#1\mathrel{\theta}#2}
\newcommand{\infixrel}[3]{#2\mathrel{#1}#3}


\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{prop}[theorem]{Proposition}
\newtheorem{conjecture}[theorem]{Conjecture}
\theoremstyle{definition}
\newtheorem{example}[theorem]{Example}
\newtheorem{fact}[theorem]{Fact}
\newtheorem{remark}{Remark}
\newtheorem*{remarks}{Remarks}
\newtheorem*{rem}{Remark}
\newtheorem{prob}{Problem}

% \title[A test for a difference term]{A polynomial time test for a
% difference term in an idempotent variety}
% \author[DeMeo]{William DeMeo}
% \address[William DeMeo]{
% Department of Mathematics\\
% University of Hawaii\\
% Honolulu, Hawaii\\
% 96822 USA}
% \email[William DeMeo]{demeo@math.hawaii.edu}
% \author[Freese]{Ralph Freese}
% \address[Ralph Freese]{
% Department of Mathematics\\
% University of Hawaii\\
% Honolulu, Hawaii\\
% 96822 USA}
% \email[Ralph Freese]{ralph@math.hawaii.edu}


\title[A Test for a Difference Term]{A Polynomial-Time Test for a
Difference Term in an Idempotent Variety}
\author[W.~DeMeo]{William DeMeo}
\email{williamdemeo@gmail.com}
\urladdr{http://williamdemeo.github.io}
\address{University of Colorado\\Mathematics Dept\\Boulder 80309\\USA}

\author[R.~Freese]{Ralph Freese}
\email{ralph@math.hawaii.edu}
\urladdr{http://www.math.hawaii.edu/~ralph/}
\address{University of Hawaii\\Mathematics Dept\\Honolulu 96822\\USA}
\author[M.~Valeriote]{Matthew Valeriote}
\email{matt@math.mcmaster.ca}
\urladdr{http://ms.mcmaster.ca/~matt/}
\address{McMaster University\\Mathematics Dept\\Hamilton L8S 4K1\\
CAN}

\thanks{This research was supported by the National
Science Foundation under Grant No. 1500235}

\date{\today}

\begin{document}

\maketitle 

\begin{abstract}
We consider the following practical question: given a finite 
algebra $\alg{A}$ in a
finite language, can we efficiently decide whether the variety 
generated by $\alg{A}$
has a difference term?  We answer this question (positively) in the 
idempotent case and then describe algorithms for constructing difference 
terms.
\end{abstract}

\section{Introduction}
\label{sec:introduction}

A \defn{difference term} for a variety $\sV$ is a ternary term $d$ in the
language of $\sV$ that satisfies the following:
if $\alg{A} = \<A, \dots \> \in \sV$, then for all $a, b \in A$ we have
\begin{equation}
\label{eq:3}  
d^{\alg{A}}(a,a,b) = b \quad \text{ and } \quad
d^{\alg{A}}(a,b,b) \mathrel{\comm \theta \theta} a,
\end{equation}
where $\theta$ is any congruence %% of $\alg{A}$
containing $(a,b)$
and $[\cdot, \cdot]$ denotes the \defn{commutator}.
%% (see Section~\ref{sec:defin-notat}).
When the relations in (\ref{eq:3}) hold we call $d^{\alg{A}}$
a \defn{difference term operation} for $\alg{A}$.

Difference terms are studied extensively in the general algebra literature.
(See, for example, \cite{MR1358491,MR1663558,MR3076179,KSW,MR3449235}.)
There are many reasons to study difference terms, but
one obvious reason is because if we know that a variety 
has a difference term, this fact allows us to deduce some useful
properties of the algebras inhabiting that variety.
Roughly speaking, having a difference term is slightly stronger than having
a Taylor term and slightly weaker than having a \malcev term.
(Note that if
$\alg{A}$ is an \defn{abelian} algebra, which means 
that $[1_A, 1_A] = 0_A$, then, by
the monotonicity of the commutator,
$[\theta, \theta] = 0_A$ for all $\theta \in \Con \alg{A}$, 
in which case $\textbf{A}$
(\ref{eq:3}) says that $d^{\alg{A}}$ is a \malcev term operation.)

Difference terms also play a role in recent work of Keith Kearnes,
Agnes Szendrei, and Ross Willard.
In~\cite{MR3449235} these authors give a positive answer
J\'onsson's famous question---whether a variety of finite
residual bound must be finitely
axiomatizable---for the
special case in which the variety has a difference
term.\footnote{To say a variety has \emph{finite residual bound} is to say
  there is a finite bound on the size of the subdirectly irreducible
  members of the variety.} 

Computers have become invaluable as a research tool and have helped to
broaden and deepen our understanding of algebraic structures and the
varieties they inhabit.  This is largely due to the efforts
of researchers who, over the last three decades, have found ingenious
ways to coax computers into solving challenging abstract algebraic
decision problems, and to do so very quickly.
To give a couple of examples related to our own work, 
it is proved in~\cite{MR3239624} (respectively,~\cite{Freese:2009})
that deciding whether a variety is congruence-$n$-permutable
(respectively, congruence-modular) is \emph{tractable}.\footnote{To
  say that the decision problem is \emph{tractable} is to say
  that there exists an algorithm for solvng the problem that ``scales
  well'' with respect to increasing input size, by which we mean that
  the number of operations required to reach a correct decision is
  bounded by a polynomial function of the input size.}
The present paper continues this effort by presenting an efficient
algorithm for deciding whether a locally finite idempotent variety has a
difference term.

The question that motivated us to begin this project, and
whose solution is the main subject of this paper, is the following:
\begin{prob}
  \label{prob:1}
  Is there a polynomial-time algorithm to decide for a finite,
  idempotent algebra $\alg{A}$ if $\bbV(\alg{A})$ has a difference term?
\end{prob}
 
The remainder of this introduction uses the language of \emph{tame congruence theory} \tct.  Many of the terms we use are defined and explained
in the next section.  For others, see~\cite{HM:1988}.

Our solution to Problem~\ref{prob:1} exploits the connection 
between difference terms and \tct that was established  
by Keith Kearnes in~\cite{MR1358491}. 
%The following theorem makes this connection precise.

\begin{theorem}[{\protect\cite[Theorem 1.1]{MR1358491}}]
\label{thm:KearnesThm}
The variety $\sV = \bbV(\alg A)$ generated by a 
finite algebra $\alg A$ has a difference  if and only if
it has a Taylor term and, for all finite algebras 
$\alg B \in \sV$,
the minimal sets of every type~\atyp\ prime interval in
$\op{Con}(\alg B)$ have empty tails.
\end{theorem}

%%% NOTATION FOR TCT TYPES
% \newcommand{\otyp}{\textbf{0}}
% \newcommand{\utyp}{\textbf{1}}
% \newcommand{\atyp}{\textbf{2}}
% \newcommand{\btyp}{\textbf{3}}
% \newcommand{\ltyp}{\textbf{4}}
% \newcommand{\styp}{\textbf{5}}
% \newcommand{\ityp}{\textbf{i}}
% \newcommand{\jtyp}{\textbf{j}}


Omitting \tct-type \utyp is polynomial-time decidable by Valeriote's subtype theorem. \wjd{insert reference}
In~\cite{Freese:2009}, the second and third authors solve an 
analogous problem by giving a positive answer to the following:
\begin{prob}
  \label{prob:2}
  Is there a polynomial-time algorithm to decide for a finite,
  idempotent algebra $\alg{A}$ if $\bbV(\alg{A})$ is congruence modular?
\end{prob}

Congruence modularity is characterized by omitting tails and 
\tct-types \utyp and \styp.
Omitting \utyp's and \styp's can be decided by the subtype theorem.
The second and third authors also prove in~\cite{Freese:2009} that
if there is a 
non-empty 
tail in $\bbV(\alg{A})$, then there is a 
non-empty
tail ``near the bottom.''
More precisely, suppose $\alg{A}$ is a finite idempotent algebra, and suppose
$\bbV(\alg{A})$ has non-empty tails but lacks \utyp's and \styp's.
Then a non-empty tail must occur in a 3-generated subalgebra of $\alg{A}^2$.
The authors use this to prove that congruence modularity is polynomial-time decidable.

However, proving lack of tails uses the fact that a variety omitting
\utyp's and \styp's has a congruence lattice that---modulo 
the {\it solvability congruence} (defined below)---is (join) semidistributive.
Now, restricting to just testing whether $\bbV(\alg{A})$ omits 
type-\atyp\ tails is not a problem. So, for example, there is a 
polynomial-time algorithm for testing if
$\bbV(\alg{A})$ omits \utyp's, \styp's, and type-\atyp\ tails.  

Here is a related problem.
\wjd{deleted the related problem; it no longer seems relevant.}

\begin{comment}
\begin{prob}
  \label{prob:3}
  Is there an $\alg{A}$, idempotent and having a Taylor term, 
  no type-\atyp tail in 
  subalgebras of $\alg{A}^k$, for $k < n$, but having a type-\atyp 
  tail in a subalgebra of $\alg{A}^n$. 
\end{prob}
Perhaps we could construct such an algebra using congruence lattice
representation techniques. 
\end{comment}

%% Hobby and McKenzie give some info about the types in a $D_2$
%% embedded in $\Con (\alg{A})$. (See~\cite[Lemma 6.3]{HM:1988}).
%% Exercise 7 of that section considers 4-element
%% algebras whose congruence lattice is the concrete embedding of $D_2$
%% in $\Eq(4)$; the one with coatoms $01|23$, $02|13$, and $0|123$, and with atoms
%% $0|1|23$ and $0|2|13$. By~\cite[Lemma 6.3]{HM:1988}, the middle-top
%% interval must be type 5 (assuming a Taylor term). But all the others can be 5's,
%% or all the others can be 4's, or all the others can be 3's.
%% One might attempt to find an example where they are all 2's, but that not possible
%% since otherwise $0|123$ would be a solvable congruence,
%% which would imply the two atoms would permute.

%% \draftbreak

\section{Background, definitions, and notation}
\label{sec:defin-notat}
Our starting point is the set of lemmas at the beginning of Section 3 of~\cite{Freese:2009}.
We first review some of the basic \ac{tct}
that comes up in the proofs in that paper. (In fact, most of this section 
is lifted directly from~\cite[Section~2]{Freese:2009}.)

The seminal reference for \tct is the book by Hobby and McKenzie
\cite{HM:1988}, according to which,
for each covering $\alpha \prec \beta$ in the congruence lattice of a finite
algebra $\alg{A}$, the local behavior of the $\beta$-classes is captured by the
so-called $(\alpha, \beta)$-traces~\cite[Def.~2.15]{HM:1988}.
Modulo $\alpha$, the induced structure on the traces is limited to one
of five possible types:

\begin{enumerate}[{\bf 1}]
\item  (unary type) an algebra whose basic operations are permutations;
\item  (affine type) a one-dimensional vector space over some finite field;
\item  (boolean type) a 2-element boolean algebra;
\item  (lattice type) a 2-element lattice;
\item  (semilattice type) a 2-element semilattice.
\end{enumerate}

Thus to each covering $\alpha \prec \beta$
corresponds a ``\tct type,'' denoted by $\typ(\alpha, \beta)$,
belonging to the set 
$\{\mathbf{1},\mathbf{2},\mathbf{3},\mathbf{4},\mathbf{5}\}$ 
(see~\cite[Def.~5.1]{HM:1988}).
The set of all \tct types that are realized by covering pairs of congruences of a
finite algebra $\alg{A}$ is denoted by $\typ\{\alg{A}\}$ 
and called the \emph{typeset} of $\alg{A}$.
If $\sK$ is a class of algebras, then $\typ\{\sK\}$ denotes the union of the typesets of all finite algebras in $\sK$.
\tct types are ordered according to the following ``lattice of types:''

\newcommand{\dotsize}{0.8pt}
%% To create nodes of lattices in a uniform and consistent way, we define
\tikzstyle{lat} = [circle,draw,inner sep=\dotsize]
% To scale all diagrams uniformly, change this setting:
\begin{center}
\newcommand{\figscale}{.7}
\begin{tikzpicture}[scale=\figscale]
  \scalefont{.8}
  \node[lat] (1) at (0,0) {};
  \node[lat] (2) at (-1,1.5) {};
  \node[lat] (3) at (0,3) {};
  \node[lat] (4) at (.8,2.1) {};
  \node[lat] (5) at (.8,.9) {};
  \draw (1) node [below] {$1$};
  \draw (2) node [left] {$2$};
  \draw (3) node [above] {$3$};
  \draw (4) node [right] {$4$};
  \draw (5) node [right] {$5$};
  \draw[semithick] 
  (1) -- (2) -- (3) -- (4) -- (5) -- (1);
\end{tikzpicture}
\end{center}
Whether or not $\bbV(\alg{A})$ omits one of the order ideals of the lattice of types can be
determined locally.  This is spelled out for us in the next proposition.
(A \defn{strictly simple} algebra is a simple
algebra with no non-trivial subalgebras.)
%% ; i.e.~no proper subalgebras with
%% more than one element.)


\begin{prop}[{\protect \cite[Proposition~2.1]{Freese:2009}}]
  \label{prop:2.1}
If $\alg A$ is a finite idempotent algebra and 
$\mathbf{i} \in \typ(\bbV(\alg{A}))$ then there
is a finite strictly simple algebra $\bS$ of 
type~$\mathbf{j}$ for 
some $\mathbf{j} \leq \mathbf{i}$ in $\sansH \sansS (\alg{A})$.
The possible cases are
% \begin{enumerate} %[(1)]
\begin{itemize}
\item[$\mid \mathbf{j} = 1$] $\;\Rightarrow \;\bS$ is term equivalent to a 2-element set
\item[$\mid \mathbf{j} = 2$] $\;\Rightarrow \;\bS$ is term equivalent to the idempotent reduct of a module
\item[$\mid \mathbf{j} = 3$] $\;\Rightarrow \;\bS$ is functionally complete
\item[$\mid \mathbf{j} = 4$] $\;\Rightarrow \;\bS$ is polynomially equivalent to a 2-element lattice
\item[$\mid \mathbf{j} = 5$] $\;\Rightarrow \;\bS$ is term equivalent to a 2-element semilattice.
\end{itemize} %enumerate}
\end{prop}
\begin{proof}
  This is a combination of~\cite[Proposition~3.1]{MR2504025} and~\cite[Theorem~6.1]{MR1191235}.
\end{proof}

\begin{comment}
  Table~\ref{tab:1} is from~\cite{MR3350327} and gives another characterization of
omitting types.
\begin{center}
  \begin{table}
    \caption{\cite{MR3350327}.}
    \label{tab:1}
    \begin{tabular}{|l|l|}
      \hline
      Omitting Class &  Equivalent Property\\
      \hline
      $\sM_{\{1\}}$ & satisfies a nontrivial idempotent \malcev condition \\
      \hline
      $\sM_{\{1,5\}}$ & satisfies a nontrivial congruence identity\\ % (see~\cite{MR3076179})\\
      \hline
      $\sM_{\{1,4,5\}}$ & congruence n-permutable, for some $n > 1$ \\
      \hline
      $\sM_{\{1,2\}}$ & congruence meet semidistributive \\
      \hline
      $\sM_{\{1,2,5\}}$ & congruence join semidistributive\\ % (see~\cite{MR3076179})\\
      \hline
      $\sM_{\{1,2,4,5\}}$ & congruence $n$-permutable for some $n$ and\\
      &congruence join semidistributive\\
      \hline
    \end{tabular}
  \end{table}
\end{center}

\end{comment}

We conclude this section with a result that will be useful in Section~\ref{sec:freese-valer-lemm}.
\begin{corollary}[{\protect \cite[Corollary~2.2, Lemma~3.3]{Freese:2009}}]
  \label{cor:2.2}
  Let $\alg{A}$ be a finite idempotent algebra and $T$ an order ideal in the
  lattice of types. Then $\bbV(\alg{A})$ omits $T$ if and only if $\sansS(\alg{A})$ does.
  %% In particular, $\bbV(\alg{A})$ omits 1 and 2 if and only if $\sansS(\alg{A})$ omits 1 and 2.
\end{corollary}



%% \draftsecskip
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% \draftbreak

\section{Prior Work}
\label{sec:freese-valer-lemm}
In~\cite{Freese:2009}, Corollary~\ref{cor:2.2} is the starting point of the
development of a polynomial-time algorithm that determines if a given finite
idempotent algebra generates a \cm variety. 

%% The following lemma ties in with the previous proposition and will be used
%% in Sec. 6.
%% \begin{lemma}[Lemma 2.3~\cite{Freese:2009}] 
%%   Let $\alg{A}$ be a finite idempotent algebra and let $\bS \in \sansH \sansS(\alg{A})$
%%   be strictly simple. Then there are elements $a, b \in A$ such that, if
%%   $\alg{B} = \Sg^{\alg{A}} (a, b)$, then $1_B = \Cg^{\alg{B}} (a, b)$ and is join irreducible
%%   with unique lower cover $\rho$ such that $\bS = \alg{B}/\rho$.
%% \end{lemma}
%% \begin{proof}
%%   Choose $\alg{B} \in \sansS (\alg{A})$ as small as possible having $\bS$ as a homomorphic image,
%%   say $\bS = \alg{B}/\rho$. We claim that if $a, b \in B$ with
%%   $(a, b) \in \notin \rho$ then they generate $\alg{B}$. To
%%   see this, let $\alg{B}'= \Sg^{\alg{B}} (a, b)$ and let $h$ be the quotient map from B to S with kernel
%%   ρ. Then h(B  ) is a non-trivial subuniverse of S and so must equal S. Thus B  = B.
%%   Now let a, b ∈ B with (a, b) ∈
%%   / ρ. Since the block of Cg B (a, b) containing a
%%   and b is a subuniverse of B then from the previous paragraph, we conclude that
%%   Cg B (a, b) = 1 B and that ρ is its unique lower cover.
%% \end{proof}

According to the characterization
in~\cite[Chapter~8]{HM:1988} of locally finite congruence modular (resp.,
distributive) varieties, a finite algebra $\alg{A}$ generates a congruence modular
(resp., distributive) variety $\sV$ if and only if the typeset 
of $\sV$ is
contained in $\{\atyp, \btyp, \ltyp\}$ (resp., $\{\btyp, \ltyp\}$) 
and all minimal sets of prime
quotients of finite algebras in $\sV$ have empty
tails~\cite[Def.~2.15]{HM:1988}. (In the distributive 
case the empty tails condition is equivalent to the minimal sets all having exactly
two elements.)

It follows from Corollary~\ref{cor:2.2} and Proposition~\ref{prop:2.1}
that if $\alg{A}$ is idempotent then one can
test the first condition---omitting 
types \utyp, \styp (resp., \utyp, \atyp, \styp)---by searching
for a 2-generated subalgebra of $\alg{A}$ whose typeset is 
not contained in
$\{\atyp, \btyp, \ltyp\}$ (resp., $\{\btyp, \ltyp\}$). It is proved 
in~\cite[Section~6]{Freese:2009} that this
test can be performed in polynomial-time---that is, the running 
time of the test is bounded by a polynomial function of the size of $\alg{A}$.
The main tools developed to this end are presented 
in~\cite[Section~3]{Freese:2009} as a sequence of
lemmas that enable the authors to prove the following: 
if $\alg{A}$ is finite and idempotent, and if
$\mathcal V = \bbV(\alg{A})$ omits types \utyp and \styp, 
then to test for the existence of non-empty tails
in $\sV$ it suffices to look for them 
in the 3-generated subalgebras of $\alg{A}^2$.
%% More specifically, the authors assume that the type set of $\bbV(\alg{A})$ contains no 1's
%% and no 5's, and under this 
%% assumption they prove that non-empty tails either do not occur in $\bbV(\alg{A})$,
%% or they occur in 3-generated subalgebras of $\alg{A}^2$.
In other words, either there are no non-empty tails
or else there are non-empty tails that are easy to find
(since they occur in a 3-generated subalgebra of $\alg{A}^2$).
It follows that Problem~\ref{prob:2} has a positive answer:
deciding whether or not a finite idempotent algebra generates a congruence
modular variety is tractable.\footnote{That is, there are positive integers
  $C, n$, and an algorithm that takes
  a finite idempotent algebra $\alg{A}$ as input and decides
  in at most $C|\alg{A}|^n$ steps whether $\bbV(\alg{A})$ is congruence modular.
  Here $|\alg{A}|$ denotes the number of bits required to encode the algebra $\alg{A}$.}
%% polynomial-time algorithm to decide, for a finite idempotent algebra $\alg{A}$,
%% whether $\bbV(\alg{A})$ is congruence modular.}

Our goal is to use the same strategy to solve Problem~\ref{prob:1}.
As such, we revisit each of the lemmas in Section 3 of \cite{Freese:2009},
and consider whether an analogous result can be proved under
modified hypotheses.
Specifically, we retain the assumption that the type set of $\bbV(\alg{A})$ 
omits \utyp, but we drop the assumption that it omits \styp.
We will attempt to prove that, under these circumstances,
either there are no type-\atyp tails in $\bbV(\alg{A})$, 
or else type-\atyp tails can be found ``quickly,'' 
(e.g., in a 3-generated subalgebra of $\alg{A}^2$).
Where possible, we will relate our new results to 
analogous results in~\cite{Freese:2009}.

\subsection{Notation}
Throughout we let $\nn$ denote the set $\{0,1,\dots, n-1\}$ and 
we take $\sS$ to be a finite set of finite,
similar, idempotent algebras that is closed under the taking of 
subalgebras, and we assume that the type set of
$\sV = \bbV(\sS)$ omits \utyp (but may include \styp).
If there exists a finite algebra in $\sV$ having a type-\atyp\ minimal 
set with a non-empty tail---in which case we say that 
``$\sV$ has type-\atyp tails''---then, 
by standard results in \tct (see~\cite{HM:1988}),
at least one such algebra appears as a subalgebra of a product of 
elements in $\sS$.
So we suppose that some finite algebra
$\alg{B}$ in $\sV$ has a prime quotient of type~\atyp with 
minimal sets that have 
non-empty tails and show that there is a 3-generated 
subalgebra of the
product of two members of $\sS$ with this property.

Since $\sS$ is closed under the taking of subalgebras,
we may assume that the algebra $\alg{B}$ from the previous paragraph is a subdirect
product of a finite number of members of $\sS$. Choose $n$ minimal such that for
some $\alg{A}_0$, $\alg{A}_1$, $\dots$, $\alg{A}_{n-1}$ in $\sS$, there is a subdirect
product $\alg{B} \sdp \prod_{\nn} \alg{A}_i$
that has a prime quotient of type~\atyp\ whose minimal sets have
non-empty tails.
Under the assumption that $n > 1$ we will prove that $n = 2$.

For this $n$, select the $\alg{A}_i$ and $\alg{B}$ so that $|B|$ is as small as possible.
Let $\alpha \prec \beta$ be a prime quotient of $\alg{B}$ 
of type~\atyp\ whose minimal sets have
non-empty tails, and choose $\beta$ minimal with respect to this property.
By~\cite[Lemma 6.2]{HM:1988}, this implies $\beta$ is join 
irreducible and $\alpha$ is its unique subcover.
Let $U$ be an $\<\alpha, \beta\>$-minimal set. 

%and let $N$ be an
% $(\alpha, \beta)$-trace of $U$. Let 0 and 1 be
%two distinct members of $N$ with $(0, 1) \notin \alpha$.

\begin{lemma}[{\protect cf.~\cite[Lemma~3.1]{Freese:2009}}]
\label{lem:fv_3-1}
If\/ $0$, $1 \in U$, if $(0,1) \in \beta \mysetminus \alpha$, and if
$t$ belongs to the tail of $U$, then $\beta$ is the congruence of $\alg{B}$
generated by the pair $(0,1)$, and $\alg{B}$ is generated by $\{0, 1, t\}$.
\end{lemma}

\begin{proof}
Since $\beta$ is join irreducible with unique subcover $\alpha$, any
pair of elements in $\beta \mysetminus \alpha$ generates $\beta$.
Let $\alg C$ be the subalgebra of $\alg B$ generated by $\{0,1,t\}$. 
We will obtain a contradiction under the assumption that $|C| < |B|$.
%% (wjd: removed the following line since it follows from minimality)
%% and the minimal sets of $\alg C$ which have type~\atyp\ all have empty tails. 

Let $\beta'$ and $\alpha'$ be the restrictions of $\beta$ and $\alpha $ to $C$,
respectively. Then $\alpha' < \beta'$ since $(0,1) \in
\beta'\mysetminus \alpha'$ and so there are $\delta \covs \gamma$ in
$\con{\alg C}$ with $\alpha' \le \delta \cov \gamma \le \beta'$ and
such that $(0,1) \in \gamma\mysetminus \delta$.
Since $(\alpha,\beta)$ is type~\atyp, $\beta$ is abelian over $\alpha$.
This implies $\beta'$ is abelian over $\alpha'$ 
by \cite[Lemma 2.19(9)]{MR3076179},
which implies the
types of the prime quotients occurring between $\alpha'$ and $\beta'$
are~\utyp\ or \atyp.
But since we are assuming $\alg B$ has a Taylor term,
they are all of type~\atyp. 
In particular, $(\delta,\gamma)$ has type~\atyp.

Now, if $|C| < |B|$, then all 
% Suppose that $|C| < |B|$ and all $\langle \delta, \gamma \rangle$
$\langle \delta, \gamma \rangle$-minimal sets have empty tails
(since $\alg{B}$ is minimal among algebras with non-empty 
type-\atyp tails). 
Let $V$ be a $\langle \delta,\gamma \rangle$-minimal set and let 
$p(x)$ be some polynomial of $\alg C$ with range $V$ and with 
$(p(0) ,p(1))\notin \delta$. Such a polynomial exists 
by~\cite[Theorem~2.8]{HM:1988}, 
since $(0,1) \in \gamma\mysetminus \delta$.

The polynomial $p(x)$ can be expressed in the form 
$s^{\alg C}(x,0,1,t)$ for some term $s(x,y,z,w)$ 
of $\mathcal V$, so $p(x)$ extends to a polynomial 
$p'(x) = s^{\alg B}(x,0,1,t)$ of $\alg B$.  Since $(p(0),
p(1)) \in \gamma\mysetminus \delta$, then 
$(p'(0), p'(1)) \in \beta\mysetminus \alpha$, so $p'$ must map the 
minimal set $U$ onto a polynomially isomorphic set $W$. In particular, 
%, since $p'$ is a polynomial isomorphism from $U$ to~$W$.
$\{p'(0), p'(1)\} \subseteq \body (W)$ and $p'(t) \in \tail (W)$.

Since the type of $\langle \delta, \gamma \rangle$ is \atyp\ 
and $V$ has no tail,   
$\alg C|_V$ has a \malcev polynomial. % $s(x,y,z)$. 
This polynomial has an extension to a polynomial of $\alg B$ and, since 
$\{p(0), p(1),p(t)\} \subseteq V$, it follows that there is a polynomial
$f(x,y,z)$ of $\alg B$ that satisfies the \malcev identities when
restricted to the set $\{p'(0), p'(1), p'(t)\} \subseteq W$. This
contradicts~\cite[Lemma~4.26]{HM:1988}, since $p'(0)$ and $p'(1)$
are in the body of $W$ and $p'(t)$ is in the tail.
\end{proof}


For $i \leq n$, let $\rho_i$ denote the kernel of the projection of $\alg{B}$ onto $\alg{A}_i$,
so $\alg{B} \cong \alg{A}_i/\rho_i$.
For a subset $\sigma \subseteq \nn$, define
\[
\rho_\sigma := \bigwedge_{j\in \sigma} \rho_j.
\]
Consequently,
$\rho_{\nn} = \bigwedge_{j\in \nn}\rho_j = 0_{B}$.
%% \marginnote{wjd: I don't see why join in (3.1) is $1_B$... it's probably wrong.}[3cm]
%% \begin{equation}
%%   \label{eq:2}
%%   \rho_{\nn} = \bigwedge_{j\in \nn}\rho_j = 0_{B} \quad \text{ and } \quad
%%   \bigvee_{j\in \nn}\rho_j =1_B. %% \qquad
%% \end{equation}
By minimality of $n$ we know that the intersection of any  proper subset of the
$\rho_i$, $1 \leq i \leq n$ is strictly above $0_B$.  Thus,
$0_B < \rho_\sigma < 1_B$ for all 
$\emptyset \subset \sigma\subset \nn$.
(By $\subset$ we mean \emph{proper} subset.)

\begin{lemma}[{\protect cf.~\cite[Lemma~3.2]{Freese:2009}}]
  \label{lem:fv_3-2}
  For every proper nonempty subset $\sigma$ of $\nn$,
  either $\beta \leq \rho_\sigma$ or $\alpha \join \rho_\sigma = 1_B$.
\end{lemma}
\begin{proof} Let $\rho = \rho_\sigma$.
Suppose that $\beta \not\le {\rho}$ (or equivalently $(0,1) \notin
\rho$). Since $\beta$ is join irreducible, $\beta\meet\rho \le
\alpha$ and so $\beta\meet \rho = \alpha \meet \rho$.  Furthermore,
$\alpha\join {\rho} = \beta \join {\rho}$, or else we can find a
prime quotient between these two congruences that is perspective
with $\langle \alpha, \beta \rangle$.  But then the algebra 
$\alg B/{\rho}$ has a prime quotient of type~\atyp\ whose minimal sets have non-empty
tails.  Since this algebra is isomorphic to a subdirect product of
fewer than $n$ members of $\mathcal S$, we conclude, by the minimality 
of~$n$, that indeed $\alpha\join {\rho} = \beta \join {\rho}$.

Thus the set
\[
\mathcal P = \{\beta\meet\rho, \rho, \alpha, \beta, \alpha\join\rho\}
\]
forms a pentagon in $\Con \alg B$. Let $C$ be the
$(\alpha\join\rho)$-class that contains $0$ and let $M = C\mathrel{\cap} U$.
Note that $C$ contains $1$ and, since $\alg B$ is idempotent,  that
$C$ is a subuniverse of $\alg B$. By Lemma 2.4 of \cite{HM:1988}, we
conclude that the restriction to $M$ is a surjective lattice
homomorphism from the interval $I[0_B,
\alpha\join\rho]$ in $\Con{\alg B}$ to the interval $I[0_M,
(\alpha\join\rho)|_M]$ in $\Con{\alg B}|_M$.  Note that since $(0,1) \in
\beta|_M \mysetminus \alpha|_M$, this restriction map separates
$\alpha$ and $\beta$.  Then, the image under the restriction map of
the pentagon $\mathcal P$ is a pentagon in $\Con{\alg B}|_M$.  This
implies that $M$ contains some elements of the tail of $U$, since
otherwise $\Con{\alg B}|_M$ has a \malcev term operation and hence  
is modular.
Thus, there is some $t$ in the tail of $U$ with $(0,t) \in
\alpha\join \rho$. Using Lemma~\ref{lem:fv_3-1} we conclude that $C =
B$ since it contains $\{0,1,t\}$.  Thus, $\alpha \join \rho = 1_B$.
\end{proof}

\begin{lemma}\label{lem:nearperm}
  For every proper nonempty subset $\sigma$ of $\nn$,
  for all $v\in B$, and for all $b\in \body(U)$, we have
  $(v,b) \in \beta \circ \rho_\sigma \cap \rho_\sigma \circ \beta$.
\end{lemma}

%\smallskip
%% \newcommand\rhosig{\ensuremath{\rho_\sigma}}
\newcommand\rhosig{\ensuremath{\rho}}
\begin{proof}
\noindent Let $\rho = \rho_\sigma$. Note that
$\beta \join \rhosig = 1_B$ implies
$\restr{\beta}{U} \join \restr{\rhosig}{U} = \restr{1_B}{U} = 1_U$, 
since $U = e(B)$, for some idempotent unary polynomial~$e$.
Now, for all $x$, $y \in U$, if $x\in \body(U)$ and $y\in \tail(U)$, then
$(x,y) \notin \beta$.  Therefore,
$(x, y) \in  1_U = \restr{\beta}{U} \join \restr{\rhosig}{U}$ implies
there must be some $b' \in \body(U)$ and $t'\in \tail(U)$ such that 
$b' \mathrel{\rhosig} t'$.  

Now, let $d(x,y,z)$ be a pseudo-\malcev polynomial for $U$,
which exists by~\cite[Lemma~4.20]{HM:1988}.
Thus,
\begin{itemize}
\item $d(B,B,B) = U$
\item $d(x,x,x) = x$ for all $x\in U$
\item $d(x,x,y) = y = d(y,x,x)$ for all $x\in \body(U)$, $y \in U$.
\end{itemize}
Moreover, for all $c$, $d \in \body(U)$, the unary polynomials
$d(x,c,d)$, $d(c,x,d)$, and $d(c,d,x)$ are permutations on $U$.
If we now fix an arbitrary element $b\in \body(U)$ and
let $p(x) = d(x,b',b)$, then (see~\cite[Lemma~4.20]{HM:1988})
\begin{itemize}
\item  $p(U) = U$, since $U$ is minimal,
\item $p(b') = d(b',b',b) = b \in \body(U)$, and
\item  $t:=p(t')\in \tail(U)$, since $t'\in \tail(U)$.
\end{itemize}
Since $(b',t') \in \rhosig$, we have $(b, t) = (p(b'), p(t')) \in \rhosig$. 
Since $b$ is in the body, there is an element $b''$ in the body with
$(b,b'') \in \beta - \alpha$. By Lemma~\ref{lem:fv_3-1}, this implies
$\alg{B} = \Sg^{\alg{B}}(b, b'', t')$.

Finally, if $v \in B$, then $v = s^{\alg{B}}(b,b'',t)$ for 
some (idempotent) term $s$, so
\[
v = s^{\alg{B}}(b,b'',t)
\mathrel{\rhosig} s^{\alg{B}}(b,b'',b)
\mathrel{\beta} s^{\alg{B}}(b,b,b) = b,
\]
and
\[
v = s^{\alg{B}}(b,b'',t)
\mathrel{\beta}  s^{\alg{B}}(b,b,t)
\mathrel{\rhosig}s^{\alg{B}}(b,b, b)  = b.
\]
Therefore, 
$(v,b) \in  \beta \circ \rhosig \cap \rhosig \circ \beta$.
Since $v \in B$ and $b\in \body(U)$ were aribitrary,
this completes the proof.
\end{proof}



\begin{lemma}[{\protect cf.~\cite[Lemma~3.3]{Freese:2009}}]\
  \label{lem:fv_3-3}
  \begin{enumerate}[(i)]
    \item \label{item:6} There exists $i$
      such that $\alpha \join \rho_i = 1_B$
    \item \label{item:7} There exists $i$ such that  
      $\alpha \join \rho_i < 1_B$.
  \end{enumerate}
\end{lemma}
\begin{proof}
  %% {\bf TODO:} fill in proof of  Lemma~\ref{lem:fv_3-3}.
  %%\begin{enumerate}[(i)]
  %%\item %\label{item:6} There exists $0\leq i< n $  such that $\alpha \join \rho_i = 1_B$
If item \eqref{item:6} failed, then we would 
have $\beta \leq \rho_i$ for all $i$, and that
would imply $\beta = 0_B$.
  %%\item %\label{item:7} There exists $i$ such that $\alpha \join \rho_i < 1_B$.
  
To see \eqref{item:7}, assume
\begin{equation} \label{eq:4}
\alpha \join \rho_i = 1_B \; \text{ for all $i$.}
\end{equation}
Take a nonempty proper subset $\sigma \subset \nn$ of indices and let 
$\rho_\sigma = \bigwedge_{j\in \sigma} \rho_j$.
Then $\beta \join \rho_\sigma = 1_B$. (Otherwise,
$\alpha \join \rho_\sigma \leq \beta \join \rho_\sigma < 1_B$,
and it would follow from Lemma~\ref{lem:fv_3-2} that
$\alpha \leq \beta \leq \rho_\sigma \leq \rho_i$ for all $i \in \sigma$, 
but then $\alpha \join \rho_i = \rho_i < 1_B$, contradicting (\ref{eq:4}).)
% Therefore, $\beta \join \rho_\sigma = 1_B$.

%\smallskip


%We conclude from the foregoing that,
%for all nonempty proper subsets $\sigma \subset n$,
%for all $a\in \body(U)$ and all $v\in B$, we have
%$(a, v) \in \beta \circ \rho_\sigma \cap \rho_\sigma \circ \beta$, 
%proving the subclaim.

Let $b \in \body(U)$ and $t \in \tail(U)$, and let $d(x,y,z)$ 
denote the pseudo-\malcev operation introduced in the proof of Lemma~\ref{lem:nearperm}. By
\cite[Lemma~4.25]{HM:1988}, $(b, d(b,t,t)) \notin \beta$.
We will arrive at a contradiction by showing that 
$b = d(b,t,t)$. By Lemma~\ref{lem:nearperm}, 
$(b,t) \in \beta \circ \rho_i$ so
there is an element $a \in B$ satisfying 
$b\mathrel\beta a \mathrel\rho_i t$. By applying the idempotent
polynomial $e$ with $e(U) = U$, we have 
$b\mathrel\beta e(a) \mathrel\rho_i t$, so we may
assume $a \in U$. But this puts $a \in \body(U)$,
since $a\mathrel \beta b$. Therefore, 
\[
d(b,t,t) \mathrel\rho_i d(b,a,a) = b.
\]
Since this hold for every~$i$, $d(b,t,t) = b$.
\end{proof}


%\begin{lemma}[{\protect cf.~\cite[Lem.~3.3]{Freese:2009}}]
%\label{lem:fv_3-3x}
%There is exactly one~$i$ such that $\beta \not\le \rho_i$.
%\end{lemma}
%\begin{proof}
%If $n = 1$ then $\rho_1 = 0$ so the results holds. The lemma
%above shows there must there must be at least one $\rho_i \ge \beta$
%so let $\rho_1 \not\ge \beta$ and $\rho_2 \ge \beta$. If $n = 2$, 
%the result holds. Otherwise let $\rho = \rho_1 \meet \rho_2$ and
%note it is clearly not above $\beta$. Since $\beta$ is 
%join irreducible and $\alpha$ is its unique lower cover,
%$\rho \meet \beta \le \alpha$. But then $\alg B/\rho$ has a type~2
%tail, contradicting the minimality of~$n$. 
%\end{proof}


\begin{theorem}[{\protect cf.~\cite[Theorem 3.4]{Freese:2009}}]\label{thm:fv_3-4}
Let $\sV$ be the variety generated by some finite set $\sS$ of finite,
idempotent algebras that is closed under taking subalgebras. If\/ $\sV$
omits type~\utyp\ and some finite member of $\sV$ has a prime quotient 
of type~\atyp\
whose minimal sets have non-empty tails, then there is some
3-generated algebra $\alg B$ with this property that belongs to $\sS$ or is a subdirect
product of two algebras from $\sS$. 
\end{theorem}
\begin{proof}
Choose $n > 0$, $\alg A_i \in \sS$, for $0 \le i \le n-1$ and $\alg B$
as above. From Lemma \ref{lem:fv_3-1} we know that $\alg B$ is
3-generated. If $n > 1$ then by the previous lemma we can choose $i$
and $j \le n$ with $\beta \le \rho_i$ and $\alpha \join \rho_j =
1_B$. If $n > 2$ then Lemma~\ref{lem:fv_3-2} applies to $\rho = \rho_i
\meet \rho_j$ and so we know that either $\beta \le \rho$ or $\alpha
\join \rho = 1_B$. This yields a contradiction as the former is not
possible, since $\beta \not\le \rho_j$ and the latter can't hold
since both $\alpha$ and $\rho$ are below $\rho_i$.

So, the minimality of $n$ forces $n\le 2$ and the result follows.
\end{proof}

%\textcolor{purple}{This is the third version of our theorem presenting
%our algorithm. Write an intro and explain K-K's idea. Define $\alpha_0$, $\alpha_1$.}

The next theorem essentially gives an algorithm to decide if a finitely
generated, idempotent variety has a difference term, which, in the next
section, we will show is polynomial-time. 

In \cite{KearnesKiss1999}, Kearnes and Kiss show there is a close connection
between $\la \alpha,\beta\ra$-minimal sets, where $\alpha \cov \beta$, 
having tails, and  $\alpha \cov \beta$ being the critical interval of
a pentagon. By \cite[Theorem 2.1]{KearnesKiss1999}, the minimal sets
of a prime critical interval of a pentagon have nonempty tails, provided
the type is not~\utyp. In the other direction, if the 
$\la \alpha,\beta\ra$-minimal sets have tails, then there is a pentagon in
the congruence lattice of a subalgebra of $\alg A^2$ with a prime critical 
interval of the same type. This connection between minimal sets with tails and
pentagons is important for us: we do not have a polynomial time algorithm
for finding an $\la \alpha,\beta\ra$-minimal set.

If $\alg B$ is a subalgebra of $\alg A^2$ and $\theta$ is a congruence
of $\alg A$, let $\thetao \in \con (\alg B)$ be defined by
$(x_0,x_1) \mathrel{\thetao} (y_0,y_1)$ iff 
$x_0 \mathrel{\theta} y_0$. Of course $\theta_1$ is defined similarly.
In case $\theta = 0_{\alg A}$, the least congruence,
we use the notation $\rho_0$ and $\rho_1$ instead of 
$0_0$ and $0_1$. Of course $\rho_0$ and $\rho_1$ are the kernels
of the first and second projections of $\alg B$ onto~$\alg A$.



\begin{theorem}\label{thm:algorithm}
Let $\alg A$ be a finite idempotent algebra and let $\sV$ be the variety 
it generates. Then $\sV$ has a difference term if and only if the
following conditions hold:
\begin{enumerate}
\item $\alg A$ has a Taylor term.
\item There do not exist $a$, $b, c\in A$
satisfying the following, where 
% $\alg B$ is the subalgebra of $\alg A$ generated
% by $a$, $b$ and $c$,  $\beta = \Cga a b B$, and
$\alg B := \Sg^{\alg A}(a, b, c)$ 
and
% $\alg C$ is the subalgebra of $\alg B^2$ generated by 
% $(a,b)$, $(a,c)$, $(b,c)$ and the diagonal of $B$,
$\alg C:=\Sg^{\alg{B}^2}\bigl(\{(a,b), (a,c), (b, c)\} 
                    \cup 0_{\alg B}\bigr)$:
\begin{enumerate}
\item $\beta := \Cga a b B$ is join irreducible with lower cover $\alpha$,
\item $((a,b),(b,b)) \notin (\alpha_0 \meet \alpha_1) \join \Cga {(a,c)} {(b,c)} C$,  and
\item $[\beta,\beta] \le \alpha$.
\end{enumerate}

\item There do not exist $x_0$, $x_1$, $y_0$, $y_1\in A$ satisfying
the following, where 
$\alg B$ is the subalgebra of 
$\alg A \times \alg A$ generated by $0 := (x_0, x_1)$, $1 := (y_0,x_1)$, 
and $t := (x_0,y_1)$: 
% $\rho_0$ is the kernel of the first projection:
\begin{enumerate}
\item $\beta := \Cga01{B}$ is join irreducible with lower cover $\alpha$,
\item $\rho_0 \join \alpha = 1_{\alg B}$, and
\item the type of $\beta$ over  $\alpha$ is~\atyp.
\end{enumerate}
\end{enumerate}
\end{theorem}

\begin{proof}
First assume $\sV$ has a difference term.
Then (1) holds by Theorem~\ref{thm:KearnesThm}.
If (2) fails then there are $a$, $b$ and $c\in A$ such
that the conditions specified in (2) hold. 
Let 
\begin{align*}
\delta &:= (\alpha_0 \meet \alpha_1) \join \Cga {(a,c)} {(b,c)} C, \text{ and }\\
\theta &:= \delta \join \Cga {(a,b)}{(b,b)} C.
\end{align*}
By its definition, $\delta \nleq \alpha_0$,
so by~(2b), $\alpha_0\meet\alpha_1 < \delta < \theta \le \beta_0$.
Since $C$ contains $0_{\alg B}$, the diagonal of $B$, the coordinate
projections are onto, so $\alpha_0 \cov \beta_0$ and this interval 
has type~\atyp. 
From this it follows that $\alpha_0 \join \delta = \beta_0$.
Since $\theta \le \alpha_1$, we have $\alpha_0 \meet \theta = \alpha_0\meet\alpha_1$.
Hence
\[
\{\alpha_0\meet\alpha_1, \delta, \theta, \alpha_0, \beta_0 \}
\]
forms a pentagon.
Since $[\beta_0,\beta_0] \leq \alpha_0$, we have
$[\theta,\theta] \leq \alpha_0\meet\alpha_1 < \delta$,
so there is a congruence $\delta'$ such that 
$\delta\leq \delta' \cov \theta$ and this covering has
type~\atyp.
As mentioned in the discussion above, this implies the
$\la \delta',\theta\ra$-minimal sets have tails, contradicting
Theorem~\ref{thm:KearnesThm}.

Now suppose that (3) fails. Then the conditions imply
\[
\{0_{\alg B}, \alpha, \beta, \rho_0, 1_{\alg B} \}
\]
is a pentagon whose critical prime interval has tppe~\atyp. This 
leads to a contradiction in the same manner as above.

For the converse assume that $\sV$ does not have a difference 
term. 
We want to show that (1), (2) or (3) fails. Assume all three hold.
By Theorem~\ref{thm:KearnesThm} there is a finite 
algebra $\alg B \in \sV$ and a join irreducible 
$\beta \in \op{Con}(\alg B)$ with lower cover 
$\alpha$ such that the type of $\beta$ over $\alpha$ is~\atyp\
and the $\la\alpha,\beta\ra$-minimal sets have
nonempty tails. Let $U$ be one of these minimal sets.


We may assume $\alg B$ is minimal in the same manner as with the
above lemmas (with $\sS$ being the subalgebras of $\alg A$).
By Lemma~\ref{lem:fv_3-1} 
we have that $\alg B$ is generated by any $0$, $1$, and $t$ in
$U$ such
that $\beta = \Cga 01{B}$ and $t$ is in the tail. By 
Theorem~\ref{thm:fv_3-4}, $\alg B$ is either 
in $\sS$ or is a subdirect product of two members of $\sS$.

Assume $\alg B$ is a subalgebra of $\alg A$. Taking 
$a=0$, $b=1$ and $c=t$, we claim the conditions specified
in (2) hold. 
Since the type of $\beta$ over $\alpha$ is \atyp,
(2c) holds and we already have (2a) holds. 
(2b) holds by~\cite[Theorem~2.4]{KearnesKiss1999}.
So this choice of $a$, $b$, and $c$ witness that (2) fails.




Now assume $\alg B$ is not in $\sS$ but is a subdirect 
product of two members of $\sS$.
Then
by Lemma~\ref{lem:fv_3-3} we may 
assume $\rho_0 \join \alpha = 1_{\alg B}$ and
$\rho_1 \join \alpha < 1_{\alg B}$. By Lemma~\ref{lem:fv_3-2}
we have $\rho_1 \ge \beta$.
This implies that $0$ and $1$ have the same second coordinate; that is,
$0 = (x_0,x_1)$ and $1 = (y_0,x_1)$ for some $x_0$, $y_0$ and $x_1\in A$.
By Lemma~\ref{lem:nearperm}, $(0,t) \in \rho_0 \circ \beta$
so $0 \mathrel {\rho_0} t' \mathrel{\beta} t$. Let $U = e(B)$
where $e$ is an idempotent polynomial. Then
$0 \mathrel {\rho_0} e(t') \mathrel{\beta} t$. This gives
that $e(t')$ is in the tail of $U$ and 
$0 \mathrel{\rho_0} e(t')$. We can
replace $t$ by $e(t')$, and so assume that 
$0 \mathrel{\rho_0} t$.
Since $0 = (x_0,x_1)$, $t = (x_0,y_1)$ for some $y_1\in A$. 
Now
$x_0$, $y_0$, $x_1$ and $y_1$ witness that (3) fails.
\end{proof}



\section{The Algorithm and its Time Complexity}

If $\alg A$ is an algebra with underlying set (or universe) $A$,
we let $|\alg A| = |A|$ be the cardinality of
$A$ and $||\alg A||$ be the \emph{input size}; that is,
\[
||\alg A|| = \sum_{i=0}^r k_i n^i
\]
where, $k_i$ is the number of basic operations of arity~$i$ and $r$
is the largest arity. We let
\begin{align*}
n &= |\alg A|  \qquad m = ||\alg A|| \\
r &= \text{the largest arity of the operations of $\alg A$}
\end{align*}

Throughout this section we let $c$ denote a constant independent of
these parameters.

\begin{prop}\label{speedprop}
Let $\alg A$ be a finite algebra with the parameters above.
\begin{enumerate}
\item If $S$ is a subset of $A$, then $\Sg^{\alg A}(S)$ can be computed
in time
\[
c\, r\,||\Sg^{\alg A}(S)|| \le c\, r\,||\alg A|| = crm
\]
\item If $a$, $b \in A$, then $\Cga a b A$ can be computed in
$c\, r\, ||\alg A|| = crm$ time.
\item
If $\alpha$ and $\beta$ are congruences of $\alg A$,
then $[\alpha,\beta]$ can be computed in time $crm^2$.
\end{enumerate}
\end{prop}

\begin{proof}
For the first two parts see~\cite[Proposition~6.1]{Freese:2009}. 
For the third part we use that
\begin{align*}
[\alpha, \beta]
  &= \bigcup_{a\in A} (a,a)/\Delta_{\beta,\alpha}  \\
  &= \bigl\{(x,y) \in A\times A : (\exists a \in A) \, 
  (a,a) \mathrel{\Delta_{\beta,\alpha}} (x,y)\bigr\}
\end{align*}
where $\Delta_{\beta,\alpha}$ is the congruence on the
subalgebra of $\alg A^2$ with universe $\beta$ 
generated by the pairs $((u,u), (v,v))$ with $(u,v) \in \alpha$.
By (2), $\Delta_{\beta,\alpha}$ can be calculated in time
$crm^2$. Using the displayed formula above, it is easy to see
that~(3) holds.
\end{proof}

\begin{theorem}\label{thm:time}
Let $\alg A$ be a finite idempotent algebra with parameters as
above. 
Then one can determine if $\bbV(\alg A)$ has a difference
term in time $crn^4m^4$.
\end{theorem}

\begin{proof}
Theorem~\ref{thm:algorithm} gives a three-step 
algorithm to test
if $\bbV (\alg A)$ has a difference term.
The first step is to test if $\alg A$ has a Taylor
term. This can be done in time $crn^3m$ 
by~\cite[Theorem~6.3]{Freese:2009}.

Looking now at part (3) of Theorem~\ref{thm:algorithm},
there are several things that have to be constructed.
By Proposition~\ref{speedprop}, all
of things can be constructed in time $crm^2$ and 
parts~(a) and~(b) can be executed in this time or less.
For part~(c) we need to test if the type of $\beta$
over $\alpha$ is \atyp. Since at this point in the
algorithm we know that $\alg A$ has a Taylor term,
we can test if the type is \atyp\ by testing if
$[\beta,\beta] \le \alpha$. By Proposition~\ref{speedprop}
this can be done in time $crm^4$. Since we need to do
this for all $x_0$, $x_1$, $y_0$ and $y_1$, the total
time for this step is at most $crn^4m^4$. 

A similar analysis applies to part~(2) and shows that it
can be done in time $crn^3m^2$. Since $crn^4m^4$ dominates
the other terms, the bound of the theorem holds.
\end{proof}



%%%%%%%%%%%%%%%%%%%%%%%%%%%% wjd: NEW SECTION  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Difference Term Operations}
Above we addressed the problem of deciding the existence of a difference term 
for a given (idempotent, locally finite) variety.  In this section we are 
concerned with the practical problem of finding a difference term 
\emph{operation} for a given (finite, idempotent) algebra.
We describe algorithms for
\begin{enumerate}
\item \label{item:a} deciding whether a given finite idempotent algebra 
has a difference term operation, and 
\item \label{item:b} finding a difference term operation 
for a given finite idempotent algebra.
\end{enumerate}
Note that Theorem~\ref{thm:time} gives a polynomial-time algorithm
for deciding whether or not the variety $\bbV(\alg A)$ generated by a 
finite idempotent algebra $\alg A$ has a difference term.
If we run that algorithm on input $\alg A$, and if the observed
output is ``Yes'', then of course we have a positive answer to decision 
problem~(\ref{item:a}).  However, a negative answer returned by the 
algorithm only tells us that $\bbV(\alg A)$ has no difference term.  
It does not tell us whether or not $\alg A$ has a difference term operation.

\medskip

\wjd{insert example: $\alg A$ has a diff term op, but
  $\bbV(\alg A)$ has no diff term.}

\medskip

In this section we present solutions to problems~(\ref{item:a}) and~(\ref{item:b})
using methods that are entirely different to the ones used in the previous
sections. 
(For example, we make no use of tame congruence theory.)  
In Subsection~\ref{sec:algor-1} we give a polynomial-time algorithm
for deciding whether a given algebra $\alg A$ has a difference term operation.
In Subsection~\ref{sec:comp-diff-term} we address problem~(\ref{item:b})
by presenting an algorithm for constructing a difference term operation.  
However, this algorithms does not run in polynomial-time and, at the time 
of this writing, we do not know of a more efficient algorithm for constructing a difference term operation, even when such an operation is known to exist. 
Also, we have not yet proved the existence of a tractible algorithm for constructing difference term operations.

\subsection{Local Difference Terms}
\label{sec:local-diff-terms}
In~\cite{MR3239624},
Ross Willard and the third author define %% an \defin{$\bA$-triple for $\bp$}
%% to be a triple $(a,b,i)$ such that $a, b \in A$ and
%% $p_i(a,b,b) = p_{i+1}(a,a,b)$. They use this to define
a ``local Hagemann-Mitschke sequence'' which they use as the basis of
an efficient algorithm for deciding for a given $n$ whether an idempotent
variety is $n$-permutable.
In~\cite{MR3109457}, Jonah Horowitz introduced similar 
``local-to-global'' methods for deciding when a given variety satisfies 
certain \malcev conditions.
Inspired by these works, we now define a ``local difference term 
operation'' and use it to develop a polynomial-time algorithm for deciding
the existence of a difference term operation.

Start with a finite idempotent algebra, $\alg A =\< A, \dots\>$.
For elements $a, b, a_j, b_j \in A$, the following are some shorthands
we will use to denote the congruences generated by these elements:
\[
\thetaab:= \Cg^{\alg{A}}(a, b) \qquad
\thetai:= \Cg^{\alg{A}}(a_i, b_i).
\]
Let $i \in \{0,1\}$.
By a \defin{local difference term operation for $(a,b,i)$} 
we mean a ternary term operation $d$ satisfying the following conditions:
\begin{align}
\text{ if $i=0$, then } & a \comr{\thetaab} d(a,b,b); \label{eq:diff-triple}\\
\text{ if $i=1$, then } & d(a,a,b) = b. \nonumber
\end{align}
If $d$ satisfies~(\ref{eq:diff-triple}) for all triples
in some subset $S\subseteq A^2 \times \{0,1\}$, then we call $d$
a \defin{local difference term operation for $S$}.
Throughout the remainder of the paper, we will 
write ``\ld term'' as shorthand for
``local difference term operation.''

A few more notational conventions will come in handy below.
Given a set $S \subseteq A^2\times \{0,1\}$,
and a set $T \subseteq \Clo_3(\alg{A})$ of ternary term operations 
on $\alg{A}$, we denote by $\ltimes$ the relation from $T$ to $S$ defined 
as follows: $t \ltimes (a,b,i)$ iff the following conditions hold:
%% \begin{align*}
%%   t \ltimes (a,b,i) \; \text{ iff } \;
%%      & \text{ the following:}\\
%%      & \text{ if $i=0$, then } a \comr{\theta_{ab}} t(a,b,b), \text{ and } \\
%%      & \text{ if $i=1$, then } \; t(a,a,b)  = b. 
%% \end{align*}
\begin{align*}
(\star) \quad \begin{cases}
\quad a \comr{\thetaab} t(a,b,b), &    \text{ if $i=0$,}  \\ 
\quad t(a,a,b)  = b, & \text{ if $i=1$.}
\end{cases}
\end{align*}
Occasionally, the notation $(a,b,i)\rtimes t$ will serve as a convenient alternative to $t\ltimes (a,b,i)$.

As a binary relation, $\ltimes$ induces an obvious Galois connection
from subsets of $A^2\times \{0,1\}$ to subsets of $\Clo_3(\alg{A})$ and
back. Specifically, we can define
%% $(\Fix, \Inv)$---namely,
\begin{align*}
^{\rtimes} &\colon \sP(A^2 \times \{0,1\}) \mapsto \sP(\Clo_3(\alg{A})) \text{ and }\\
^{\ltimes} &\colon \sP(\Clo_3(\alg{A})) \mapsto \sP(A^2\times \{0,1\})
\end{align*}
as follows:
for $S \subseteq A^2 \times \{0,1\}$ and $T \subseteq \Clo_3(\alg{A})$,
\begin{align*}
  S^{\rtimes} &= \{t \in \Clo_3(\alg{A}) \mid s \rtimes t
  \text{ for all } s \in S\}, \\
  T^{\ltimes} &= \{s \in A^2 \times \{0,1\} \mid t \ltimes s
  \text{ for all } t \in T\}.
\end{align*}
In other words, $S^\rtimes$ is the set of \ld terms
for $S$, and $T^\ltimes$ is the set of triples for which every $t\in T$ 
is an \ld term.  

Sometimes $S$ will be a finite list, say, 
$S = ((a_0, b_0, \chi_0), \dots, (a_n, b_n, \chi_n))$, in which case 
we write $\Inv((a_0, b_0, \chi_0), \dots, (a_n, b_n, \chi_n))$ to 
denote the set of \ld terms for $S$.

Now, suppose that every pair
$(s_0, s_1)\in (\AsqBool)^2$ %$\AsqBool$ 
has an \ld term.  
Then every subset $S\subseteq \AsqBool$
has an \ld term, as we now prove.

\begin{theorem} %[\protect{cf.~\cite[Theorem 2.2]{MR3239624}}]
  \label{thm:local-diff-terms}
  Let $\sV$ be an idempotent variety and let
  $\alg A  \in \sV$. %% . Define
  %% $\sS= A \times A \times \{0,1\}$
  If every pair
  $(s_0, s_1) \in (A^2 \times \{0,1\})^2$
  has a local difference term operation, then
  every subset $S \subseteq \AsqBool$
  has a local difference term operation.
\end{theorem}


\begin{proof}

The proof is by induction on the size of $S$.  In the base case, $|S| = 2$,
the claim holds by assumption. Fix $n\geq 2$ and assume that every subset of
$\AsqBool$ of size $k \leq n$ has an \ld term. Let
\[
S := \{(a_0, b_0, \chi_0), (a_1, b_1, \chi_1), \dots, 
        (a_{n}, b_{n},\chi_{n})\} \subseteq \AsqBool,
\]
so that $|S| = n+1$.  We prove $S$ has an \ld term.

Since $|S| \geq 3$, % and $\chi_i \in \{0,1\}$ for all $i$, 
there exist indices $i\neq j$ such that $\chi_i = \chi_j$. 
Assume without loss of generality that one such index is $j=n$,
and define the set
\[
S' := S \mysetminus \{(a_n, b_n, \chi_n)\}.
\]
Since $|S'| < |S|$, there exists $p \in \Inv(S')$.
We split the remainder of the proof into two cases.

\medskip

%--------------------------------------
\noindent \underline{Case $\chi_n = 0$}:
Without loss of generality, assume
\begin{equation*}
  \chi_0 = %% \chi_2 =
\cdots =\chi_{k-1} = 1 \quad \text{and} \quad
\chi_{k} = \cdots = \chi_{n} = 0.
\end{equation*} 
If we define %% $T$ to be the set
\[S_0 := \{(a_0, b_0, 1), (a_1, b_1, 1),
\dots, (a_{k-1}, b_{k-1}, 1), (a_n, p(a_n, b_n, b_n), 0)\},\] 
then $|S_0| < |S|$, so there exists $q \in \Inv(S_0)$.
We now show that 
\[
d(x,y,z) := q(x, p(x,y,y), p(x,y,z))
\]
is a local difference term operation for $S$.

Since $\chi_n =0$, we must first check that
$a_n \comr{\thetan} d(a_n,b_n,b_n)$.
If $\gamman := \Cg(a_n, p(a_n,b_n,b_n))$, then
\begin{equation}
    \label{eq:100000}
  d(a_n,b_n,b_n) =
  q(a_n, p(a_n,b_n,b_n), p(a_n,b_n,b_n))\comr{\gamman} a_n.
\end{equation}
The pair $(a_n, p(a_n,b_n,b_n))$ is equal to
$(p(a_n,a_n,a_n), p(a_n,b_n,b_n))$ and so 
belongs to $\theta_n:= \Cg^{\alg{A}}(a_n, b_n)$.
Therefore, $\gamman\leq \thetan$, so
$\com{\gamman} \leq \com{\thetan}$,
by monotonicity of the commutator.
It follows from this and (\ref{eq:100000}) that
$a_n \comr{\thetan} d(a_n,b_n,b_n)$, as desired.

For indices $i < k$, we have $\chi_i =1$, so want to prove
$d(a_i,a_i,b_i) = b_i$ for such $i$. Observe,
\[
  d(a_i,a_i,b_i) =
  q(a_i, p(a_i,a_i,a_i), p(a_i,a_i,b_i)) % \label{eq:200000}\\
  =q(a_i, a_i, b_i) % \label{eq:200001}\\
  =b_i. % \label{eq:200002}
\]
The first equation holds by definition of $d$, the second
because $p$ is an idempotent \ld term for
$S'$, and the third because $q \in \Inv(S_0)$.

The remaining triples in our original set $S$
have indices satisfying $k\leq j < n$ and $\chi_j = 0$.
For these we want
$a_j \comr{\thetaj} d(a_j,b_j,b_j)$.
By definition,
\begin{equation}
  \label{eq:450000}
d(a_j,b_j,b_j) =q(a_j, p(a_j,b_j,b_j), p(a_j,b_j,b_j)).
\end{equation}
Since $p \in \Inv(S')$, we have
%% the pair $(p(a_j,b_j,b_j), a_j)$ belongs to $\com{\thetaj}$.
$a_j \comr{\thetaj} p(a_j,b_j,b_j)$, 
so (\ref{eq:450000}) implies that
$a_j = q(a_j,a_j,a_j) \comr{\thetaj} d(a_j, b_j,b_j)$.

%% Finally, by idempotence of $q$ we have
%% $d(a_j,b_j,b_j)\comr{\thetaj} a_j$,
%% as desired.

\medskip
%--------------------------------------
\noindent \underline{Case $\chi_n = 1$}:
Without loss of generality, suppose 
\begin{equation*}
  \chi_0 =\cdots =\chi_{k-1} = 0 
  \quad \text{and} \quad
\chi_{k} = \cdots = \chi_{n} = 1.
\end{equation*}
If 
\begin{equation*}
S_1 := \{(a_0, b_0, 0), (a_1, b_1 0), \dots, (a_{k-1}, b_{k-1}, 0), 
        (p(a_n, a_n, b_n), b_n, 1)\},
\end{equation*}
then $|S_1| < |S|$, so there exists $q \in \Inv(S_1)$. We claim  that
$d(x,y,z) := q(p(x,y,z), p(y,y,z), z)$ is a local difference term
operation for $S$.
Since $\chi_n =1$, we first show
$d(a_n,a_n,b_n) = b_n$. By the definition of $d$,
\begin{equation*}  
  d(a_n,a_n,b_n) =
  q(p(a_n,a_n,b_n), p(a_n,a_n,b_n), b_n) =b_n.
\end{equation*}
The last equality holds since $q \in \Inv(S_1)\subseteq \Inv(p(a_n, a_n, b_n), b_n, 1)$.

If $1\leq i \leq k$, then $\chi_i =0$. For these indices we must prove
that $a_i$ is congruent to $d(a_i,b_i,b_i)$ modulo $\com{\thetai}$.
Again, starting from the definition of $d$ and using idempotence of $p$, we have
\begin{equation}
  \label{eq:40000}
  d(a_i,b_i,b_i) =
  q(p(a_i,b_i,b_i), p(b_i,b_i,b_i), b_i)=
  q(p(a_i,b_i,b_i), b_i, b_i).
\end{equation}
Next, since $p \in \Inv(S')$,
\begin{equation}
  \label{eq:50000}
  q(p(a_i,b_i,b_i), b_i, b_i)
 \comr{\thetai}
 q(a_i, b_i, b_i).
\end{equation}
Since $q \in \Inv(S_1)$, we have
$q(a_i, b_i, b_i) \comr{\thetai} a_i$, so 
(\ref{eq:40000}) and (\ref{eq:50000}) imply
$d(a_i,b_i,b_i) \comr{\thetai} a_i$, as desired.

The remaining elements of $S$
have indices satisfying $k\leq j < n$ and $\chi_j = 1$.
For these we want $d(a_j,a_j,b_j) = b_j$.
Since $p \in \Inv(S')$, we have
$p(a_j,a_j,b_j) = b_j$. This plus idempotence of $q$ yields
\begin{equation*}
 d(a_j,a_j,b_j) =  q(p(a_j,a_j,b_j), p(a_j,a_j,b_j), b_j)=  q(b_j, b_j, b_j) =b_j.
\end{equation*}
\end{proof}

\begin{corollary}
  \label{cor:loc-diff-term}
  Let $\alg A$ be a finite idempotent algebra and suppose that 
  every pair $(s, s') \in (\AsqBool)^2$ has a local difference term operation.
  Then $\Inv (\AsqBool) \neq \emptyset$,
  and $\alg{A}$ has a difference term operation.
\end{corollary}
\begin{proof}
  Letting $S := \AsqBool$ in Theorem~\ref{thm:local-diff-terms} establishes
  the existence of a term operation $d \in \Inv(S)$. Thus, for every pair 
  $a, b \in A$ we have $a \comr{\thetaab} d(a,b,b)$, since $d 
  \in \Inv((a,b,0))$, and we have $d(a,a,b) = b$, since $d\in \Inv((a,b,1))$.
\end{proof}
% 
% \begin{corollary}
%   
%   A finite idempotent algebra $\alg A $ has a difference term operation if and
%   only if each pair in $(A^2 \times \{0,1\})^2$ 
%   has a local difference term.
% \end{corollary}
% \begin{proof}
%   A difference term operation for $\alg A $ is clearly an \ld term for every pair in 
%   $(A^2 \times \{0,1\})^2$, so one direction of the corollary is obvious.
%   For the converse, suppose
%   each pair in $(A^2 \times \{0,1\})^2$ has an \ld term. 
%   Then, by Theorem~\ref{thm:local-diff-terms},
%   there is a single \ld term for the whole set $A^2 \times \{0,1\}$,
%   and this is a difference term operation for $\alg A $.
% \end{proof}

% \draftsecskip

\subsection{Algorithm to test for existence of a difference term}
\label{sec:algor-1}
%% In this subsection we prove the following:
%% \subsection*{Algorithm 1: existence of a difference term operation}
Here is the practical consequence of Theorem~\ref{thm:local-diff-terms}.
\begin{corollary}
  \label{cor:algor-1}
  There is a polynomial-time algorithm that takes as input
  any finite idempotent algebra $\alg A $ and decides whether
  %% the variety $\bbV(\alg A )$ that it generates
  $\alg A $ has a difference term operation.
\end{corollary}
\begin{proof}
  %% and let  $\sV = \bbV(\alg A )$.
  We describe an efficient algorithm for deciding,
  given a finite idempotent algebra $\alg A $,
  whether every pair in $(A^2 \times \{0,1\})^2$ 
  has an \ld term.  By Corollary~\ref{cor:loc-diff-term}, this will prove we
  can decide in polynomial-time whether $\alg A $ has an difference term operation.
  %% We will then complete the
  %% proof by explaining why $\alg A $ has a difference term operation iff the variety
  %% it generates has a difference term.

  Fix a pair
  $((a,b,i), (a',b',i'))$ in $(A^2 \times \{0,1\})^2$. If $i = i' = 0$,
  then the first projection is an \ld term. If $i = i' = 1$,
  then the third projection is an \ld term. The two remaining cases
  occur when $i\neq i'$. Without loss of generality, assume $i = 0$ and $i'=1$, so the given pair of triples are of the form $((a,b,0), (a',b',1))$.  
  By definition, $t \in \Inv((a,b,0), (a',b',1))$ iff
  \[
  a\comr{\thetaab} t^{\alg A }(a,b,b) \; \text{ and } \;
  t^{\alg A }(a',a',b') = b'.
  \]
  We can rewrite this condition more compactly by considering
  \[t^{\alg{A} \times \alg{A} }((a,a'), (b,a'), (b,b')) =
  (t^{\alg A }(a,b,b),t^{\alg A }(a',a',b')).\]
  Clearly
  $t \in \Inv((a,b,0), (a',b',1))$ iff
  \[
  t^{\alg A \times \alg A }((a,a'), (b,a'), (b,b'))\in a/\delta \times \{b'\},
  \]
  where $\delta = \com{\thetaab}$ and $a/\delta$ denotes the
  $\delta$-class containing $a$.
  It follows that $\Inv((a,b,0), (a',b',1)) \neq \emptyset$ 
  %has an \ld term 
  iff the subuniverse of $\alg A \times \alg A $ generated by
  $\{(a,a'), (b,a'), (b,b')\}$ intersects nontrivially with the subuniverse
  $a/\delta \times \{b'\}$.

  Thus, we take as input a finite idempotent algebra $\alg A $ and, 
  for each element $((a,a'), (b,a'), (b,b'))$ of $(A\times A)^3$,
  \begin{enumerate}
    \item compute $\delta = \com{\thetaab}$, 
    \item compute $\bS = \Sg^{\alg A \times \alg A }\{(a,a'), (b,a'), (b,b')\}$,
    \item \label{item:a3} test whether $S \cap (a/\delta \times \{b'\})$ is empty.
  \end{enumerate}
  If ever we find an empty intersection in step (\ref{item:a3}), then
  $\alg A $ has no difference term operation.
  Otherwise the algorithm halts without witnessing an empty
  intersection, in which case $\alg A $ has a difference term operation.

  Most of the operations carried out by this algorithm are well known to be
  polynomial-time.  For example, the fact that the running time of 
  subalgebra generation is polynomial has been known for a long time (see~\cite{MR0455543}).
  The time complexity of congruence generation is also known to be polynomial
  (see~\cite{MR2470585}).  The only operation whose tractability might be
  called into question is the commutator, but there is a straight-forward polynomial-time algorithm for computing it (see \cite{2017arXiv170302764D}).
\end{proof}


More details on the complexity of operations carried out by the algorithm, and
many other algebraic operations, can be found in the references mentioned in the
preceding paragraph, but see also~\cite{MR1871085,MR1695293,Freese:2009}.
It is also worth remarking that the algorithm above is ``embarrassingly parallel''
since each pair of triples can be tested in isolation, on a single thread,
without communicating with processes testing other triples.

\subsection{Computing a difference term operation}
\label{sec:comp-diff-term}
Let $\alg{A} = \<A, \dots\>$ be a finite idempotent algebra and suppose we 
know that a difference term operation for $\alg{A}$ exists.  In this section we
describe an algorithm for constructing a difference term operation
(given that we know such an operation exists).\wjd{Does the alg ever use the fact that an \ld term exists?} 

We build up the algorithm in stages. Section~\ref{sec:size2}
gives a procedure (Algorithm~\ref{alg:ld-2}) for finding an \ld term for sets 
of size 2, and Section~\ref{sec:induct} gives two inductive steps 
(Algorithms~\ref{alg:stream-ldt1} and~\ref{alg:stream-ldt2}) 
for producing \ld terms on successively larger subsets of $A^2 \times \{0,1\}$.
% Our main recursive algorithm for constructing a difference term 
% operation for $\alg A$ appears in Subsection~\ref{sec:algor-2}.

\subsubsection{Base case}
\label{sec:size2}
An \ld term for
$((a_0,b_0,0), (a_1, b_1, 0))$ is the first projection,
$t(x,y,z) = x$.
An \ld term for
the set $((a_0,b_0,1), (a_1, b_1, 1))$ is the third projection,
$t(x,y,z) = z$.
\begin{comment}
\footnote{Moreover, if $a_0 = b_0$, then by idempotence every ternary term $t$ 
satisfies $t(a_0, b_0, b_0) = a_0$; therefore, the third projection is an \ld 
term for the set $((a_0,b_0,\chi_0), (a_1, b_1, \chi_1))$, 
for all $\chi_0$, $\chi_1$ in $\{0,1\}$. 
Similarly, if $a_1 = b_1$, then $t(a_1, a_1, b_1) = b_1$ for all ternary $t$, 
so the third projection is an \ld term.
Therefore, we need only consider sets of the form
$((a_0,b_0, 0), (a_1, b_1, 1))$, where $a_0 \neq b_0$ and $a_1 \neq b_1$.  
We have relegated this observation to a footnote because it yields a
computational that does not impact the overall complexity of the main
algorithm.} 
\end{comment}

The remaining sets of size 2 have the form
$((a_0,b_0,0), (a_1, b_1, 1))$, and 
an \ld term for such sets can be computed by
Algorithm~\ref{alg:ld-2}, as described in the box.
% (In the following algorithm descriptions,
% we continue to use the shorthand notations established above, 
% such as $\thetaj := \Cg^{\alg{A}}(a_j, b_j)$.)

% \RestyleAlgo{boxed}
\RestyleAlgo{boxruled}
\LinesNumbered
\begin{algorithm}%[ht]
  \SetKwInOut{Input}{Input}
  \SetKwInOut{Output}{Output}

  \caption{Return an \ld term for $((a_0,b_0,0), (a_1, b_1, 1))$ \label{alg:ld-2}  }
  \Input{$S = ((a_0,b_0,0), (a_1, b_1, 1))$}
  \Output{$t \in \Inv(S)$}

  compute $\delta_0 = \com{ \theta_0 }$;

  form $C_0= (a_0/\delta_0) \times \{b_1\}$;

  compute $S_0=\Sg^{\alg{A}\times \alg{A}} ((a_0,a_1),(b_0,a_1),(b_0,b_1))$;

  find a term $t$ such that
%\begin{equation*}%t^{\alg{A}\times\alg{A}}((a_0,a_1),(b_0,a_1),(b_0,b_1)) =
  $(t^{\alg{A}}(a_0,b_0,b_0), t^{\alg{A}}(a_1,a_1,b_1)) \in C_0 \cap S_0$;
%\end{equation*}

return $t$
\end{algorithm}
In practice, there are a number of different ways we could structure this 
algorithm when implementing it in software, and it should be obvious 
that the ordering of the first three steps is inconsequential.\footnote{
  For instance, we might structure the algorithm in one of the following ways:
  \begin{enumerate}
    \item Compute $\delta_0 = \com{ \thetao }$, then 
    present $\Sg^{\alg{A}\times \alg{A}} ((a_0,a_1),(b_0,a_1),(b_0,b_1))$
    as a (call-by-need) stream $S_0$; filter $S_0$ against the predicate 
    $s \in (a_0/\delta_0) \times \{b_1\}$; the result is a stream from 
    which we take (compute) the first element.
    \item Alternatively, while generating elements of $S_0$ in Step 3
    of Algorithm~\ref{alg:ld-2}, we simultaneously check whether
    any of these elements belongs to $C_0$.  If so, the algorithm
    halts (without necessarily computing all of $S_0$).
  \end{enumerate}  %% \textcolor{red}{(Should we say explicitly how to perform Step 4 of Algorithm~\ref{alg:ld-2}?)}
  }

\begin{comment}
\noindent \underline{\textbf{Subroutine \ld-2'}}\\[4pt]
To compute an \ld term operation for
$((a_0,b_0,1), (a_1, b_1, 0))$, obviously this is symmetric to
the situation handled in Subroutine LD2 and so the general algorithm
is the same.  Nonetheless, we include a listing of the computational 
steps required so that later we can easily refer to this special case 
of the general algorithm.
\begin{enumerate}[{\bf 1}]
\item Compute $\delta_1=\com{\thetaone}$;
\item form $C_1= \{b_0\}\times a_1/\delta_1 \leq \alg{A}\times\alg{A}$;
\item compute
      $S_1=\Sg^{\alg{A}\times \alg{A}} ((a_0,a_1),(a_0,b_1),(b_0,b_1))$;
\item find a term operation $t$ of $\alg{A}$ satisfying
%\[t((a_0,a_1),(a_0,b_1),(b_0,b_1)) \in C \cap S.\]
\[t^{\alg{A}\times\alg{A}}((a_0,a_1),(a_0,b_1),(b_0,b_1)) =
 (t^{\alg{A}}(a_0,a_0,b_0), t^{\alg{A}}(a_1,b_1,b_1)) \in C_1 \cap S_1.\]
\end{enumerate}
Then $t$ is an \ld term for
$((a_0, b_0, 1), (a_1, b_1, 0))$.
\end{comment}


\subsubsection{Induction step}
\label{sec:induct}
Here are some notational conventions we use in this section.
% % we also take
% $as = ((a_0, b_0), (a_1, b_1), \dots, (a_k, b_k))$ 
% to be the list of all pairs in the set $A\times A$.
% Also define
\begin{align*}
\sA_0 &:= \{(a_0, b_0, 0), (a_0, b_0, 1)\},\\
\sA_1 &:= \{(a_0, b_0, 0), (a_0, b_0, 1), (a_1,b_1,0)\},\\
\sA_2 &:= \{(a_0, b_0, 0), (a_0, b_0, 1), (a_1,b_1,0), (a_1,b_1,1)\},\\
&\vdots\\
\sA_{2k} &:= \{(a_0, b_0, 0), (a_0, b_0, 1), \dots, (a_k,b_k,0), (a_k,b_k,1)\}.
\end{align*}
That is, 
$\sA_{2k} := \sA_{2k-1} \cup \{(a_k,b_k,1)\}$ and
$\sA_{2k+1} := \sA_{2k} \cup \{(a_{k+1},b_{k+1},0)\}$.
Let
\begin{align*}
  \zeta_i &:= \ld(a_i, b_i, 0), \\% \quad \text{ and } \quad
  \zeta_{\kk} &:= \bigcap_{0\leq i < k}\zeta_i 
%=\ld \{(a_i, b_i, 0) \mid 0\leq i<k\},
  =\ld ((a_0, b_0, 0), \dots, (a_{k-1}, b_{k-1}, 0)),\\
\eta_i &:= \ld(a_i, b_i, 1),\\
%   \quad \text{ and } \quad
  \eta_{\kk} &:= \bigcap_{0\leq i < k}\eta_i
  % =\ld \{(a_i, b_i, 1) \mid 0\leq i<k\}.
  =\ld ((a_0, b_0, 1) , \dots, (a_{k-1}, b_{k-1}, 1)).
\end{align*}
% Evidently, $\zeta_{\kk} = \bigcap_{0\leq i < k}\zeta_i$ is the set of \ld terms
% for $\{(a_i, b_i, 0) \mid 0\leq i<k\}$, while 
% $\eta_{\kk} = \bigcap_{0\leq i < k}\eta_i$ is the set of \ld terms
% for $\{(a_i, b_i, 1) \mid 0\leq i<k\}$.

Algorithm~\ref{alg:ld-2} serves as a base case, giving 
an \ld term for $\sA_0$ that we will use as input to Algorithm~\ref{alg:stream-ldt1}, the output of which is 
an \ld term for $\sA_1$.
That output will serve in turn as input to 
Algorithm~\ref{alg:stream-ldt2} the result of which is
an \ld term for $\sA_2$.  Thereafter, this process alternates between Algorithms~\ref{alg:stream-ldt1} and~\ref{alg:stream-ldt2}.
Inductively, we obtain a single \ld term for all of $A^2 \times \{0,1\}$,
which is a difference term operation for $\alg A$.

\RestyleAlgo{boxruled}
\LinesNumbered
\begin{algorithm}%[ht]
  \SetKwInOut{Input}{Input}
  \SetKwInOut{Output}{Output}

  \caption{Return an \ldt for $\sA_{2k+1}$ given 
  $\eta_{\kk}$ and an \ldt for $\sA_{2k}$.
  \label{alg:stream-ldt1}  }
  \Input{$\eta_{\kk}$ and $s_{2k} \in \ld(\sA_{2k})$}
  \Output{$\eta_{\kplus}$ and $s_{2k+1} \in \ld(\sA_{2k+1})$}

  compute $p \in \eta_{\kk} \cap \ld (a_{k+1}, s_{2k}(a_{k+1}, b_{k+1}, b_{k+1}), 0)$

  return $(s_{2k+1}, \eta_{\kplus})$ where 
  $s_{2k+1}(x,y,z) = p(x, s_{2k}(x,y,y), s_{2k}(x,y,z))$.
\end{algorithm}


\RestyleAlgo{boxruled}
\LinesNumbered
\begin{algorithm}%[ht]
  \SetKwInOut{Input}{Input}
  \SetKwInOut{Output}{Output}

  \caption{Return an \ldt for $\sA_{2k}$ given $\zeta_{\kk}$ and 
  an \ldt for $\sA_{2k-1}$.
  \label{alg:stream-ldt2}  }
\Input{$\zeta_{\kminus}$ and $s_{2k-1} \in \ld (\sA_{2k-1})$}
\Output{$\zeta_{\kk}$ and $s_{2k} \in \ld(\sA_{2k})$}

compute $p \in \zeta_{\kminus} \cap \ld (s_{2k-1}(a_k, a_k, b_k), b_k, 1)$;

  return $(s_{2k}, \zeta_{\kk})$ where 
  $s_{2k}(x,y,z) = p(s_{2k-1}(x,y,z), s_{2k-1}(y,y,z),z)$.
\end{algorithm}









%\bibliographystyle{amsplain} %% or amsalpha
%% \bibliographystyle{alpha-url}
%% \printbibliography
\bibliographystyle{alphaurl}
\bibliography{inputs/refs}






\end{document}









\newpage
\appendix

\section{Miscellaneous Proofs}
\subsection{Difference term identity verifications}
\label{app:dt-ids}

\begin{lemma}[Verifies Subroutine \ild-0]
If $p$ is an \ld term for 
\begin{equation*}
P_{j-1} = \{(a_0, b_0, 1), (a_1, b_1, 0), \dots, (a_{j-1}, b_{j-1}, 0)\}.  
\end{equation*}
and $t$ is an \ld term for
\begin{equation*}
\{(a_0, b_0, 1), (a_j, p(a_j, b_j, b_j), 0)\},
\end{equation*}
then $d(x,y,z) = t(x, p(x,y,y), p(x,y,z))$ is an \ld term for 
$P_{j} = P_{j-1}  \cup \{(a_j, b_j, 0)\}$.  
\end{lemma}

\begin{proof} There are three sorts of cases to check.
\begin{enumerate}[1.]
\item $(a_0, b_0, 1)$: 
\begin{equation*}
d(a_0, a_0, b_0) =  
t(a_0, p(a_0,a_0,a_0), p(a_0,a_0,b_0)) = 
t(a_0, a_0, b_0) = b_0
\end{equation*}
 
\item $(a_k, b_k, 0)$ $(1\leq k < j)$: 
\begin{equation*}
d(a_k, b_k, b_k) =  
t(a_k, p(a_k,b_k,b_k), p(a_k,b_k,b_k)) 
\comr{\thetak}  
t(a_k, a_k, a_k)  = a_k
\end{equation*}

\item $(a_j, b_j, 0)$: 
If  
$\thetaj := \Cg(a_j, b_j)$ and 
$\gammaj := \Cg(a_j, p(a_j, b_j, b_j))$, then
\begin{equation*}
d(a_j, b_j, b_j) =  
t(a_j, p(a_j,b_j,b_j), p(a_j,b_j,b_j)) 
\comr{\gammaj} a_j,
\end{equation*}
so 
$d(a_j, b_j, b_j) \comr{\thetaj} a_j$,
since $\gammaj \leq \thetaj$. 
\end{enumerate}
\end{proof}


\begin{lemma}[Verifies Subroutine \ild-1]
If $q$ is an \ld term for 
\begin{equation*}
Q_{j-1} = \{(a_0, b_0, 0), (a_1, b_1, 1), \dots, (a_{j-1}, b_{j-1}, 1)\}.  
\end{equation*}
and $t$ is an \ld term for
\begin{equation*}
\{(a_0, b_0, 0), (q(a_j, a_j, b_j), b_j, 1)\},
\end{equation*}
then $d(x,y,z) = t(q(x,y,z), q(y,y,z), z)$ is an \ld term for 
$Q_{j} = Q_{j-1}  \cup \{(a_j, b_j, 1)\}$.  
\end{lemma}

\begin{proof} There are three sorts of cases to check.
\begin{enumerate}[1.]
\item $(a_0, b_0, 0)$: 
\begin{equation*}
d(a_0, b_0, b_0) =  
t(q(a_0,b_0,b_0), q(b_0,b_0,b_0), b_0) 
\comr{\thetao} 
t(a_0, b_0, b_0) \comr{\thetao} 
a_0
\end{equation*}
 
\item $(a_k, b_k, 1)$ $(1\leq k < j)$: 
\begin{equation*}
d(a_k, a_k, b_k) =  
t(q(a_k,a_k,b_k), q(a_k,a_k,b_k), b_k) 
= t(b_k, b_k, b_k) = b_k
\end{equation*}

\item $(a_j, b_j, 1)$: 
\begin{equation*}
d(a_j, a_j, b_j) =  
t(q(a_j,a_j,b_j), q(a_j,a_j,b_j), b_j) = b_j 
\end{equation*}
\end{enumerate}
\end{proof}










\subsection{Algorithm for constructing a difference term operation}
\label{sec:algor-2}
We are now in a position to describe a complete procedure for constructing
a difference term operation for a given algebra $\alg{A}$.  

In this section we work with \emph{lists} 
(aka sequences, aka tuples) of triples, 
such as $((a_0, b_0, 0), (a_1, b_1, 0))$, rather than \emph{sets} of triples,
simply because for practical (computer implementation) purposes lists are a little 
easier to work with than sets.
% we refer to an ``\ld term operation for a tuple $(s_0)$ 

First, let 
% $\begin{equation}
%% $as = ((a_0, b_0), (a_1, b_1), \dots, (a_k, b_k))$ 
$((a_0, b_0), (a_1, b_1), \dots, (a_k, b_k))$ 
% \end{equation}
be a list of all pairs in the set $A\times A$.
% \footnote{Actually, we only need
% $(A \times A) \mysetminus \{(a,a) \mid a \in A\}$, but we will elide this
% detail in our description of the algorithm since it doesn't impact 
% complexity.}
Let 
\begin{equation*}
xs := %as \; zip \; (0,0,\dots, 0) = 
((a_0, b_0, 0), (a_1, b_1, 0), \dots, (a_k, b_k, 0)), 
\end{equation*}
and let 
% $xs_1 = xs \; zip \; (1,1, \dots, 1)$.
\begin{equation*}
ys := %as \; zip \; (1, 1, \dots, 1) = 
((a_0, b_0, 1), (a_1, b_1, 1), \dots, (a_k, b_k, 1)). 
\end{equation*}


Using Alg~\ref{alg:ld-2} for the base case 
and Alg~\ref{alg:ild1}
for the induction step,
we compute an \ld term $s_0$ for
\begin{equation*}
((a_0, b_0, 0), (a_1, b_1, 1), (a_2, b_2, 1), \dots, (a_k, b_k, 1)),  
\end{equation*}
and an \ld term $t_1$ for
\begin{equation*}
((s_0(a_0, a_0, b_0), b_0, 1), (a_0, b_0, 0),(a_1, b_1, 0)). 
\end{equation*}
The operation $s_1(x,y,z) := t_1(s_0(x,y,z), s_0(y,y,z), z)$ will then be
an \ld term for
% \begin{equation*}
$((a_0, b_0, 0), (a_1, b_1, 0)) :: ys$  (where $::$ denotes
list concatenation).
% \end{equation*}

Next, using Alg~\ref{alg:ld-2} for the base case
and Alg~\ref{alg:ild0} for the induction step,
we compute an \ld term $t_2$ for
\begin{equation*}
((s_1(a_0, a_0, b_0), b_0, 1), (a_0, b_0, 0),(a_1, b_1, 0),(a_2, b_2, 0)). 
\end{equation*}
Then $s_2(x,y,z) := t_2(s_1(x,y,z), s_1(y,y,z), z)$ is an \ld term
for the elements of
% \begin{equation}
$((a_0, b_0, 0), (a_1, b_1, 0), (a_2, b_2, 0)) :: ys$.
% \end{equation}

Proceeding inductively, for fixed $1<j\leq k$, 
if $s_{j-1}$ is an \ld term 
for the elements in the list
\begin{equation*}
((a_0, b_0, 0), (a_1, b_1, 0), \dots, (a_{j-1}, b_{j-1}, 0)) :: ys,
\end{equation*}
and if we use Algorithms~\ref{alg:ild0} and~\ref{alg:ild1}
to compute an \ld term $t_j$ for
\begin{equation*}
((s_{j-1}(a_0, a_0, b_0), b_0, 1), (a_0, b_0, 0),(a_1, b_1, 0),\dots, 
(a_j, b_j, 0)), 
\end{equation*}
then $s_j(x,y,z) := t_j(s_{j-1}(x,y,z), s_{j-1}(y,y,z), z)$ will be a 
\ld term operation for 
$((a_0, b_0, 0), (a_1, b_1, 0), \dots, (a_j, b_j, 0)) :: ys$.
In the end we arrive at an \ld term for $xs :: ys$, namely,
\begin{equation*}
d(x,y,z) = t_k(s_{k-1}(x,y,z), s_{k-1}(y,y,z), z).
\end{equation*}
Since $xs :: ys$ contains all of the triples $(a,b,\chi)$, where
$a, b \in A$ and $\chi \in \{0,1\}$, 
$d(x,y,z)$ is the desired difference term operation for $\alg{A}$.







compute $\delta_0$ and $\delta_1$ (see~(\ref{eqn:notation1}) for definition);

compute the stream $\sS_0$ of term operations $s$ that satisfy $s(a_0,a_0,b_0) = b_0$;

find a term operation $p$ in $\sS_0$ satisfying $p(a_0, b_0, b_0) \mathrel{\delta_0} a_0$;

compute $c_1 = p(a_1,b_1,b_1)$;

find a term operation $q$ in $\sS_0$ satisfying $q(a_1, c_1, c_1) \mathrel{\delta_1} a_1$;

return $(s_0, \sS_0)$ where $s_0(x,y,z) = q(x,p(x,y,y),p(x,y,z))$
\end{algorithm}

































\subsection{A more efficient algorithm}
\label{sec:algor-3}
In this section we refine the algorithm from Section~\ref{sec:algor-2}
for constructing a difference term operation for a given finite idempotent 
algebra $\alg{A}$.  
The point here is to describe a version of the algorithm that is more practical
and resembles how we might realistically implement it in a computer 
programming language.

In addition to notational conventions above, such as
\begin{equation}
\label{eqn:notation1}
\thetai = \Cg^{\alg{A}}(a_i, b_i) \; \text{ and } \;
\deltai=\com{\thetai},
\end{equation}
we also take
$as = ((a_0, b_0), (a_1, b_1), \dots, (a_k, b_k))$ 
to be the list of all pairs in the set $A\times A$.
Also define
\begin{align*}
\sA_0 &= \{(a_0, b_0, 0), (a_0, b_0, 1)\},\\
\sA_1 &= \{(a_0, b_0, 0), (a_0, b_0, 1), (a_1,b_1,0)\},\\
\sA_2 &= \{(a_0, b_0, 0), (a_0, b_0, 1), (a_1,b_1,0), (a_1,b_1,1)\},\\
&\vdots\\
\sA_{2k} &= \{(a_0, b_0, 0), (a_0, b_0, 1), \dots, (a_k,b_k,0), (a_k,b_k,1)\}.
\end{align*}
That is, 
$\sA_{2k} = \sA_{2k-1} \cup \{(a_k,b_k,1)\}$ and
$\sA_{2k+1} = \sA_{2k} \cup \{(a_{k+1},b_{k+1},0)\}$.

\RestyleAlgo{boxruled}
\LinesNumbered
\begin{algorithm}%[ht]
  \SetKwInOut{Input}{Input}
  \SetKwInOut{Output}{Output}

  \caption{return \ldt for $\sA_1$
  \label{alg:stream-ldt1}  }
% \Input{$as$ = the list of all pairs in $A \times A$}
% \Output{a difference term operation for $\alg A$}

compute $\delta_0$ and $\delta_1$ (see~(\ref{eqn:notation1}) for definition);

compute the stream $\sS_0$ of term operations $s$ that satisfy $s(a_0,a_0,b_0) = b_0$;

find a term operation $p$ in $\sS_0$ satisfying $p(a_0, b_0, b_0) \mathrel{\delta_0} a_0$;

compute $c_1 = p(a_1,b_1,b_1)$;

find a term operation $q$ in $\sS_0$ satisfying $q(a_1, c_1, c_1) \mathrel{\delta_1} a_1$;

return $(s_0, \sS_0)$ where $s_0(x,y,z) = q(x,p(x,y,y),p(x,y,z))$
\end{algorithm}


% \RestyleAlgo{boxed}
\RestyleAlgo{boxruled}
\LinesNumbered
\begin{algorithm}
  \SetKwInOut{Input}{Input}
  \SetKwInOut{Output}{Output}

  \caption{return \ldt for $\sA_2$
  \label{alg:stream-ldt2}  }
  \Input{$(s_0, \sS_0)$ (from Alg~\ref{alg:stream-ldt1})}
  \Output{an \ld term for $\sA_2$}

compute the stream $\sS_1$ of term operations $p$ 
that satisfy $p(s_0(a_1,a_1,b_1), s_0(a_1,a_1,b_1), b_1) = b_1$;

find a term operation $p$ in $\sS_0 \cap \sS_1$ and compute $d_1 = p(a_1,b_1,b_1)$;

find a term operation $q$ in $\sS_1$ satisfying $q(a_1, d_1, d_1) \mathrel{\delta_1} a_1$.

return $(\sS_0, \sS_1, s_1)$ where $s_1(x,y,z) = q(x, p(x,y,y), p(x,y,z))$
\end{algorithm}


% \RestyleAlgo{boxed}
\RestyleAlgo{boxruled}
\LinesNumbered
\begin{algorithm}
  \SetKwInOut{Input}{Input}
  \SetKwInOut{Output}{Output}

  \caption{return \ldt for $\sA_3$
  \label{alg:stream-ldt3}  }
  \Input{$(s_1, \sS_0, \sS_1)$ (from Alg~\ref{alg:stream-ldt2})}
  \Output{an \ld term for $\sA_3$}

compute $\delta_2$;

compute the substream $\sS_2 \subseteq \sS_0$ of terms satisfying
 $p(a_1,a_1,b_1) = b_1$;

compute $c_2 = s_1(a_2, b_2, b_2)$;

find a term operation $p$ in $\sS_2$ satisfying 
$p(a_2, c_2, c_2) \mathrel{\delta_2} a_2$;

return $(s_2, \sS_0, \sS_1, \sS_2)$ where $s_2(x,y,z) = p(x, s_1(x,y,y), s_1(x,y,z))$
\end{algorithm}


















%%% OLD ALGORITHM June 2017

\subsubsection{Induction steps}
\label{sec:induct}

The next ingredient we need for our construction of a 
difference term operation for $\alg{A}$ 
is 
a way to produce an \ld
term operation for a set of the form  (for $j>1$)
\begin{equation}
\label{eqn:Pj}
P_j = \{(a_0, b_0, 1), (a_1, b_1, 0), (a_2, b_2, 0), \dots, 
(a_j, b_j, 0)\},
\end{equation}
assuming we're given an \ld term operation for $P_{j-1} = P_{j} \mysetminus \{(a_j, b_j, 0)\}$.  


\begin{comment}
\noindent \underline{\bf Subroutine \ild-0}\\[4pt]
The input, $p$,  is
an \ld term operation for $P_{j-1} = P_{j} \mysetminus \{(a_j, b_j, 0)\}$.  
\begin{enumerate}[1.]
\item 
Call Subroutine \ld-2 to 
compute an \ld term operation $t$ for the set
\begin{equation*}
\{(a_0, b_0, 1), (a_j, p(a_j, b_j, b_j), 0)\}.
\end{equation*}
\item Return the following 
\ld term operation for $P_j$: 
\begin{equation}
d(x,y,z) = t(x, p(x,y,y), p(x,y,z)).
\label{eq:idl0-dto}
\end{equation}
\end{enumerate}
\qed
\end{comment}




% \RestyleAlgo{boxed}
\RestyleAlgo{boxruled}
\LinesNumbered
\begin{algorithm}%[ht]
  \SetKwInOut{Input}{Input}
  \SetKwInOut{Output}{Output}

  % \caption{Given \ld term for $P_{j-1}$, 
\caption{Return an \ld term for the set $P_j$ defined in~(\ref{eqn:Pj})
\label{alg:ild0}}  
%   $P_{j-1}=\{(a_0, b_0, 1), (a_1, b_1, 0), (a_2, b_2, 0), \dots, 
% (a_{j-1}, b_{j-1}, 0)\}$, compute an \ld term for 
 % = P_{j-1} \cup \{(a_j, b_j, 0)\}$
\Input{$p =$ an \ld term for $P_{j-1}$}
\Output{$d =$ an \ld term for $P_j$}

compute an \ld term $t$ for $\{(a_0, b_0, 1), (a_j, p(a_j, b_j, b_j), 0)\}$;

return $d(x,y,z) = t(x, p(x,y,y), p(x,y,z))$

\end{algorithm}


We also need a way to produce an \ld
term operation for a set of the form  (for $j>1$)
\begin{equation}
\label{eqn:Qj}
Q_{j} = \{(a_0, b_0, 0), (a_1, b_1, 1), (a_2, b_2, 1), \dots, 
(a_{j}, b_{j}, 1)\},
\end{equation}
assuming we're given an \ld term operation for 
$Q_{j-1} = Q_j \mysetminus \{(a_j, b_j, 1)\}$.  

% \RestyleAlgo{boxed}
\RestyleAlgo{boxruled}
\LinesNumbered
\begin{algorithm}%[ht]
  \SetKwInOut{Input}{Input}
  \SetKwInOut{Output}{Output}
  \caption{Return an \ld term for the set $Q_j$ defined in~(\ref{eqn:Qj})
  \label{alg:ild1}}  
  \Input{$q =$ an \ld term for $Q_{j-1}$}
  \Output{$d =$ an \ld term for $Q_j$}

  compute an \ld term $t$ for $\{(a_0, b_0, 0), (q(a_j, a_j, b_j), b_j, 1)\}$;

  return $d(x,y,z) = t(q(x,y,z), q(y,y,z), z)$
\end{algorithm}

\begin{remarks}\
\begin{enumerate}[1.] 
\item In each of the Algorithms~\ref{alg:ild0} and \ref{alg:ild1},
the first step is a call to Algorithm~\ref{alg:ld-2} 
for computing an \ld term for a pair of triples.
\item The easy verification that Algorithm~\ref{alg:ild0} returns
an \ld term for $P_j$ appears in Appendix Section~\ref{app:dt-ids}. 
\textcolor{red}{(Decide whether to omit proof.)}
\item The easy verification that Algorithm~\ref{alg:ild1} returns
an \ld term for $Q_j$ appears in Appendix Section~\ref{app:dt-ids}. 
\textcolor{red}{(Decide whether to omit proof.)}
\end{enumerate}
\end{remarks}
% (see Case $\chi_0=0$ in the proof of Theorem~\ref{thm:local-diff-terms}).


























With notation and assumptions as above.

\begin{theorem}[cf. Theorem 3.3 of \cite{FreeseValeriote2009}]
This is a test.
\end{theorem}






\bibliographystyle{rsfplain}
%\bibliography{\jobname}
\bibliography{/Users/ralph/tex/bib/Database/db}



A \emph{minority term} (for an algebra or variety) is a 
3-variable term $q(x,y,z)$ such if two of the variables
are equal, its value is the other one; that is, 
\[
q(x,x,y) \approx q(x,y,x) \approx q(y,x,x) \approx y.
\]
We are interested in an algebraic description of varieties having
a minority term. One possible conjecture is:
\begin{conjecture}
$\mathcal V$ has a minority term if and only if it is CP and its
ring has characteristic~1 or~2.
\end{conjecture}



\begin{fact}
If $\mathcal V$ has a minority term, then it is CP.
\end{fact}

\begin{proof}
Clearly a minority term is a \malcev term.
\end{proof}

\begin{fact}
A CD variety $\mathcal V$ has a minority term if and
only if it is CP.
\end{fact}

\begin{proof}
A variety is CD and CP if and only if it has a Pixley term. 
If $p(x,y,z)$ is a Pixley term then 
\[
q(x,y,z) = p(p(x,y,z),x,p(x,z,y))
\]
is a minority term. The fact can be derived from these
observations.
\end{proof}

\begin{fact}
A variety of groups has a minority term if and only
the variety has exponent 2 (well, or 1).
\end{fact}

\begin{proof}
If a variety has exponent 2 then it is abelian and so,
using additive notation, $x + y + z$ is a minority term.

If the exponent is not 2 then the variety contains a group
which contains an element of order $n$, where $n > 2$ (or 
infinite). This element generates a cyclic group. In any
abelian algebra the \malcev term operation is unique and so
must be $x - y + z$. But one easily checks that this is not
a minority term when $n > 2$.
\end{proof}

\begin{lemma}
Let $\mathcal V$ be a CP variety with a \malcev term $p(x,y.z)$.
The the following are equivalent:
\begin{enumerate}
\item
The ring $R(\mathcal V)$ of $\mathcal V$ has characteristic~2.
\item
On every block of every abelian congruence, $p$ restricted to the 
block is a minority term; that is, satisfies $p(a,b,a) = b$.
\item
If $\theta = \textup{Cg}^{\alg F_{\mathcal V}(x,y)}(x,y)$, then,
on each block of $\theta/[\theta,\theta]$, $p$ is a minority term.
\end{enumerate}
If $\mathcal V$ has a minority term, then these conditions hold.
\end{lemma}

\begin{proof}
By commutator theory (give some specific refs, also that the ring
is det by the strucure of $\theta/[\theta,\theta]$) 
the \malcev term operation on an
abelian algebra, or even a block of an abelian congruence, 
is unique and it is $p(x,y,z) = x - y + z$ for
some abelian group. It is easy that $x - y + z$ is a minority
if and only if the abelian group has exponent~2.
\end{proof}


\end{document}


Let $\alg A$ be an algebra and let $S$ and $T$ be tolerances
on $\alg A$. 
Let $M(S,T)$, or $M^{\alg A}(S,T)$ to emphasize $\alg A$,
be the set of all $2 \times 2$ matrices of the form
\begin{equation}\label{eq1}
\begin{bmatrix}
p&q\\
r&s
\end{bmatrix}
=
\begin{bmatrix}
f(\mathbf{a},\mathbf{u})&f(\mathbf{a},\mathbf{v})\\
f(\mathbf{b},\mathbf{u})&f(\mathbf{b},\mathbf{v})
\end{bmatrix}
\end{equation}
where $f(\mathbf{x},\mathbf{y})$ is an $(m+n)$-ary polynomial of
$\alg A$, $\mathbf{a} \mathrel{S} \mathbf{b}$, and 
$\mathbf{u} \mathrel{T} \mathbf{v}$
(componentwise, of course). The members of $M(S,T)$ are called
\emph{$S,T$-matrices}.

The first exercise gives an efficient way to find $M(S,T)$.

\section*{Exercises}

\begin{exercises}

\prob
Show that $M(S,T)$ is the subalgebra of $\alg A^4$ generated by
\[
\left\{
\begin{bmatrix}
a&a\\
b&b
\end{bmatrix} : a \mathrel{S} b\right\}
\union
\left\{
\begin{bmatrix}
c&d\\
c&d
\end{bmatrix} : c \mathrel{T} d\right\}
\]

\prob
Use the symmetry of $S$ and $T$ to show the matrix obtained from an
$S,T$-matrix by interchanging the rows or columns (or both) is also
in $M(S,T)$. 

\prob
$M(T,T)$ is closed under taking transposes. 

\end{exercises}

\section*{Centrality Relations}

We define four kinds of centrality, called centrality, strong
centrality, weak centrality, and strong rectularity. The is a fifth
centrality condition known as rectangularity which we will save for
later.

Let $\delta$ be a congruence and $S$ and $T$ be
tolerance relations on  $\alg A$. The above centrality relations
are denoted $\alg C(S,T;\delta)$ (centrality), 
$\alg S(S,T;\delta)$ (strong centrality), 
$\alg W(S,T;\delta)$ (weak centrality),  and
$\alg SR(S,T;\delta)$ (strong rectangularity). They hold if the
appropriate implication below holds for all 
\[
\begin{bmatrix}
p&q\\
r&s
\end{bmatrix} \in M(S,T)
\]
\begin{itemize}
\item centrality: 
$p \mathrel{\delta} q \implies r \mathrel{\delta} s$.
\item strong rectangularity: 
$p \mathrel{\delta} s \implies r \mathrel{\delta} s$.
\item weak centrality: 
$p \mathrel{\delta} q \mathrel{\delta} s \implies r \mathrel{\delta} s$.
\item strong centrality holds if both centrality and strong
rectangularity hold.
\end{itemize}

Using the exercises it is easy to see that the implication defining 
$\alg C(S,T;\delta)$ can be replaced by 
$r \mathrel{\delta} s \implies p \mathrel{\delta} q$ and this is
equivalent to 
\[
p \mathrel{\delta} q \Longleftrightarrow r \mathrel{\delta} s.
\]
Similar statements hold for the other conditions: weak centrality
is equivalent to saying that if any three of $p$, $q$, $r$ and $s$
are $\delta$ related, then they all are. And strong rectangularity
says that if the elements of the main diagonal, or of the sinister
diagonal, are $\delta$ related, then all four are.

The \emph{$S,T$-term condition} is the condition $\alg C(S,T,0)$,
usually expressed using the right-hand matrix in~\eqref{eq1}. 
Other kinds of term conditions are defined similarly. 

If $\alg C(S,T;\delta_i)$ holds for all $i \in I$, then
$\alg C(S,T;\Meet_{i\in I}\delta_i)$ holds. Similar statements hold
for the other centrality conditions. So there is a least $\delta$
such that $\alg C(S,T;\delta)$ holds. This $\delta$ is the 
\emph{commutator} of $S$ and $T$, and is denoted $[S,T]$. The
commutators for the other centrality relations are denoted
$[S,T]_{\alg S}$, $[S,T]_{\alg {SR}}$, and $[S,T]_{\alg W}$.

The properties of these centrality relations are coverered in
Theorem~2.19 and Theorem~3.4 of~\cite{KearnesKiss2013}. Much stronger
properties hold in congruence modular varieties;
see~\cite{FreeseMcKenzie1987}.

\section*{Exercises}

\begin{exercises}

\prob
As defined in \cite{HobbyMcKenzie1988}, $\beta$ is \emph{strongly
Abelian} over $\delta$ ($\delta \leq \beta$, both congruences on $\alg A$)
if the following implication holds for all polynomials $f$ and all
elements $x_0, \ldots, x_{n-1}$, $y_0, \ldots, y_{n-1}$, and 
$z_1, \ldots, z_{n-1}$ with $x_0 \mathrel\beta y_0$ and
$x_i \mathrel\beta y_i \mathrel\beta z_i$, $i = 1, \ldots n-1$.
\begin{align*}
f(x_0,\ldots,&x_{n-1}) \mathrel\delta f(y_0,\ldots,y_{n-1}) \\
&\implies
f(x_0, z_1,\ldots,z_{n-1}) \mathrel\delta f(y_0, z_1,\ldots,z_{n-1})
\end{align*}
Show that $\beta$ is strongly 
Abelian over $\delta$ if and only if $\alg S(\beta,\beta;\delta)$ 
holds, and also show this is in turn equivalent to
$\alg {SR}(\beta,\beta;\delta)$.
\end{exercises}



%%%%%%% wjd: old stuff (will delete eventually)%%%%%%%%%%%%%%%%%

\noindent \emph{TODO: the remaining sections about the algorithm will be completely
rewritten and mostly deleted.  Obviously we don't want to build up the 
algorithm in the way described.  Instead, we'll use recursion.}

\subsection{Sets of size three}
An \ld term operation for the set
\begin{equation*}
\{(a_0,b_0, 0), (a_1, b_1, 0), (a_2, b_2, 0)\}
\end{equation*}
is the first projection, $t(x,y,z) = x$.
An \ld term operation for the set
\begin{equation*}
\{(a_0,b_0,1), (a_1, b_1, 1), (a_2, b_2, 1)\}
\end{equation*}
is the third projection, $t(x,y,z) = y$.
There are two other forms of 3-sets to consider.
We label these $P_3$ and $Q_3$ and handle them with 
the following subroutines.
% They are
% \begin{align*}
% P &= \{(a_0, b_0, 0), (a_1, b_1, 0),  (a_2, b_2, 1)\} \text{ and }\\
% Q &= \{(a_0, b_0, 1), (a_1, b_1, 1), (a_2, b_2, 0)\}.
% \end{align*}
% $P = \{(a_0, b_0, 0), (a_1, b_1, 0),  (a_2, b_2, 1)\}$
% and $Q = \{(a_0, b_0, 1), (a_1, b_1, 1), (a_2, b_2, 0)\}$.


\noindent \underline{\textbf{Subroutine \ld-3.0}}\\[4pt]
To find an \ld term operation for
$P_3:=\{(a_0, b_0, 0), (a_1, b_1, 0),  (a_2, b_2, 1)\}$,
% $\{(a_0, b_0, 0), (a_1, b_1, 1),  (a_2, b_2, 0)\}$,
\begin{enumerate}
\item use Subroutine \ld-2 to compute an \ld term operation $s$ for
\begin{equation*}
\{(a_1, b_1, 0), (a_2, b_2, 1)\}; 
\end{equation*}
\item use Subroutine \ld-2 to compute an \ld term operation $t$ for
\begin{equation*}
\{(a_0, s(a_0, b_0, b_0), 0), (a_2, b_2, 1)\}.
\end{equation*}
\end{enumerate}
It is easy to check that
$d(x,y,z) = t(x, s(x,y,y), s(x,y,z))$
is then an \ld term operation for $P_3$ 
(see Case $\chi_0=0$ in the proof of Theorem~\ref{thm:local-diff-terms}).


\noindent \underline{\textbf{Subroutine \ld-3.1}}\\[4pt]
To find an \ld term operation for 
$Q_3 := \{(a_0, b_0, 1), (a_1, b_1, 1), (a_2, b_2, 0)\}$,
\begin{enumerate}
\item \label{item:001-1}
use Subroutine \ld-2 to compute an \ld term $s$ for the set
\begin{equation*}
\{(a_1, b_1, 1), (a_2, b_2, 0)\};
\end{equation*}
\item \label{item:001-2} use Subroutine \ld-2 to compute an \ld term $t$
for the set
\begin{equation*}
\{(s(a_0, a_0, b_0), b_0, 1),  (a_2,a_2,0)\}.
\end{equation*}
\end{enumerate}
Then 
%%%
$d(x,y,z) = t(s(x,y,z), s(y,y,z),z)$
%%%
is an \ld term  for $Q_3$ (see Case $\chi_0=1$ in the proof of Theorem~\ref{thm:local-diff-terms}).

\subsection{Sets of Size 4} We handle one more case before 
using induction to give a general recursive algorithm.
The nontrivial forms of 4-sets are
\begin{align*}
P_4 &:= \{(a_0, b_0, 0), (a_1, b_1, 0),  (a_2, b_2, 0),  (a_3, b_3, 1)\},\\ 
Q_4 &:= \{(a_0, b_0, 1), (a_1, b_1, 1), (a_2, b_2, 1), (a_3, b_3, 0)\},\\
R_4 &:= \{(a_0, b_0, 0), (a_1, b_1, 0),  (a_2, b_2, 1),  (a_3, b_3, 1)\}.
\end{align*}

\medskip

\noindent \underline{\textbf{Subroutine \ld-4.0}}\\[4pt]
To find an \ld term operation for a set like $P_4$,
% $\{(a_0, b_0, 0), (a_1, b_1, 1),  (a_2, b_2, 0)\}$,
\begin{enumerate}
\item use Subroutine \ld-3.0 to compute an \ld term operation $s$ for
\begin{equation*}
\{(a_1, b_1, 0),  (a_2, b_2, 0),  (a_3, b_3, 1)\};
\end{equation*}
\item use Subroutine \ld-2 to compute an \ld term operation $t$ for
\begin{equation*}
\{(a_0, s(a_0, b_0, b_0), 0), (a_3, b_3, 1)\}.
\end{equation*}
\end{enumerate}
It is easy to check that
$d(x,y,z) = t(x, s(x,y,y), s(x,y,z))$
is then an \ld term operation for $P_4$ 
(see Case $\chi_0=0$ in the proof of Theorem~\ref{thm:local-diff-terms}).

\medskip

\noindent \underline{\textbf{Subroutine \ld-4.1}}\\[4pt]
To find an \ld term operation for a set like $Q_4$
% $\{(a_0, b_0, 0), (a_1, b_1, 1),  (a_2, b_2, 1)\}$,
\begin{enumerate}
\item 
use Subroutine \ld-3.1 to compute an \ld term $s$ for the set
\begin{equation*}
\{(a_1, b_1, 1), (a_2, b_2, 1), (a_3, b_3, 0)\};
\end{equation*}
\item  use Subroutine \ld-2 to compute an \ld term $t$
for the set
\begin{equation*}
\{(s(a_0, a_0, b_0), b_0, 1),  (a_3,a_3,0)\}.
\end{equation*}
\end{enumerate}
Then 
%%%
$d(x,y,z) = t(s(x,y,z), s(y,y,z),z)$
%%%
is an \ld term  for $Q_4$ (see Case $\chi_0=1$ in the proof of Theorem~\ref{thm:local-diff-terms}).


\medskip

\noindent \underline{\textbf{Subroutine \ld-4.2}}\\[4pt]
To find an \ld term operation for a set like $R_4$
% $\{(a_0, b_0, 0), (a_1, b_1, 1),  (a_2, b_2, 1)\}$,
\begin{enumerate}
\item 
use Subroutine \ld-3.1 to compute an \ld term $s$ for the set
\begin{equation*}
\{(a_1, b_1, 0), (a_2, b_2, 1), (a_3, b_3, 1)\};
\end{equation*}
\item use Subroutine \ld-2 to compute an \ld term operation $t$ for
\begin{equation*}
\{(a_0, s(a_0, b_0, b_0), 0), (a_3, b_3, 1)\}.
\end{equation*}
\end{enumerate}
Then 
$d(x,y,z) = t(x, s(x,y,y), s(x,y,z))$
is an \ld term operation for $P_4$. 
