%% FILE: loc-diff-terms-ijac.tex
%% AUTHOR: William DeMeo, Ralph Freese
%% DATE: 1 Dec 2016
%% COPYRIGHT: (C) 2016 William DeMeo 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                         BIBLIOGRAPHY FILE            %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% The `filecontents` command will crete a file in the inputs directory called 
%% refs.bib containing the references in the document, in case this file does 
%% not exist already.
%% If you want to add a BibTeX entry, please don't add it directly to the
%% refs.bib file.  Instead, add it in this file between the
%% \begin{filecontents*}{refs.bib} and \end{filecontents*} lines
%% then delete the existing refs.bib file so it will be automatically generated 
%% again with your new entry the next time you run pdfaltex.
\begin{filecontents*}{inputs/refs.bib}
@article {MR1871085,
    AUTHOR = {Bergman, Clifford and Slutzki, Giora},
     TITLE = {Computational complexity of some problems involving
              congruences on algebras},
   JOURNAL = {Theoret. Comput. Sci.},
  FJOURNAL = {Theoretical Computer Science},
    VOLUME = {270},
      YEAR = {2002},
    NUMBER = {1-2},
     PAGES = {591--608},
      ISSN = {0304-3975},
     CODEN = {TCSDI},
   MRCLASS = {08A30 (05C85 08A35 68Q17)},
  MRNUMBER = {1871085 (2002i:08002)},
MRREVIEWER = {Radim B{\v{e}}lohl{\'a}vek},
       DOI = {10.1016/S0304-3975(01)00009-3},
       URL = {http://dx.doi.org/10.1016/S0304-3975(01)00009-3},
}
@article {MR1695293,
    AUTHOR = {Bergman, Clifford and Juedes, David and Slutzki, Giora},
     TITLE = {Computational complexity of term-equivalence},
   JOURNAL = {Internat. J. Algebra Comput.},
  FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {9},
      YEAR = {1999},
    NUMBER = {1},
     PAGES = {113--128},
      ISSN = {0218-1967},
   MRCLASS = {68Q17 (08A70 68Q15)},
  MRNUMBER = {1695293 (2000b:68088)},
       DOI = {10.1142/S0218196799000084},
       URL = {http://dx.doi.org/10.1142/S0218196799000084},
}
@article {MR3449235,
    AUTHOR = {Kearnes, Keith and Szendrei, {\'A}gnes and Willard, Ross},
     TITLE = {A finite basis theorem for difference-term varieties with a
              finite residual bound},
   JOURNAL = {Trans. Amer. Math. Soc.},
  FJOURNAL = {Transactions of the American Mathematical Society},
    VOLUME = {368},
      YEAR = {2016},
    NUMBER = {3},
     PAGES = {2115--2143},
      ISSN = {0002-9947},
   MRCLASS = {03C05 (08B05 08B10)},
  MRNUMBER = {3449235},
       DOI = {10.1090/tran/6509},
       URL = {http://dx.doi.org/10.1090/tran/6509},
}
@article {MR1663558,
    AUTHOR = {Kearnes, Keith A. and Szendrei, {\'A}gnes},
     TITLE = {The relationship between two commutators},
   JOURNAL = {Internat. J. Algebra Comput.},
  FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {8},
      YEAR = {1998},
    NUMBER = {4},
     PAGES = {497--531},
      ISSN = {0218-1967},
   MRCLASS = {08A05 (08A30)},
  MRNUMBER = {1663558},
MRREVIEWER = {M. G. Stone},
       DOI = {10.1142/S0218196798000247},
       URL = {http://dx.doi.org/10.1142/S0218196798000247},
}
@article{KSW,
title = {Simpler maltsev conditions for (weak) difference terms in locally finite varieties},
author = {Kearnes, Keith and Szendrei, \'{A}gnes and Willard, Ross},
note = {to appear}
}

@article{DeMeo:2017,
title = {On Deciding Existence of Difference Terms},
author = {DeMeo, William},
note = {to appear}
}

@article {MR3239624,
    AUTHOR = {Valeriote, M. and Willard, R.},
     TITLE = {Idempotent {$n$}-permutable varieties},
   JOURNAL = {Bull. Lond. Math. Soc.},
  FJOURNAL = {Bulletin of the London Mathematical Society},
    VOLUME = {46},
      YEAR = {2014},
    NUMBER = {4},
     PAGES = {870--880},
      ISSN = {0024-6093},
   MRCLASS = {08A05 (06F99 68Q25)},
  MRNUMBER = {3239624},
       DOI = {10.1112/blms/bdu044},
       URL = {http://dx.doi.org/10.1112/blms/bdu044},
}
@article {MR3350327,
    AUTHOR = {Kozik, Marcin and Krokhin, Andrei and Valeriote, Matt and
              Willard, Ross},
     TITLE = {Characterizations of several {M}altsev conditions},
   JOURNAL = {Algebra Universalis},
  FJOURNAL = {Algebra Universalis},
    VOLUME = {73},
      YEAR = {2015},
    NUMBER = {3-4},
     PAGES = {205--224},
      ISSN = {0002-5240},
   MRCLASS = {08B05 (08A70 08B10)},
  MRNUMBER = {3350327},
MRREVIEWER = {David Hobby},
       DOI = {10.1007/s00012-015-0327-2},
       URL = {http://dx.doi.org/10.1007/s00012-015-0327-2},
}
@article {MR1358491,
    AUTHOR = {Kearnes, Keith A.},
     TITLE = {Varieties with a difference term},
   JOURNAL = {J. Algebra},
  FJOURNAL = {Journal of Algebra},
    VOLUME = {177},
      YEAR = {1995},
    NUMBER = {3},
     PAGES = {926--960},
      ISSN = {0021-8693},
     CODEN = {JALGA4},
   MRCLASS = {08B10 (08B05)},
  MRNUMBER = {1358491},
MRREVIEWER = {H. Peter Gumm},
       DOI = {10.1006/jabr.1995.1334},
       URL = {http://dx.doi.org/10.1006/jabr.1995.1334},
}
@book {MR2839398,
    AUTHOR = {Bergman, Clifford},
     TITLE = {Universal algebra},
    SERIES = {Pure and Applied Mathematics (Boca Raton)},
    VOLUME = {301},
      NOTE = {Fundamentals and selected topics},
 PUBLISHER = {CRC Press, Boca Raton, FL},
      YEAR = {2012},
     PAGES = {xii+308},
      ISBN = {978-1-4398-5129-6},
   MRCLASS = {08-02 (06-02 08A40 08B05 08B10 08B26)},
  MRNUMBER = {2839398 (2012k:08001)},
MRREVIEWER = {Konrad P. Pi{\'o}ro},
}
@article {MR0434928,
    AUTHOR = {Taylor, Walter},
     TITLE = {Varieties obeying homotopy laws},
   JOURNAL = {Canad. J. Math.},
  FJOURNAL = {Canadian Journal of Mathematics. Journal Canadien de
              Math\'ematiques},
    VOLUME = {29},
      YEAR = {1977},
    NUMBER = {3},
     PAGES = {498--527},
      ISSN = {0008-414X},
   MRCLASS = {08A25},
  MRNUMBER = {0434928 (55 \#7891)},
MRREVIEWER = {James B. Nation},
}
  @BOOK{HM:1988,
    AUTHOR = {Hobby, David and McKenzie, Ralph},
    TITLE = {The structure of finite algebras},
    SERIES = {Contemporary Mathematics},
    VOLUME = {76},
    PUBLISHER = {American Mathematical Society},
    ADDRESS = {Providence, RI},
    YEAR = {1988},
    PAGES = {xii+203},
    ISBN = {0-8218-5073-3},
    MRCLASS = {08A05 (03C05 08-02 08B05)},
    MRNUMBER = {958685 (89m:08001)},
    MRREVIEWER = {Joel Berman},
    note = {Available from:
      \href{http://math.hawaii.edu/~ralph/Classes/619/HobbyMcKenzie-FiniteAlgebras.pdf}{math.hawaii.edu}}
  }
@article {MR0455543,
    AUTHOR = {Jones, Neil D. and Laaser, William T.},
     TITLE = {Complete problems for deterministic polynomial time},
   JOURNAL = {Theoret. Comput. Sci.},
  FJOURNAL = {Theoretical Computer Science},
    VOLUME = {3},
      YEAR = {1976},
    NUMBER = {1},
     PAGES = {105--117 (1977)},
      ISSN = {0304-3975},
   MRCLASS = {68A20},
  MRNUMBER = {0455543},
MRREVIEWER = {Forbes D. Lewis},
       DOI = {10.1016/0304-3975(76)90068-2},
       URL = {http://dx.doi.org/10.1016/0304-3975(76)90068-2},
}
	
  @article {Freese:2009,
    AUTHOR = {Freese, Ralph and Valeriote, Matthew A.},
    TITLE = {On the complexity of some {M}altsev conditions},
    JOURNAL = {Internat. J. Algebra Comput.},
    FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {19},
    YEAR = {2009},
    NUMBER = {1},
    PAGES = {41--77},
    ISSN = {0218-1967},
    MRCLASS = {08B05 (03C05 08B10 68Q25)},
    MRNUMBER = {2494469 (2010a:08008)},
    MRREVIEWER = {Clifford H. Bergman},
    DOI = {10.1142/S0218196709004956},
    URL = {http://dx.doi.org/10.1142/S0218196709004956}
  }
@article {MR3076179,
    AUTHOR = {Kearnes, Keith A. and Kiss, Emil W.},
     TITLE = {The shape of congruence lattices},
   JOURNAL = {Mem. Amer. Math. Soc.},
  FJOURNAL = {Memoirs of the American Mathematical Society},
    VOLUME = {222},
      YEAR = {2013},
    NUMBER = {1046},
     PAGES = {viii+169},
      ISSN = {0065-9266},
      ISBN = {978-0-8218-8323-5},
   MRCLASS = {08B05 (08B10)},
  MRNUMBER = {3076179},
MRREVIEWER = {James B. Nation},
       DOI = {10.1090/S0065-9266-2012-00667-8},
       URL = {http://dx.doi.org/10.1090/S0065-9266-2012-00667-8},
}
@incollection {MR1404955,
    AUTHOR = {Kearnes, Keith A.},
     TITLE = {Idempotent simple algebras},
 BOOKTITLE = {Logic and algebra ({P}ontignano, 1994)},
    SERIES = {Lecture Notes in Pure and Appl. Math.},
    VOLUME = {180},
     PAGES = {529--572},
 PUBLISHER = {Dekker, New York},
      YEAR = {1996},
   MRCLASS = {08B05 (06F25 08A05 08A30)},
  MRNUMBER = {1404955 (97k:08004)},
MRREVIEWER = {E. W. Kiss},
}
@misc{william_demeo_2016_53936,
  author       = {DeMeo, William and Freese, Ralph},
  title        = {AlgebraFiles v1.0.1},
  month        = May,
  year         = 2016,
  doi          = {10.5281/zenodo.53936},
  url          = {http://dx.doi.org/10.5281/zenodo.53936}
}
@article{FreeseMcKenzie2016,
	Author = {Freese, Ralph and McKenzie, Ralph},
	Date-Added = {2016-08-22 19:43:56 +0000},
	Date-Modified = {2016-08-22 19:45:50 +0000},
	Journal = {Algebra Universalis},
	Title = {Mal'tsev families of varieties closed under join or Mal'tsev product},
	Year = {to appear}
}
@article {MR2333368,
    AUTHOR = {Kearnes, Keith A. and Tschantz, Steven T.},
     TITLE = {Automorphism groups of squares and of free algebras},
   JOURNAL = {Internat. J. Algebra Comput.},
  FJOURNAL = {International Journal of Algebra and Computation},
    VOLUME = {17},
      YEAR = {2007},
    NUMBER = {3},
     PAGES = {461--505},
      ISSN = {0218-1967},
   MRCLASS = {08A35 (08B20 20B25)},
  MRNUMBER = {2333368},
MRREVIEWER = {Giovanni Ferrero},
       DOI = {10.1142/S0218196707003615},
       URL = {http://dx.doi.org/10.1142/S0218196707003615},
}
@article {MR2504025,
    AUTHOR = {Valeriote, Matthew A.},
     TITLE = {A subalgebra intersection property for congruence distributive
              varieties},
   JOURNAL = {Canad. J. Math.},
  FJOURNAL = {Canadian Journal of Mathematics. Journal Canadien de
              Math\'ematiques},
    VOLUME = {61},
      YEAR = {2009},
    NUMBER = {2},
     PAGES = {451--464},
      ISSN = {0008-414X},
     CODEN = {CJMAAB},
   MRCLASS = {08B10 (08A30 08B05)},
  MRNUMBER = {2504025},
MRREVIEWER = {Jarom{\'{\i}}r Duda},
       DOI = {10.4153/CJM-2009-023-2},
       URL = {http://dx.doi.org/10.4153/CJM-2009-023-2},
}
@misc{UACalc,
	Author = {Ralph Freese and Emil Kiss and Matthew Valeriote},
	Date-Added = {2014-11-20 01:52:20 +0000},
	Date-Modified = {2014-11-20 01:52:20 +0000},
	Note = {Available at: {\verb+www.uacalc.org+}},
	Title = {Universal {A}lgebra {C}alculator},
	Year = {2011}
}
@article{Freese2008,
	Author = {Freese, Ralph},
	Date-Added = {2016-08-29 01:31:23 +0000},
	Date-Modified = {2016-08-29 01:32:09 +0000},
	Journal = {Alg. Univ.},
	Pages = {337--343},
	Title = {Computing congruences efficiently},
	Volume = {59},
	Year = {2008}
}	
@article {MR2470585,
    AUTHOR = {Freese, Ralph},
     TITLE = {Computing congruences efficiently},
   JOURNAL = {Algebra Universalis},
  FJOURNAL = {Algebra Universalis},
    VOLUME = {59},
      YEAR = {2008},
    NUMBER = {3-4},
     PAGES = {337--343},
      ISSN = {0002-5240},
   MRCLASS = {08A30 (08A40 68W30 68W40)},
  MRNUMBER = {2470585 (2009j:08003)},
MRREVIEWER = {Clifford H. Bergman},
       DOI = {10.1007/s00012-008-2073-1},
       URL = {http://dx.doi.org/10.1007/s00012-008-2073-1},
}
@incollection {MR1191235,
    AUTHOR = {Szendrei, {\'A}gnes.},
     TITLE = {A survey on strictly simple algebras and minimal varieties},
 BOOKTITLE = {Universal algebra and quasigroup theory ({J}adwisin, 1989)},
    SERIES = {Res. Exp. Math.},
    VOLUME = {19},
     PAGES = {209--239},
 PUBLISHER = {Heldermann, Berlin},
      YEAR = {1992},
   MRCLASS = {08-02 (08A40 08B05)},
  MRNUMBER = {1191235 (93h:08001)},
MRREVIEWER = {Ivan Chajda},
}
@unpublished{Bergman-DeMeo,
    AUTHOR = {Bergman, Clifford and DeMeo, William},
    TITLE = {Universal Algebraic Methods for Constraint Satisfaction Problems:
      with applications to commutative idempotent binars},
    YEAR = {2016},
    NOTE = {unpublished notes; soon to be available online},
    URL = {https://github.com/UniversalAlgebra/algebraic-csp}
}
\end{filecontents*}
%:biblio
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                     PREAMBLE                                   %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass{ws-ijac}
\usepackage{graphicx}
\usepackage{comment}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% showkeys: just comment out in the final version
%\usepackage[notref,notcite]{showkeys}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% \usepackage{setspace}\onehalfspacing

%% removed these for ijac
\usepackage{amsmath}
% \usepackage{amscd,amssymb,amsthm} %, amsmath are included by default
\usepackage{mathtools}
% \usepackage{scrextend}

\usepackage{bm}
\usepackage{latexsym,stmaryrd,mathrsfs,enumerate,scalefnt,ifthen}
\usepackage[mathscr]{euscript}
%% \usepackage{yfonts}
% \usepackage{eufrak}
\usepackage[colorlinks=true,urlcolor=black,linkcolor=black,citecolor=black]{hyperref}
\usepackage{url}
\usepackage{scalefnt}
\usepackage{tikz}
\usepackage{color}
%% \usepackage[margin=1.5in]{geometry}

%% \usepackage{cleveref} %[2012/02/15]% v0.18.4; 
% 0.16.1 of May 2010 would be sufficient, but what is the exact day?

\usepackage[multiple]{footmisc}  %% for multiple footnote marks on same text

%% \crefformat{footnote}{#2\footnotemark[#1]#3}

\newtheorem{Fact}{Fact}[section]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Acronyms
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% \usepackage[acronym, shortcuts]{glossaries}
%\usepackage[smaller]{acro}
\usepackage[smaller]{acronym}
\usepackage{xspace}

%% \acs{CSP} -- short version of the acronym\\
%% \acl{CSP} -- expanded acronym without mentioning the acronym.\\
%% \acp{CSP} -- plurals.\\
%% \acfp{CSP} -- long forms into plurals.\\
%% \acsp{CSP} -- short form into a plural.\\
%% \aclp{CSP} -- long form into a plural.\\
%% \acfi{CSP} -- Full Name acronym in italics and abbreviated form in upshape.\\
%% \acsu{CSP} -- short form of the acronym and marks it as used.\\
%% \aclu{CSP} -- Prints the long form of the acronym and marks it as used.\\

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                      TODO items                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Use the \todo command to make notes of things to fix. 
%% Apply italics or bold or caps for emphasis as needed, e.g.,
%%
%%     \todo{(wjd) FIX THE NEXT LINE!}
%%     \todo{(wjd) \emph{Revise the paragraph above}}
%%
   \newboolean{todos}
   \setboolean{todos}{true}  % set to true to include TODO statements
%   \setboolean{todos}{false}  % set to false to exclude TODO statements

   %%% INTENDED USE OF THE arxiv AND extralong BOOLEAN VARIABLES
   %%% -- The brief journal version should have `arxiv` and `extralong` variables set to false.
   %%% -- The arxiv version should have `arxiv` set to true and `extralong` set to false.
   %%% -- The extralong version may contain notes intended for our own personal reference.
   %%%    For the extralong version, set both `arxiv` and `extralong` to true.   
   \newboolean{arxiv}
   \setboolean{arxiv}{true}  % set to true to include almost everything
   \setboolean{arxiv}{false}  % set to false for the brief version

   \newboolean{extralong}
   \setboolean{extralong}{true}  % set to true to include everything
   \setboolean{extralong}{false}  % set to false for the long (but not too long) version

   \newboolean{footnotes}
   \setboolean{footnotes}{true}  % set to true to include footnotes
   \setboolean{footnotes}{false}  % set to false for no footnotes


   \newboolean{draftsecskip}
   \setboolean{draftsecskip}{true}
   % \setboolean{draftsecskip}{false}

   \newboolean{thetanotation}
   \setboolean{thetanotation}{true}
   \setboolean{thetanotation}{false}


   % \newcommand\draftsecskip{\ifthenelse{\boolean{draftsecskip}}{\medskip}{}}
   \newcommand\draftsecskip{\ifthenelse{\boolean{draftsecskip}}{\newpage}{}}

   %%%% wjd: adding pagebreaks for ``draft mode'' to reduce printing costs
   %%%%      To turn off these unnecessary page breaks, set `draft` to false:
   \newboolean{draft}
   \setboolean{draft}{true}  % set to true to include footnotes



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% \usepackage{inputs/proof-dashed}
\acrodef{lics}[LICS]{Logic in Computer Science}
\acrodef{sat}[SAT]{satisfiability}
\acrodef{nae}[NAE]{not-all-equal}
\acrodef{ctb}[CTB]{cube term blocker}
\acrodef{tct}[TCT]{tame congruence theory}
\acrodef{wnu}[WNU]{weak near-unanimity}
\acrodef{CSP}[CSP]{constraint satisfaction problem}
\acrodef{MAS}[MAS]{minimal absorbing subuniverse}
\acrodef{MA}[MA]{minimal absorbing}
\acrodef{cib}[CIB]{commutative idempotent binar}
\acrodef{sd}[SD]{semidistributive}
\acrodef{NP}[NP]{nondeterministic polynomial time}
\acrodef{P}[P]{polynomial time}
\acrodef{PeqNP}[P $ = $ NP]{P is NP}
\acrodef{PneqNP}[P $ \neq $ NP]{P is not NP}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% MY STUFF
\usepackage{inputs/macros}
%% END MY STUFF %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%CLIFF'S STUFF
%% For debugging we want to turn a few facilitites on
%For marginal notes. 
%% \usepackage{pifont}
%% \usepackage{bm}
%% \newcommand\mpar[1]{\mbox{}\marginpar{\raggedright\hspace{0pt}\small #1}}
%% %\newcommand\mpar[1]{\relax} %uncomment to turn off marginal notes
%% \newcommand{\towjd}[1]{\par \noindent \mpar{\ding{'120}}{{\bf chb:} \emph{#1}}\par}
%% \newcommand{\tochb}[1]{\par \noindent \mpar{\ding{'121}}{{\bf wjd:} \emph{#1}}\par}
%% \let\:\colon
%% \newcommand{\card}[1]{|#1|}
%% \DeclareMathOperator{\size}{size}
%% \newcommand{\sansV}{\ensuremath{\mathsf{V}}}
%% \newcommand{\Sl}{\ensuremath{Sl}} %I don't know what font to use
%% \newcommand{\Sq}[1]{\ensuremath{\mathbf{Sq}_{#1}}}
%% \newcommand{\sdm}{\sd-\meet\xspace}
%% \newcommand{\casespec}[1]{\medskip\noindent\textbf{#1}.\enspace}
%% %:Cliff's macs
%%% END OF CLIFF'S STUFF


%% \newcommand{\glocal}{global-local}
\newcommand{\glocal}{local\xspace}
%% This is a weird name, I know... but maybe we can pull it off.

%%% For pseudocode
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
%% If you are using ubuntu linux and you get the error
%%     LaTeX Error: File `algorithm.sty' not found.
%% then do `sudo apt-get install texlive-science`

%% \linenumbers

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                        FRONT MATTER                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\markboth{W.~DeMeo and R.~Freese}
{Existence of Difference Terms}

%%%%%%%%%%%%%%%%%%%%% Publisher's Area please ignore %%%%%%%%%%%%%%%
%
\catchline{}{}{}{}{}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title{ON THE COMPLEXITY OF DIFFERENCE TERM EXISTENCE}

%///////////////////////////////////////////////////////////////////////////////////////
%% AUTHORS
\author{WILLIAM DEMEO}
\address{Department of Mathematics, University of Hawaii\\Honolulu, Hawaii, 96822 USA\\
\email{williamdemeo@gmail.com}}
\author{RALPH FREESE}
\address{Department of Mathematics, University of Hawaii\\Honolulu, Hawaii, 96822 USA\\
\email{ralph@math.hawaii.edu}}

%% \author{WILLIAM DEMEO  \hskip3mm RALPH FREESE}
%% \address{Department of Mathematics, University of Hawaii\\Honolulu, Hawaii, 96822 USA\\
%% \email{williamdemeo@gmail.com \hskip3mm ralph@math.hawaii.edu}}


\maketitle

% ///////////////////////////////////////////////////////////////////////////////////////
%% Date
\begin{history}
\received{(Day Month Year)}
\accepted{(Day Month Year)}
\comby{[editor]}
\end{history}


\begin{abstract}
We consider the following practical question: given a finite algebra $\bA$ in a
finite language, can we efficiently decide whether the variety generated by
$\bA$ has a difference term?  In~\cite{DeMeo:2017}
``local difference terms'' were defined and used to solve 
a related but easier problem---namely, it was shown that
there is a polynomial-time algorithm for deciding whether any finite idempotent
algebra has a difference term operation. 
In the present paper, we continue to build on the ideas in~\cite{MR3239624}
and complete the project started~\cite{DeMeo:2017}. More specifically,
we define ``global-local difference terms'' which we use to 
devise an efficient algorithm for deciding whether the
variety generated by a finite idempotent algebra has a difference term.
\end{abstract}


%///////////////////////////////////////////////////////////////////////////////////////
%% KEYWORDS
%% Keywords and phrases
\keywords{%
  difference term;
  finite idempotent algebra;
  polynomial-time algorithm}

%///////////////////////////////////////////////////////////////////////////////////////
%% AMS SUBJECT CLASSIFICATION
%% see http://www.ams.org/msc Only one Primary. Possibly several Secondary. 
\ccode{Mathematics Subject Classification 2000: 08B05, 08B10, 68Q25, 03C05   %
  %% Primary:  08B05     %
  %% Secondary:  08B10, 68Q25, 03C05   %
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                           Main Matter                                        %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%////////////////////////////////////////////////////////////////////////////////
%% Theorem styles
%% \numberwithin{equation}{section}
%% \theoremstyle{plain}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}[thm]{Lemma}
%% \newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}

%% \theoremstyle{definition}
%% \newtheorem{definition}[thm]{Definition}
%% \newtheorem{notation}[thm]{Notation}
\newtheorem{rem}[thm]{Remark}
\newtheorem{prob}{Problem}
%% \newtheorem{example}[thm]{Example}
%% \newtheorem*{rems}{Remarks}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% \usepackage{inputs/proof-dashed}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section{Introduction}
\label{sec:introduction}
Let $\sV$ be a variety (equational class) of algebras.
A ternary term $d$ in the language of $\sV$ is called 
a \defn{difference term for $\sV$} if it satisfies the following:
for all $\bA = \<A, \dots \> \in \sV$, for all $a, b \in A$, for every 
congruence $\theta\in \Con\bA$ containing $(a,b)$, we have
\begin{equation}
\label{eq:3}  
d^{\bA}(a,a,b) = b \quad \text{ and } \quad
d^{\bA}(a,b,b) \comm \theta \theta a,
\end{equation}
where $[\cdot, \cdot]$ denotes the (term condition) commutator
defined in Section~\ref{sec:definitions} below
(see also~\cite{HM:1988} or~\cite{MR3076179}).
(By the monotonicity of the commutator, we could replace $\theta$ in the
definition by $\Cg^{\bA}(a,b)$.)
If for all $a, b \in A$ the relations in (\ref{eq:3}) hold 
with $\theta = \Cg^{\bA}(a,b)$, then we call
$d^{\bA}$ a \defn{difference term operation} for $\bA$.

Difference terms are studied extensively in the universal algebra literature.
(See, for example, \cite{HM:1988,KSW,MR3449235,MR1358491,MR3076179,MR1663558}.)
There are many reasons to study difference terms, but
perhaps the most obvious is that knowing a variety 
has a difference term allows us to deduce many useful
properties of the algebras inhabiting that variety.
(Very roughly speaking, having a difference term is slightly stronger than having
a Taylor term and slightly weaker than having a Mal'tsev term.
Note that if
$\bA$ is an \defn{abelian} algebra---that is, $[1_A, 1_A] = 0_A$---then by
the monotonicity of the commutator we have
$[\theta, \theta] = 0_A$ for all $\theta \in \Con \bA$, in which case
(\ref{eq:3}) says that $d^{\bA}$ is a Mal'tsev term operation.)

Digital computers have turned out to be invaluable tools for exploring and
understanding algebras and the varieties they inhabit, and this is largely due
to the fact that researchers have found ingenious ways
to get computers to solve abstract decision problems---such as
whether a variety is 
congruence-modular (\cite{Freese:2009}) or
congruence-$n$-permutable (\cite{MR3239624})---and to do so efficiently.
%% , in a way that scales well with problem size.
The contribution of the present paper is to present a solution to the following:
\begin{prob}
  \label{prob:1}
  Is there a polynomial-time algorithm that takes a finite
  idempotent algebra $\bA$ as input and decides whether the variety generated by
  $\bA$ has a difference term?
\end{prob}
By solving Problem~\ref{prob:1} we complete the project started
in~\cite{DeMeo:2017}; in the latter, we solved the following easier problem:
\begin{prob}
  \label{prob:2}
  Is there a polynomial-time algorithm that takes a finite
  idempotent algebra $\bA$ as input and decides whether 
  $\bA$ has a difference term operation?
\end{prob}

The rest of the paper is organized as follows:
Section~\ref{sec:definitions} introduces notation and definitions and some of
the background that we expect the reader to have.
In~\cite{MR1358491} 
it was shown that a locally finite idempotent variety $\sV$ has a difference
term if and only if $\sansH \sansS \sansP(\bF_{\sV}(2))$ 
has a difference term (where $\bF_{\sV}(2)$ denotes the 2-generated free algebra in $\sV$).
In Section~\ref{sec:equiv-cond-exist}
we extend this result by showing that this is also equivalent to
the free algebra $\bF_{\sV}(2)$ itself having a difference term operation.
In~\cite{MR3239624},
Valeriote and Willard define 
a ``local Hagemann-Mitschke sequence'' which they use as the basis of
an efficient algorithm for deciding for a given $n$ whether an idempotent
variety is $n$-permutable. 
In Section~\ref{sec:local-diff-terms}
we devise a similar construct, called
a ``local difference term,'' that we use to develop a polynomial-time
algorithm for deciding the existence of a (``global-local'') difference term
operation for $\bA$.  In Section~\ref{sec:glob-local-diff} we introduce 
``global-local difference terms'' which we use to
devise a polynomial-time algorithm for deciding whether the variety
generated by a finite idempotent algebra has a difference term.


\section{Background, Notation, Definitions}
\label{sec:definitions}
%% The centralizer, term condition, and abelian congruences}
%% We review some useful properties of centralizers and abelian
Our arguments depend on some basic results of universal algebra that we now review.
For the most part we use standard notation such as those found in~\cite{MR2839398}.
\ifthenelse{\boolean{thetanotation}}{
  One exception is the old-fashioned notation we use for congruence generation:
  if $\bA =\<A, \dots\>$ is an algebra with elements $a, b \in A$,
  then we use $\Theta(a,b)$ to denote the congruence of $\bA$ generated by $a$
  and $b$. If $X\subseteq A$, then $\Theta(X)$ is the congruence generated by $X$.  
  \renewcommand{\Cg}{\ensuremath{\Theta}}
  Most other notation we use is standard.
}{}
The set of all congruences of $\bA$ is
denoted $\Con(\bA)$. The subalgebra of $\bA$ generated by a set $X \subseteq A$ 
is denoted $\Sg^{\bA}(X)$, but if $X$ is finite, say, $X = \{a,b\}$, then we
often write $\Sg^{\bA}(a,b)$ instead of $\Sg^{\bA}(\{a,b\})$.


Let $\bA = \<A, F^{\bA}\>$ be an algebra.
A reflexive, symmetric, compatible binary relation $T\subseteq A^2$ is called a
\defn{tolerance of $\bA$}.  
Given a pair $(\bu, \bv) \in A^m\times A^m$ of $m$-tuples of $A$, we write 
$\bu \mathrel{\bT} \bv$ just in case $\bu(i) \mathrel{T} \bv(i)$ for all $0\leq i<m$. 
We state a number of definitions in this section using tolerance relations, but 
the definitions don't change when the tolerance in question happens to be
a congruence relation (i.e., a transitive tolerance).

Suppose $S$ and $T$ are tolerances on $\bA$.  An \defn{$S,T$-matrix} 
is a $2\times 2$ array of the form
\[
\begin{bmatrix*}[r] t(\ba,\bu) & t(\ba,\bv)\\ t(\bb,\bu)&t(\bb,\bv)\end{bmatrix*},
\]
where $t$, $\ba$, $\bb$, $\bu$, $\bv$ have the following properties:
\begin{enumerate}[(i)] %[label=(\roman*)]
\item $t\in \sansClo_{\ell + m}(\bA)$,
\item $(\ba, \bb)\in A^\ell\times A^\ell$ and $\ba \mathrel{\bS} \bb$,
\item $(\bu, \bv)\in A^m\times A^m$ and $\bu \mathrel{\bT} \bv$.
\end{enumerate}
Let $\delta$ be a congruence relation of $\bA$.
If the entries of every $S,T$-matrix satisfy
\begin{equation}
  \label{eq:22}
t(\ba,\bu) \mathrel{\delta} t(\ba,\bv)\quad \iff \quad t(\bb,\bu) \mathrel{\delta} t(\bb,\bv),
\end{equation}
then we say that $S$ \defn{centralizes $T$ modulo} $\delta$ and we write 
$\CC{S}{T}{\delta}$.
That is, $\CC{S}{T}{\delta}$  means that 
(\ref{eq:22}) holds \emph{for all}
$\ell$, $m$, $t$, $\ba$, $\bb$, $\bu$, $\bv$ satisfying properties (i)--(iii).

The \defn{commutator} of $S$ and $T$, denoted by $[S, T]$,
is the least congruence $\delta$ such that $\CC{S}{T}{\delta}$ 
holds.  
Note that $\CC{S}{T}{0_A}$ is equivalent to $[S,T] = 0_A$, and this
is sometimes called the \defn{$S, T$-term condition};
when it holds we say  that
$S$ \defn{centralizes} $T$. %% , and write $\C{S}{T}$.
A tolerance $T$ is called \defn{abelian} if
%% $\C{T}{T}$ (i.e., $[T, T] = 0_A$).  
$[T, T] = 0_A$.  
An algebra $\bA$ is called \defn{abelian} if $1_A$ is abelian
(i.e., $[1_A,1_A] = 0_A$).

%% \begin{rem}
%%   An algebra $\bA$ is abelian iff %$\C{1_A}{1_A}$ iff
%%   \[
%%   \forall \ell, m \in \N,
%%   \quad \forall t\in \sansClo_{\ell + m}(\bA),
%%   \quad \forall (\ba, \bb)\in A^\ell\times A^\ell,
%%   \]
%%   \[
%%   \ker t(\ba, \cdot)=\ker t(\bb, \cdot).
%%   \]
%% \end{rem}

%% wjd: deleting the iterated commutator stuff (I don't think we need it)
%% It is sometimes useful to iterate the commutator, for example,
%% $[[\alpha, \alpha], [\alpha, \alpha]]$, and for this purpose
%% we define $[\alpha]^n$ recursively as
%% follows:
%% $[\alpha]^0 = \alpha$ and
%% $[\alpha]^{n+1} = [[\alpha]^n, [\alpha]^n]$.  A congruence $\alpha$ of $\bA$
%% is called \defn{solvable} if $[\alpha]^n = 0_A$ for some $n$.


Here are some properties of the centralizer relation
that are well-known and not too hard to prove
(see \cite[Prop~3.4]{HM:1988} or~\cite[Thm~2.19]{MR3076179}).
\begin{lem}
\label{lem:centralizers}
Let $\bA$ be an algebra and suppose
$\bB$ is a subalgebra of $\bA$. 
Let $\alpha$, $\beta$, $\gamma$, $\delta$, $\alpha_i$
$\beta_j$, $\gamma_k$
be congruences of $\bA$, for all 
$i \in I$, $j\in J$, $k \in K$. Then the following hold:
\begin{enumerate}
\item \label{centralizing_over_meet}
  $\CC{\alpha}{\beta}{\alpha \meet \beta}$;
\item \label{centralizing_over_meet2}
  if $\CC{\alpha}{ \beta}{ \gamma_k}$ for all $k \in K$, then
  $\CC{\alpha}{ \beta}{ \Meet_{K}\gamma_k}$;
\item \label{centralizing_over_join1}
  if $\CC{\alpha_i}{ \beta}{ \gamma}$ for all $i\in I$, then
  $\CC{\Join_{I}\alpha_i}{ \beta}{\gamma}$;
\item \label{monotone_centralizers1}
  if $\CC{\alpha}{ \beta}{ \gamma}$ and $\alpha' \leq \alpha$, then 
  $\CC{\alpha'}{ \beta}{ \gamma}$;
\item \label{monotone_centralizers2}
  if $\CC{\alpha}{ \beta}{ \gamma}$ and $\beta' \leq \beta$, then
  $\CC{\alpha}{ \beta'}{ \gamma}$;
\item \label{centralizing_over_subalg}
  if $\CC{\alpha}{ \beta}{ \gamma}$ in $\bA$, 
  then $\CC{\alpha\cap B^2}{ \beta\cap B^2}{\gamma\cap B^2}$ in $\bB$;
\item \label{centralizing_factors}
  if $\gamma \leq \delta$, then $\CC{\alpha}{ \beta}{ \delta}$
  in $\bA$ if and only if $\CC{\alpha/\gamma}{ \beta/\gamma}{ \delta/\gamma}$
  in $\bA/\gamma$.
\end{enumerate}
\end{lem}


\begin{rem}
By (\ref{centralizing_over_meet}), 
if $\alpha \meet \beta = 0_{A}$,  
then %$\C{\beta}{\alpha}$ and $\C{\alpha}{\beta}$.
$[\beta, \alpha] = 0_A = [\alpha, \beta]$.
\end{rem}

% \draftsecskip
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% \subsection{The commutator}
%% \label{sec:facts-about-comm}
Before proceeding, we collect some facts about the commutator that are
sometimes useful when reasoning about difference terms.


\begin{lem}
  \label{lem:monotone-comm}
  Let $\bA$ be an algebra
  with congruences
  $\alpha$, $\alpha'$, $\beta$, $\beta'$ satisfying
  $\alpha\leq \alpha'$ and $\beta \leq \beta'$.
  Then $\comm \alpha \beta {\leq} \comm {\alpha'} {\beta'}$.
\end{lem}
\begin{proof}
  For every $\delta \in \Con\bA$, $\CC{\alpha'}{\beta'}{\delta}$ implies
  $\CC{\alpha}{\beta}{\delta}$, since $\alpha\leq \alpha'$ and $\beta \leq \beta'$.
  In particular, $\CC{\alpha'}{\beta'}{[\alpha', \beta']}$ implies
  $\CC{\alpha}{\beta}{[\alpha', \beta']}$, so
  $\comm \alpha \beta {\leq} \comm {\alpha'} {\beta'}$.
\end{proof}



\begin{lem}
  \label{lem:complete-meet-join-monotone}
Let $\bA$ be an algebra with congruences
$\alpha_i$ and 
$\beta_i$ %% $\gamma_k$
%% are congruences of $\bA$, 
for all $i \in I$.
Then
\[
\comm {\Meet \alpha_i} {\Meet \beta_i} {\leq}
\Meet \comm {\alpha_i} {\beta_i}
\quad \text{ and } \quad
\Join \comm {\alpha_i} {\beta_i} {\leq}
\comm {\Join \alpha_i} {\Join \beta_i}.
\]
\end{lem}

\begin{proof}
  By Lemma~\ref{lem:monotone-comm}, $\comm {\Meet \alpha_i} {\Meet \beta_i} {\leq}
  \comm {\alpha_i} {\beta_i} {\leq} \comm {\Join \alpha_i} {\Join \beta_i}$,
  for all $i \in I$.
\end{proof}

%% We will apply the preceding result in a simple special case involving
%% just four congruences; we record this version of the result for convenience.
%% %% (delete the corollary later)
%% \begin{cor}
%%   \label{cor:facts-about-comm-1}
%% Let $\bA$ be an algebra with congruences
%% $\alpha$, $\beta$, $\gamma$, $\delta$.  Then,
%% \[
%% \comm {\alpha \meet \gamma} {\beta \meet \delta} {\leq}
%% \comm \alpha \beta \meet \comm \gamma \delta
%% \quad \text{ and } \quad
%% \comm \alpha \beta \join \comm \gamma \delta {\leq}
%% \comm {\alpha \join \gamma} {\beta \join \delta}.
%% \]
%% \end{cor}



\begin{lem}[\protect{\cite[Theorem 2.10]{MR1358491}}]
\label{lem:hom-image-diff-term}
  Let $\bA$ and $\bB$ be algebras of the same similarity type and suppose
  $\phi: \bA \to \bB$ is a surjective homomorphism.  If
  $\alpha, \beta \in \Con \bA$, then
  $\phi([\alpha, \beta]) \subseteq [\phi(\alpha), \phi(\beta)]$.
  Moreover, if there exists a homomorphism $\psi: \bB \to \bA$ such that
  $\phi \circ \psi = \id_B$ and if $\rho, \sigma \in \Con \bB$, then
 $\psi^{-1} \{[\psi(\rho), \psi(\sigma)]\} = \phi\bigl( [\psi(\rho), \psi(\sigma)]\bigr)
  = [\rho, \sigma]$.
\end{lem}

%% \noindent {\bf Notation.}
%% Before continuing, we highlight a notational convention that we
%% use below.
We conclude this section by describing a very convenient notational convention.
The commutator, $[\theta, \theta]$, of a congruence with
itself, appears so often in the sequel that we will abbreviate it as
follows:\footnote{This is similar to the standard notational convention
  for the iterated commutator:
  \[
    [\theta]^0 =  \theta, \quad
    [\theta]^1 =  [\theta, \theta],  \quad
    [\theta]^2 =  \bigl[[\theta, \theta],[\theta, \theta]\bigr],  \; \dots, \;
    [\theta]^n =  \bigl[[\theta]^{n-1}, [\theta]^{n-1}\bigr], \; \dots.
    \]
}
\[
\lb \theta\rb:= [\theta, \theta].
\]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Equivalent conditions for existence of a difference term}
\label{sec:equiv-cond-exist}
The main result proved in this section is Theorem~\ref{thm:F}, which 
is a slightly improved version of the observation
%% We won't use anything in this subsection
%% when proving the main result of this paper; nonetheless, we include it since
%% this result may be of independent interest.
%% Let $\sV$ be a variety.  
in~\cite{MR1358491}
%% In that paper, Kearnes observed that
%% a locally finite variety has a difference term
%% iff it has a Taylor term and no type-2 tails.
%% Let $\sV$ be a variety and let $\bF = \bF_{\sV}(2)$ denote the 2-generated
%% free algebra in $\sV$.
%% Then the assumption that $\sV$ be locally finite can be weakened
%% to the hypothesis that $\bF$ is finite. This was observed in~\cite{MR1358491} 
%% by showing that 
stating that a variety $\sV$ has a difference term if and only if
$\sansH \sansS \sansP(\bF_{\sV}(2))$ 
has a difference term.
%% (where $\bF_{\sV}(2)$ denotes the 2-generated free algebra in $\sV$).
The forward implication of this claim is trivial;
the argument for the converse goes as follows:
assume that $d(x, y, z)$ is a difference term for $\sansH \sansS \sansP(\bF)$.
Choose $\bA \in \sV$ and $a, b \in A$. Let $\bB = \Sg^{\bA} (\{a, b\})$.
Since $\bB$ is 2-generated, $B \in \sansH \sansS \sansP (\bF)$.
Hence $d(x, y, z)$ interprets as a difference term in $\bB$. This means that
$d^{\bA} (a, a, b) = d^{\bB} (a, a, b) = b$.
Furthermore,
\[
d^{\bA} (a, b, b) = d^{\bB} (a, b, b)
%% \mathrel{[\Cg^{\bB} (a, b), \Cg^{\bB} (a, b)]}
\comr{\Cg^{\bB} (a, b)}
a.
\]
But
%% $[\Cg^{\bB} (a, b), \Cg^{\bB} (a,b)]\subseteq [\theta, \theta]$
$\com{\Cg^{\bB} (a, b)} \subseteq \com{\theta}$
for any congruence
$\theta \in \Con \bA$ for which $(a, b) \in \theta$. Consequently
$d^{\bA} (a, b, b)
%% \mathrel{[\theta, \theta]}
\comr{\theta}
a$ as desired.

Considering the goal of our project, it seems natural
to begin by trying to prove that the existence of a difference term for
 $\sV$ is equivalent to the  existence  of a difference term
operation for a specific algebra in $\sV$.  This is achieved in
Theorem~\ref{thm:F}, which will play a key role
in our main complexity argument in Section~\ref{sec:glob-local-diff}.
First, a lemma the forms the core of our proof of 
Theorem~\ref{thm:F} is the following:

\begin{lemma}
  \label{lem:equiv-cond-exist-1}
  Let $\bA$ be an algebra, let $t(x,y,z)$ be a ternary term in the langauge
  of $\bA$, and let $\bF := \bF_{\bbV(\bA)}(x,y)$. Consider the following statements:
  \begin{enumerate}[(A)]
  \item \label{item:6} $t^{\bA}$ is not a difference term operation for $\bA$.
  \item \label{item:7} There exists a 2-generated subalgebra $\bB \leq \bA$
    such that $t^{\bB}$ is not a difference term operation for $\bB$.
  \item \label{item:8} $t^{\bF}$ is not a difference term operation for $\bF$.
  \end{enumerate}
  Then (\ref{item:6}) implies (\ref{item:7}) and (\ref{item:7}) implies (\ref{item:8}).
\end{lemma}
\begin{proof}
  (\ref{item:6}) $\Rightarrow $ (\ref{item:7}):
  Suppose  $t^{\bA}$ fails to be a difference term operation for $\bA$ and let $a, b \in
  A$ witness this failure. That is, either
  \begin{enumerate}
  \item\label{item:9} $d^{\bA}(a,a,b) \neq b$, or
  \item\label{item:10} $(d^{\bA}(a,b,b), a) \notin \com{\Cg^{\bA} (a, b)}$.
  \end{enumerate}
  Let $\bB = \Sg^{\bA} (\{a, b\})$.  In case
  (\ref{item:9}), 
  $d^{\bB}(a,a,b) = d^{\bA}(a,a,b) \neq b$, so $d^{\bB}(x,y,z)$ is not a difference
  term operation for $\bB$.
  In case (\ref{item:10}), observe that
  $(d^{\bB}(a,b,b), a) = (d^{\bA}(a,b,b), a)\notin \com{\Cg^{\bA} (a, b)}$.
  Therefore, if
  \begin{equation}
    \label{eq:6}
    \com{\Cg^{\bB} (a, b)} \subseteq \com{\Cg^{\bA} (a, b)},
  \end{equation}
  then it will follow that $(d^{\bB}(a,b,b), a) \notin \com{\Cg^{\bB} (a, b)}$,
  whence $d^{\bB}(x,y,z)$ is not a difference term operation for $\bB$.
  %% \begin{equation}
  %%   \label{eq:6}
  %%   by observing that $\com{\Cg^{\bB} (a, b)} \subseteq \com{\Cg^{\bA} (a, b)}$.
  %%   (d^{\bB}(a,b,b), a) \notin \com{\Cg^{\bB} (a, b)}
  %% \end{equation}
  Inclusion~(\ref{eq:6}) holds because 
  $\CC{\beta}{\beta}{\delta}$ holds when
  $\beta := \Cg^{\bB} (a, b)$ and
  %% $\delta:=\restr{\com{\Cg^{\bA} (a, b)}}{B^2}$,
  $\delta:=\com{\Cg^{\bA} (a, b)} \cap B^2$.
  (See Appendix~\ref{sec:details-omitted-from} for details.)\\[5pt]
  (\ref{item:7}) $\Rightarrow$ (\ref{item:8}):
  Since there is a surjective homomorphism from $\bF$ to $\bB$,
  Lemma~\ref{lem:hom-image-diff-term} implies that $d^{\bF}(x,y,z)$ 
  is not a difference term operation for $\bF$.
\end{proof}

\smallskip

%% Cliff's comment:
%% F is a subalgebra of A^n for some n. We can assume that V is neither congruence
%% modular nor meet-semidistributive. Can we use that fact to put a  bound on n?
%% (On the face of it, all we know is that n < a^2 where a is the cardinality of A.) 

%{sec:algor-2:-exist}.
%% by establishing the equivalence of item (iii) in the following theorem.
%% \pagebreak[1]

\begin{thm}
  \label{thm:F}
Let $\sV$ be a variety and $\bF = \bF_{\sV}(2)$, the 2-generated
free algebra in $\sV$. The following are equivalent:
\begin{enumerate}[(i)]
\item \label{item:1}
  $\sV$ has a difference term;
\item \label{item:2}
  $\sansH \sansS \sansP (\bF)$ has a difference term;
\item \label{item:3}
  $\bF$ has a difference term operation.
\end{enumerate}
\end{thm}
\begin{proof}
  The implications
  (\ref{item:1}) $\Rightarrow$  (\ref{item:2}) $\Rightarrow$  (\ref{item:3}) are
  obvious. We prove
  (\ref{item:3}) $\Rightarrow$  (\ref{item:1}) by contraposition.
  Suppose $\sV$ has no difference term and let
  %% (We show $\bF$ has no difference term operation.)
  $d(x,y,z)$ be an arbitrary ternary term in the language of $\sV$.
  Let $\bA\in \sV$ be such that $d^{\bA}(x,y,z)$ is not a difference term
  operation for $\bA$. Then by Lemma~\ref{lem:equiv-cond-exist-1}, $d^{\bF}(x,y,z)$ 
  is not a difference term operation for $\bF$.
  %% Since $d(x,y,z)$ is arbitrary, it follows that
  %% $\bF$ has no difference term operation whatsoever.
  %% , as we set out to prove.
\end{proof}


\draftsecskip


\section{Local difference terms}
\label{sec:local-diff-terms}
In~\cite{MR3239624},
Valeriote and Willard define %% an \defn{$\bA$-triple for $\bp$}
%% to be a triple $(a,b,i)$ such that $a, b \in A$ and
%% $p_i(a,b,b) = p_{i+1}(a,a,b)$. They use this to define 
a ``local Hagemann-Mitschke sequence'' which they use as the basis of
an efficient algorithm for deciding for a given $n$ whether an idempotent
variety is $n$-permutable. 
Inspired by that work, we devise a similar construct, called
a ``local difference term,'' that we use to develop a polynomial-time
algorithm for deciding the existence of a difference term operation.
%% , given a finite idempotent algebra $\bA$, whether the variety
%% generated by $\bA$ has a difference term.



Let $\bA=\< A, \dots\>$ be an algebra, fix $a, b \in A$ and
$i \in \{0,1\}$.
%% An \defn{$\bA$-local difference term for
A \defn{local difference term for
  $(a,b,i)$} is a ternary term $d$ satisfying the following:
\begin{align}
%% \text{ if $i=0$, then } & a \comm{\Cg^{\bA}(a,b)}{\Cg^{\bA}(a,b)} d(a,b,b); \label{eq:diff-triple}\\
\text{ if $i=0$, then } & a \comr{\Cg(a,b)} d(a,b,b); \label{eq:diff-triple}\\
\text{ if $i=1$, then } &d(a,a,b) = b. \nonumber
\end{align}
If $d$ satisfies~(\ref{eq:diff-triple}) for all triples
in some subset $S\subseteq A \times A \times \{0,1\}$, then we call $d$
a \defn{local difference term for $S$}.

Let 
$\sS = A \times A \times \{0,1\}$ and
suppose that every pair
$((a_0, b_0, \chi_0), (a_1, b_1, \chi_1))$
in $\sS^2$ has a local difference term.
That is, for each pair $((a_0, b_0, \chi_0), (a_1, b_1, \chi_1))$, there exists
$d$ such that for each $i \in \{0,1\}$ we have
\begin{align}
  a_i \comr{\Cg(a_i,b_i)} d(a_i,b_i,b_i), & \;
  \text{ if $\chi_i=0$, and }  \label{eq:d-trip-i1}\\
  d(a_i,a_i,b_i) =b_i, & \;
  \text{ if $\chi_i=1$.}\label{eq:d-trip-i2} %\\\nonumber
\end{align}
Under these hypothesis we will prove that every subset $S\subseteq \sS$
has a local difference term.
That is, there is a single term $d$ that works (i.e., satisfies
(\ref{eq:d-trip-i1}) and (\ref{eq:d-trip-i2})) for all $(a_i, b_i, \chi_i) \in S$.
The statement and proof of this new result follows.

\begin{thm} %[\protect{cf.~\cite[Theorem 2.2]{MR3239624}}]
  \label{thm:local-diff-terms}
  Let $\sV$ be an idempotent variety and
  $\bA \in \sV$. Define
  $\sS= A \times A \times \{0,1\}$
  and suppose that every pair
  $((a_0, b_0, \chi_0), (a_1, b_1, \chi_1)) \in \sS^2$
  has a local difference term.
  Then every subset $S \subseteq \sS$,
  has a local difference term.
\end{thm}
\begin{proof}
The proof is by induction on the size of $S$.  In the base case, $|S| = 2$,
the claim holds by assumption.
Fix $n\geq 2$ and assume that every subset of $\sS$ of size $2\leq k \leq n$ has a local
difference term. Let
\[
S = \{(a_0, b_0, \chi_0), (a_1, b_1, \chi_1), \dots, (a_{n}, b_{n},\chi_{n})\} \subseteq \sS,\]
so that $|S| = n+1$.  We prove $S$ has a local difference term.

Since $|S| \geq 3$ and $\chi_i \in \{0,1\}$ for all $i$, there must exist
indices $i\neq j$ such that $\chi_i = \chi_j$. Assume without loss of generality
that one of these indices is $j=0$.  Define
the set
$S' = S \setminus \{(a_0, b_0, \chi_0)\}$.
Since $|S'| < |S|$, the set $S'$ has a local difference term $p$.
We split the remainder of the proof into two cases.
%% In the first case $\chi_0 = 0$ and in the second $\chi_0 = 1$.

\vskip3mm

%--------------------------------------
\noindent \underline{Case $\chi_0 = 0$}:
Without loss of generality, suppose that $\chi_1 = %% \chi_2 =
\cdots =\chi_k = 1$,
and $\chi_{k+1} %% = \chi_{k+2} 
= \cdots = \chi_{n} = 0$. Define %% $T$ to be the set
\[T = \{(a_0, p(a_0, b_0, b_0), 0),
(a_1, b_1, 1), (a_2, b_2, 1), 
\dots, (a_k, b_k, 1)\},\] and 
note that $|T| < |S|$.
Let $t$ be a local difference term for $T$.
Define
\[
d(x,y,z) = t(x, p(x,y,y), p(x,y,z)).
\]
We show that $d$ is a local difference term for $S$.
Since $\chi_0 =0$, we first verify that
$(a_0, d(a_0,b_0,b_0))$ belongs to $\com{\Cg(a_0,b_0)}$.
Indeed,
\begin{equation}
    \label{eq:100000}
  d(a_0,b_0,b_0) =
  %% t(a_0, p(a_0,b_0,b_0), p(a_0,b_0,b_0))\comr{\tau} a_0,
  t(a_0, p(a_0,b_0,b_0), p(a_0,b_0,b_0))\comr{\Cg(a_0, p(a_0,b_0,b_0))} a_0.
\end{equation}
%% where we have used $\tau$ to denote $\Cg(a_0, p(a_0,b_0,b_0))$.
Note that
\[(a_0, p(a_0,b_0,b_0)) = (p(a_0,a_0,a_0), p(a_0,b_0,b_0)) \in \Cg(a_0, b_0),\]
%% $(a_0, p(a_0,b_0,b_0))$ is equal to $(p(a_0,a_0,a_0), p(a_0,b_0,b_0))$ which 
%% belongs to $\Cg(a_0, b_0)$,
so $\Cg(a_0, p(a_0,b_0,b_0))\leq \Cg(a_0,b_0)$. Therefore,
%% so $\tau\leq \Cg(a_0,b_0)$. Therefore,
by monotonicity of the commutator we have
$\com{\Cg(a_0, p(a_0,b_0,b_0))} \leq \com{\Cg(a_0,b_0)}$.
It follows from this and (\ref{eq:100000}) that
%% $d(a_0,b_0,b_0)\comm{\Cg(a_0,b_0)}{\Cg(a_0,b_0)} a_0$,
\[d(a_0,b_0,b_0)\comr{\Cg(a_0,b_0)} a_0,\]
as desired.

For the indices $1\leq i \leq k$ we have $\chi_i =1$, so we prove
$d(a_i,a_i,b_i) = b_i$ for such $i$. Observe,
\begin{align}
  d(a_i,a_i,b_i) &=
  t(a_i, p(a_i,a_i,a_i), p(a_i,a_i,b_i)) \label{eq:200000}\\
  &=t(a_i, a_i, b_i) \label{eq:200001}\\
  &=b_i. \label{eq:200002}
\end{align}
Equation~(\ref{eq:200000}) holds by definition of $d$,~(\ref{eq:200001})
because $p$ is an idempotent local difference term for
$S'$, and~(\ref{eq:200002}) because $t$ is a local difference term for $T$.

The remaining triples in our original set $S$
have indices satisfying $k<j\leq n$ and $\chi_j = 0$.
Thus, for these triples we want
$d(a_j,b_j,b_j)\comr{\Cg(a_j,b_j)} a_j$.
By definition,
\begin{equation}
  \label{eq:450000}
d(a_j,b_j,b_j) =t(a_j, p(a_j,b_j,b_j), p(a_j,b_j,b_j)).  
\end{equation}
Since $p$ is a local difference term for $S'$, %we have
the pair $(p(a_j,b_j,b_j), a_j)$ belongs to $[\Cg(a_j,b_j), \Cg(a_j,b_j)]$.
%% $(p(a_j,b_j,b_j), a_j)\in [\Cg(a_j,b_j), \Cg(a_j,b_j)]$.
This and 
(\ref{eq:450000}) imply
that 
$(d(a_j, b_j,b_j), t(a_j,a_j,a_j))$
belongs to
$\com{\Cg(a_j,b_j)}$.
Finally, by idempotence of $t$ we have
\[
d(a_j,b_j,b_j)\comr{\Cg(a_j,b_j)} a_j,\]
as desired.
\\[6pt]
%--------------------------------------
\underline{Case $\chi_0 = 1$}:
%% \\[4pt]
%% Assume $\chi_0 = 1$ and, 
Without loss of generality, suppose $\chi_1 = \chi_2 =\cdots =\chi_k = 0$,
and $\chi_{k+1} = \chi_{k+2} = \cdots = \chi_{n} = 1$. Define 
\[
T = \{(p(a_0, a_0, b_0), b_0, 1),
(a_1, b_1, 0), (a_2, b_2 0), \dots, (a_k, b_k, 0)\},
\]
and note that $|T| < |S|$.
Let $t$ be a local difference term for $T$ and
define
%% \[d(x,y,z) = t(p(x,y,z), p(y,y,z), z).\] 
$d(x,y,z) = t(p(x,y,z), p(y,y,z), z)$. 
Since $\chi_0 =1$, we want $d(a_0,a_0,b_0) = b_0$. By the definition of
$d$,
\begin{equation*}
  d(a_0,a_0,b_0) =
  t(p(a_0,a_0,b_0), p(a_0,a_0,b_0), b_0) =b_0.
\end{equation*}
The last equality holds since $t$ is a local difference term for $T$, thus,
for $(p(a_0, a_0, b_0), b_0, 1)$.

If $1\leq i \leq k$, then $\chi_i =0$, so for these indices we prove
that $(a_i, d(a_i,b_i,b_i))$ belongs to $\com{\Cg(a_i,b_i)}$.
Again, starting from the definition of $d$ and using idempotence of $p$, we have
%% \begin{equation}
%%   \label{eq:40000}
%%   d(a_i,b_i,b_i) =
%%   t(p(a_i,b_i,b_i), p(b_i,b_i,b_i), b_i)=
%%   t(p(a_i,b_i,b_i), b_i, b_i).
%% \end{equation}
\begin{align}
  d(a_i,b_i,b_i) &=
  t(p(a_i,b_i,b_i), p(b_i,b_i,b_i), b_i)   \label{eq:40000}\\
  &=t(p(a_i,b_i,b_i), b_i, b_i). \nonumber
\end{align}
Next, since $p$ is a local difference term for $S'$, we have
\begin{equation}
  \label{eq:50000}
  t(p(a_i,b_i,b_i), b_i, b_i)
 \comr{\Cg(a_i,b_i)}
 t(a_i, b_i, b_i).
\end{equation}
Since $t$ is a local difference term for $T$, hence for
$(a_i, b_i, b_i)$,  %% $(1\leq i \leq k)$,
we see that 
$t(a_i, b_i, b_i) \comr{\Cg(a_i,b_i)} a_i$.
Combining this with (\ref{eq:40000}) and (\ref{eq:50000}) yields
$d(a_i,b_i,b_i) \comr{\Cg(a_i,b_i)} a_i$,
as desired.

The remaining elements of our original set $S$
have indices $j$ satisfying $k<j\leq n$ and $\chi_j = 1$.
For these we want $d(a_j,a_j,b_j) = b_j$.
Since $p$ is a local difference term for $S'$, we have
$p(a_j,a_j,b_j) = b_j$, and this along with idempotence of $t$ yields
%%\[ d(a_j,a_j,b_j) =  t(p(a_j,a_j,b_j), p(a_j,a_j,b_j), b_j)=  t(b_j, b_j, b_j) =b_j,\]
\begin{align*}
d(a_j,a_j,b_j) &=
t(p(a_j,a_j,b_j), p(a_j,a_j,b_j), b_j)\\
&=t(b_j, b_j, b_j) =b_j,
\end{align*}
as desired.
\end{proof}

\begin{cor}
  \label{cor:loc-diff-term}
  A finite idempotent algebra $\bA$ has a difference term operation if and
  only if each pair $((a,b,i), (a',b',i')) \in (A\times A \times \{0,1\})^2$ has a local
  difference term.
\end{cor}
\begin{proof}
  One direction is clear, since a difference term operation for $\bA$ is
  obviously a local difference term for the whole set 
  $A\times A \times \{0,1\}$.
  For the converse, suppose
  each pair in $(A\times A \times \{0,1\})^2$ has a local
  difference term. Then, by Theorem~\ref{thm:local-diff-terms},
  there is a single local difference term for the whole set $A\times A \times \{0,1\}$,
  and this is a difference term operation for $\bA$.  Indeed, if $d$ is a
  local difference term for $A\times A \times \{0,1\}$, then 
  for all $a, b \in A$, we have
  $a \comr{\Cg(a,b)} d(a,b,b)$,
  since $d$ is a local difference term for $(a,b,0)$, and we have
  $d(a,a,b) = b$, since $d$ is also a local difference term for
  $(a,b,1)$.
\end{proof}

\draftsecskip

%% \subsection{Algorithm 1: existence of difference term operations}
%% In this subsection we prove the following:
\subsection*{Algorithm 1: existence of a difference term operation}
\begin{cor}
  \label{cor:algor-1}
  There is a polynomial-time algorithm that takes as input
  any finite idempotent algebra $\bA$ and decides whether
  %% the variety $\bbV(\bA)$ that it generates
  $\bA$ has a difference term operation.
\end{cor}
\begin{proof}
  %% and let  $\sV = \bbV(\bA)$.
  We describe an efficient algorithm for deciding,
  given a finite idempotent algebra $\bA$,
  whether every pair $((a,b,i), (a',b',i')) \in (A\times A \times \{0,1\})^2$ has a local
  difference term.  By Corollary~\ref{cor:loc-diff-term}, this will prove we
  can decide in polynomial-time whether $\bA$ has a difference term operation.
  %% We will then complete the
  %% proof by explaining why $\bA$ has a difference term operation iff the variety
  %% it generates has a difference term. 

  Fix a pair
  $((a,b,i), (a',b',i'))$ in $(A\times A \times \{0,1\})^2$. If $i = i' = 0$,
  then the first projection is a local difference term. If $i = i' = 1$,  
    then the third projection is a local difference term. The two remaining cases to
    consider are (1) $i = 0$ and $i'=1$, and (2)
    $i = 1$ and $i'=0$. Since these are completely symmetric, we only handle the
    first case. Assume  the given pair of triples is
    $((a,b,0), (a',b',1))$.  By definition, a term $t$ is local difference term
    for this pair iff
    \[
    a\comr{\Cg(a,b)} t^{\bA}(a,b,b) \; \text{ and } \;
    t^{\bA}(a',a',b') = b'.
    \]
    We can rewrite this condition more compactly by
    considering 
    \[t^{\bA\times \bA}((a,a'), (b,a'), (b,b')) =
    (t^{\bA}(a,b,b),t^{\bA}(a',a',b')).\]
    Clearly $t$ is a local difference term for
    $((a,b,0), (a',b',1))$ iff
    \[
    t^{\bA\times \bA}((a,a'), (b,a'), (b,b'))\in a/\delta \times \{b'\},
    \]
    where $\delta = \com{\Cg(a,b)}$ and $a/\delta$ denotes the
    $\delta$-class containing $a$.
    (Observe that $a/\delta \times \{b'\}$ is a subalgebra of $\bA \times \bA$
    by idempotence.)
    It follows that the pair
    $((a,b,0), (a',b',1))$ has a local difference term iff
    the subuniverse of $\bA\times \bA$ generated by
    $\{(a,a'), (b,a'), (b,b')\}$ intersects nontrivially with the subuniverse
    $a/\delta \times \{b'\}$.

    Thus, the algorithm takes as input $\bA$ and, for each 
    $((a,a'), (b,a'), (b,b'))$ in $(A\times A)^3$, computes
    $\delta = \com{\Cg(a,b)}$, computes the subalgebra
    $\bS$ of $\bA\times \bA$ generated by
    %% \Sg^{\bA\times \bA}\{(a,a'), (b,a'), (b,b')\}$, and then
    $\{(a,a'), (b,a'), (b,b')\}$, and then
    tests whether $S \cap (a/\delta \times \{b'\})$ is empty.
    If we find an empty intersection at any point, then
    $\bA$ has a difference term operation.
    Otherwise the algorithm halts without witnessing an empty
    intersection, in which case $\bA$ has a difference term operation.

    Most of the operations carried out by this algorithm are well known to be
    polynomial-time.  For example, that the running time of subalgebra generation is
    polynomial has been known for a long time (see~\cite{MR0455543}).
    The time complexity of congruence generation is also known to be polynomial
    (see~\cite{MR2470585}).  The only operation whose tractability might be 
    questionable is the commutator, but there is a straight-forward algorithm for
    computing it which, after the congruences have been computed, simply
    involves generating more subalgebras.
    %% Finally, we observe that if $\bA$ has a difference term operation, then the
    %% variety it generates has a difference term.
    \\\\
    TODO: insert more details about complexity of commutator.\\
\end{proof}


More details on the complexity of operations carried out by the algorithm, as well as many other algebraic operations, can be found in the references mentioned, as well as~\cite{MR1871085,MR1695293,Freese:2009}. 




%% \input{inputs/mix-loc-diff-terms.tex}

%%% NEW SECTION
\subsection{Mixed local difference terms}
\label{sec:mixed-local-diff}
In this section, we observe that the proofs in the previous section
did not hinge on the fact that we only considered a single algebra.  
Let $\sV$ be a variety and let $\bA_0=\< A_0, \dots\>$ and  $\bA_1=\< A_1, \dots\>$ be
algebras in $\sV$.
The direct sum (or coproduct) of $\bA_0$ and
$\bA_1$ is denoted by $\bA_0 + \bA_1$
(or by $\coprod_{i=0}^1 \bA_i$, especially when there are more than two
factors).
An element of (the universe of)
$\bA_0 + \bA_1$ is often denoted by $\<a, i\>$,
where $i\in \{0,1\}$ and $a \in A_i$.
The (universe of the) coproduct %% $\coprod_{i=0}^1 (\bA_i\times \bA_i)$ has elements
$\bA_0^2 + \bA_1^2$ has elements
$\<(a,b), i\>$ where $i\in \{0,1\}$ and $(a,b) \in A_i^2$.
An element of  the set $(A_0^2 + A_1^2) \times \{0,1\}$---and
now the notation has already become a bit unwieldy---has
the form $(\<(a,b), i\>, \chi)$, where $i\in \{0,1\}$, $(a,b) \in A_i^2$,
and $\chi\in \{0,1\}$. 

Fix two elements $(\<(a, b),i\>, \chi)$ and $(\<(a', b'),i'\>, \chi')$ of the
set $(A_0^2 + A_1^2) \times \{0,1\}$.
By a \defn{mixed local difference term} for this pair
we mean a ternary term $d$ satisfying both
\begin{align}
\text{ if $\chi=0$, then } & a \comr{\Cg^{\bA_i}(a,b)} d^{\bA_i}(a,b,b); \label{eq:mixed-diff-triple}\\
\text{ if $\chi=1$, then } &d^{\bA_i}(a,a,b) = b; \nonumber
\end{align}
and the same set of relations with $a$, $b$, $i$, $\chi$ replaced 
by $a'$, $b'$, $i'$, $\chi'$, respectively.

Let $S$ be a sequence of triples drawn from the set
\[
\sU(A_0, A_1)  := (A_0^2 + A_1^2) \times \{0,1\}.
\]
If $d$ satisfies~(\ref{eq:mixed-diff-triple}) for all triples in $S$.
then we call $d$ is a \defn{mixed local difference term for $S$}.
We may use $\sU$ to denote the set $\sU(A_0, A_1)$ when the context renders the
universes involved obvious or immaterial.

Now, suppose that all pairs of triples 
in $\sU$ have mixed local difference terms.
Under this hypothesis the same argument that we used to prove
Theorem~\ref{thm:local-diff-terms} above can be used to prove that, for every $n$,
%% and every sequence $S\in \sU^n$, there is a term $d$ that is a mixed local
%% difference term for $S$.
every sequence $S\in \sU^n$ has a mixed local difference term.
That is, there is a single term $d$ that works (i.e., satisfies
the relations (\ref{eq:mixed-diff-triple})) for all $(\<(a, b), i\>,\chi)$ in $S$.
Here is the full statement of this slightly more general version of
Theorem~\ref{thm:local-diff-terms}.
From now on we drop the ``mixed'' qualifier since
it is inconsequential.

\begin{thm} %[\protect{cf.~\cite[Theorem 2.2]{MR3239624}}]
  \label{thm:mixed-local-diff-terms}
  Let $\sV$ be an idempotent variety and let
  $\bA_0 = \<A_0, \dots\>$ and   $\bA_1 = \<A_1, \dots\>$ be algebras in $\sV$. Define
  $\sU  = (A_0^2 + A_1^2)\times \{0,1\}$
  and suppose that every pair
  $((\<(a, b), i\>, \chi), (\<(a', b'), i'\>\chi')) \in \sU^2$
  has a local difference term. Then, for every $n$, every sequence $S \in \sU^n$
  has a local difference term.
\end{thm}

Corollary~\ref{cor:loc-diff-term} also generalizes, as follows:
\begin{cor}
  \label{cor:mix-loc-diff-term}
  Let $\sV$ be an idempotent variety and let
  $\bA_0 = \<A_0, \dots\>$ and   $\bA_1 = \<A_1, \dots\>$ be algebras in $\sV$. Define
  $\sU  = (A_0^2 + A_1^2)\times \{0,1\}$
  and suppose that every pair
  $((\<(a, b), i\>, \chi), (\<(a', b'), i'\>\chi')) \in \sU^2$
  has a local difference term. Then, there is a term $d$ that interprets as a
  difference term operation for both $\bA_0$ and $\bA_1$.
\end{cor}
%% Corollary~\ref{cor:loc-diff-term} also generalizes, as follows:
%% \begin{cor}
%%   \label{cor:mix-loc-diff-term}
%%   Let $\scA = \{\<A_i, \dots\> \mid i \in I\}$ be a collection of finite
%%   idempotent algebras. Then there exists a term $d$ that interprets as a
%%   difference term operation in every $\<A_i, \dots\> \in \scA$ if and only if each pair
%%   $((\<(a_i,b_i),\iota_i\>,\chi_i),  (\<(a_j,b_j),\iota_j\>,\chi_j))$ in
%%   $\bigl(\coprod_{i \in I} A_i^2\times \{0,1\}\bigr)^2$
%%   % \[\bigl(\coprod_{i \in I} (A_i^2\times \{0,1\})\bigr)
%%   %   \times \bigl(\coprod_{i \in I} (A_i^2\times \{0,1\})\bigr),\]
%%   has a local difference term.
%% \end{cor}





\subsection{Local difference terms on universes}
\label{sec:glob-local-diff}
The methods from earlier sections can be lifted up to work globally---that is,
on universes rather than elements---as we now explain. 
Let $\sV$ be a variety, let $\bA = \<A, \dots\> \in \sV$ 
and $i\in \{0,1\}$.
We call a term $d$ a \defn{local difference term
for $(A, i)$}
provided $d$ is a local difference term for every triple
$(a,b,i) \in A \times A \times \{i\}$. That is, for all $a, b \in A$,
\begin{align}
\text{ if $i=0$, then } & \, a \comr{\Cg^{\bA}(a,b)} d^{\bA}(a,b,b);
\label{eq:global-diff-triple}\\
\text{ if $i=1$, then } & \,
d^{\bA}(a,a,b) = b. 
\end{align}

Let $\sV$ be a variety and let $\scA$ be a collection of algebras that belong to $\sV$.
Let $\scS(\scA)$ be the collection of all pairs $(A, i)$ where $A$ is the universe
of some algebra in $\scA$ and $i\in \{0,1\}$.  That is,
\[
\scS(\scA) = \{(A, i) \mid \<A, \dots\> \in \scA \text{ and } i \in \{0,1\}\}.
\]
Given a sequence
\[S = ((A_0, \chi_0), (A_1, \chi_1), \dots,
(A_{n-1},\chi_{n-1})) \in \scS(\scA)^n,
\]
(or a subset $S \subseteq \scS(\scA)$),
a term $d$ is called a \defn{\glocal difference term for $S$}
if it is a \glocal difference term for every pair $(A_i, \chi_i)$ in $S$.
In addition to these definitions, in the proof of the next theorem we use
$|S|$ to denote the \emph{length of the sequence $S$}
(or, in case $S$ is a set, then $|S|$ denotes the cardinality of $S$, as usual).
\begin{thm}
  \label{thm:glob-loc-diff-terms}
  Let $\sV$ be a variety.  Let $\scA$ be a collection of finite idempotent
  algebras in $\sV$. Fix $n\geq 2$ and 
  let $S= ((A_0, \chi_0), (A_1, \chi_1), \dots, (A_{n-1}, \chi_{n-1}))\in \scS(\scA)^n$.
  Then there exists a term that is a \glocal difference term for $S$
  if and only if each 2-element subsequence $((A_i,\chi_i), (A_j,\chi_j))$ of $S$
  has a \glocal difference term.
\end{thm}
We relegate the proof of Theorem~\ref{thm:glob-loc-diff-terms} 
to the appendix (see Section~\ref{sec:proof-thm:glob}), since the argument 
is nearly identical to the one used to prove Theorem~\ref{thm:local-diff-terms}. 

\begin{cor}
  \label{cor:glob-loc-diff-term}
  Let $\sV$ be a variety.  Let $\scA$ be a collection of finite idempotent
  algebras in $\sV$. %% that is closed under the taking of subalgebras.
  Then there exists a term $d$ that interprets as a difference term operation
  for every algebra in $\scA$
  if and only if each pair $((A,i), (B,j)) \in \scS(\scA)^2$ has a \glocal
  difference term.
\end{cor}
Since the proof of Corollary~\ref{cor:glob-loc-diff-term}
is easy and similar to the proof
of Corollary~\ref{cor:loc-diff-term}, we consign it to 
appendix Section~\ref{sec:proof-cor:glob}.

Before proceeding, recall the following fairly standard notation:
if $\alpha \in \Con(\bA)$ and $\beta \in \Con(\bB)$, then
$\alpha \times \beta$ denotes the set of pairs $((a,b),(a',b'))\in (A\times B)^2$ satisfying
$a \mathrel{\alpha} a'$ and $b \mathrel{\beta} b'$.  The relation 
$\alpha \times \beta$ is clearly a congruence of $\bA \times \bB$.

\pagebreak[1]
\begin{lem}
  \label{lem:products}
  Let $\sV$ be a variety and let $\bA$ and $\bB$ be finite idempotent
  algebras in $\sV$. Suppose the term $d$ 
  interprets as a difference term operation for $\bA\times \bB$.
  Then $d^{\bA}$ (resp., $d^{\bB}$) is a difference term operation for 
  $\bA$  (resp., $\bB$).
\end{lem}
\begin{proof}
  Assume that for all $(a, b)$ and $(a', b')$ in $A \times B$, the term $d$ satisfies
  \begin{align}
    d^{\bA \times \bB}((a, b), (a, b), (a', b')) &= (a', b'),\; \text{ and } \label{eq:60002}\\
    d^{\bA \times \bB}((a, b), (a', b'), (a', b'))
    &\comr{\Cg^{\bA \times \bB}((a, b), (a', b'))} (a, b). \label{eq:60003}
  \end{align}
  We prove that $d^{\bA}$ is a difference term operation
  for $\bA$. (Obviously, the proof for $\bB$ is identical.)
  Thus, fixing $a, a' \in A$, we will show 
  \begin{align}
    d^{\bA}(a, a, a') &= a',\; \text{ and } \label{eq:60004}\\
    d^{\bA}(a,a',a')
    &\comr{\Cg^{\bA}(a, a')} a. \label{eq:60005}
  \end{align}
  Equation (\ref{eq:60004}) is obvious by (\ref{eq:60002}),
  so we proceed to~(\ref{eq:60005}).
  Observe that 
  \[
  (d^{\bA}(a, a',a'), d^{\bB}(b, b',b'))
  \comr{\Cg^{\bA \times \bB}((a, b), (a', b'))} (a, b),
  \]
  by~(\ref{eq:60003}). Therefore, Lemma~\ref{lem:hom-image-diff-term}
  implies\footnote{The first projection 
    $\pi_A : \bA \times \bB \to \bA$ is a surjective 
    homomorphism, so 
  $\pi_A(\com{\theta}) \subseteq \com{\pi_A(\theta)}$
    for all $\theta \in \Con (\bA \times \bB)$,
    by Lemma~\ref{lem:hom-image-diff-term}. Recall, that
    $\pi_A$ is defined on a congruence $\theta \in \Con(\bA \times \bB)$ as follows:
    $\pi_A(\theta) := \{(a,a') \in A^2 \mid ((a,b),(a',b')) \in \theta \text{ for
      some $(b,b')\in B^2$}\}$.}
  \[
  (d^{\bA}(a, a',a'), a)\in \pi_A\bigl(\com{\Cg^{\bA \times \bB}((a, b), (a',
    b'))}\bigr)
  \subseteq \com{\pi_A\bigl(\Cg^{\bA \times \bB}((a, b), (a', b'))\bigr)}.
  \]
  Next, observe that 
  $\Cg^{\bA}(a,a') \times \Cg^{\bB}(b,b')$  %%  \in \Con(\bA \times \bB)$
  is a product of two congruences, one in $\Con(\bA)$ and the
  other in $\Con(\bB)$, so it is a congruence of $\bA\times \bB$.
  Moreover, it contains the pair $((a,b), (a',b'))$, so
  %% belongs to $\Cg^{\bA}(a,a') \times \Cg^{\bB}(b,b')$, 
  \[
  \Cg^{\bA \times \bB}((a, b), (a', b'))\leq \Cg^{\bA}(a,a') \times \Cg^{\bB}(b,b').
  \]
  Therefore, 
  \[
  \pi_A\bigl(\Cg^{\bA \times \bB}((a, b), (a', b'))\bigr)
  \leq
  \pi_A\bigl(\Cg^{\bA}(a,a') \times \Cg^{\bB}(b,b')\bigr) = 
  \Cg^{\bA}(a,a').
  \]
  Pulling all of these observations together and applying monotonicity of the
  commutator, we arrive at $d^{\bA}(a, a',a')  \comr{\Cg^{\bA}(a,a')} a$, as desired.
\end{proof}

The converse of Lemma~\ref{lem:products} is harder to prove.
\begin{lem}
  \label{lem:products-conv}
 Let $\sV$ be a variety and let $\bA$ and $\bB$ be finite idempotent
 algebras in $\sV$. Suppose there is a single term $d$ that
 interprets as a difference term operation for $\bA$ and for $\bB$.
 Then $d^{\bA \times \bB}$ is a difference term operation for the product
 $\bA \times \bB$.
\end{lem}
\begin{proof}
  Fix $(a, b)$ and $(a', b')$ in $A \times B$.
  We must prove
  \begin{align}
    d^{\bA \times \bB}((a, b), (a, b), (a', b')) &= (a', b'),\; \text{ and } \label{eq:60000}\\
    d^{\bA \times \bB}((a, b), (a', b'), (a', b'))
    &\comr{\Cg^{\bA \times \bB}((a, b), (a', b'))} (a, b). \label{eq:60001}
  \end{align}
  %% where $\theta:= \Cg^{\bA \times \bB}((a, b), (a', b'))$.
  Since $d^{\bA}$ and $d^{\bB}$ are difference term operations for $\bA$ and
  $\bB$, respectively, it's easy to see that~(\ref{eq:60000}) is satisfied:
  \[
  d^{\bA \times \bB}((a, b), (a, b), (a', b')) =
  (d^{\bA}(a, a, a'),  d^{\bB}(b, b, b')) = (a', b').
  \]
  It remains to check (\ref{eq:60001}).
  Again, since $d^{\bA}$ and
  $d^{\bB}$ are difference term operations,
  \begin{align*}
  d^{\bA}(a,a',a')
  &\comr{\Cg^{\bA}(a,a')} a\\
  d^{\bB}(b, b', b')
  &\comr{\Cg^{\bB}(b,b')} b.
  \end{align*}
  Therefore, the pair
  $\bigl((d^{\bA}(a,a',a'),d^{\bB}(b, b', b')), (a,b)\bigr)$ belongs
  to the relation
  \[
  \com{\Cg^{\bA}(a,a')}
  \times
  \com{\Cg^{\bB}(b,b')}.
  \]
  We claim that the latter is equal to
  $\com{\Cg^{\bA}(a,a') \times \Cg^{\bB}(b,b')}$.
  Recall from above that
  \[
  \Cg^{\bA \times \bB}((a, b), (a', b'))\leq \Cg^{\bA}(a,a') \times \Cg^{\bB}(b,b').
  \]
  Therefore, if we prove that
  \[
  \com{\Cg^{\bA}(a,a')}  \times  \com{\Cg^{\bB}(b,b')} = 
  \com{\Cg^{\bA}(a,a') \times \Cg^{\bB}(b,b')},
  \]
  then we could complete the proof by showing that
  \begin{equation}
    \label{eq:655}    
  \Cg^{\bA \times \bB}((a, b), (a', b'))\geq \Cg^{\bA}(a,a') \times \Cg^{\bB}(b,b').
  \end{equation}

  \smallskip

  TODO: (\ref{eq:655}) is false in general; maybe false here
  too; then we need a new idea.

  \medskip
  
  TODO: Prove Lemma~\ref{lem:products-conv} somehow!!!
  %% Therefore, by monotonicity of the commutator,
  %% (\ref{eq:60001}) holds.
  %% It remains to check the claim... 
\end{proof}


\subsection*{Algorithm 2: existence of a difference term}
%% \subsection{Algorithm 2: existence of difference terms}
%% \label{sec:algor-2:-exist}
%% In this subsection we prove the following
\begin{cor}
\label{cor:algor-2}
  There is a polynomial-time algorithm that takes as input
  any finite idempotent algebra $\bA$ and decides whether
  the variety $\bbV(\bA)$ that it generates
  has a difference term operation.
\end{cor}
\begin{proof}
  Let $\sV = \bbV(\bA)$ and let $\bF = \bF_{\sV}(x,y)$ be the free algebra in
  $\sV$ generated by $x$ and $y$.
  By Theorem~\ref{thm:F}, deciding whether $\sV$ has a difference term is equivalent to 
  deciding whether $\bF$ has a difference term operation.
  We can assume $\bF$ is a subdirect product of
  $\bA_0 \times \bA_1 \times \cdots \times \bA_{n-1}$, where $n\leq |A|^2$ and
  where each $\bA_i$ is a 2-generated subalgebra of $\bA$..
  Let $\scA = \{A_0, A_1, \dots, A_{n-1}\}$ and (as above) let $\scS(\scA)$ denote 
  all pairs $(A, i)$ such that $\bA = \<A, \dots\> \in \scA$ and $i\in \{0,1\}$.

  We begin by proving that we can check in polynomial time (in $|A|$)
  whether or not the product
  $\bA_0 \times \bA_1 \times \cdots \times \bA_{n-1}$ has a difference term operation.
  By Corollary~\ref{cor:glob-loc-diff-term} and~\ref{lem:products-conv}, it suffices to check that each of the
  $n^2$ pairs  in 
  $\scS(\scA)^2$ has a \glocal
  difference term.  Fix a pair
  $((A_i, \chi_i), (A_j, \chi_j)) \in  \scS(\scA)^2$,
  and let $\sU  = (A_i^2 + A_j^2)\times \{0,1\}$.
  By Theorem~\ref{thm:mixed-local-diff-terms},
  to prove that every sequence $S \in \sU^n$
  has a local difference term, it suffices to check that every pair
  $\bigl( (\<(a, b), i\>, \chi), (\<(a', b'), i'\>, \chi')\bigr) \in \sU^2$
  has a local difference term. It follows from the argument given 
  in the proof of Corollary~\ref{cor:algor-1} that the number of 
  operations required to check whether
  $\bigl( (\<(a, b), i\>, \chi), (\<(a', b'), i'\>, \chi')\bigr)$
  has a local difference term is bounded by a
  polynomial in $|A_i||A_j|\leq |A|^2$.  Since there are 
  $4|A_i|^2|A_j|^2 \leq 4|A|^4$ pairs in $\sU^2$, 
  it still takes only a polynomial in $|A|$ number of steps to test whether
  the pair $((A_i, \chi_i), (A_j, \chi_j))$ has a \glocal difference term.
  There are $n^2 \leq |A|^4$ such pairs to test, so the number of steps required to 
  test whether
  $\bA_0 \times \bA_1 \times \cdots \times \bA_{n-1}$ has a difference term
  operation is bounded by a constant times a power of $|A|$.
\end{proof}

\draftsecskip



\section*{Acknowledgments}
This research was supported by the National Science 
Foundation under Grant No. 1500235.

%% \renewcommand{\Cg}{\ensuremath{\operatorname{Cg}}}
%% \bibliographystyle{spmpsci}
%% \bibliographystyle{alphaurl}
\bibliographystyle{ws-ijac}
\bibliography{inputs/refs}


\draftsecskip



\appendix
\section{Proofs}
\subsection{Details omitted from proof of Lemma~\ref{lem:equiv-cond-exist-1}}
\label{sec:details-omitted-from}
We have $\bB \leq \bA$, $a, b \in B$, and we wish to prove
\begin{equation}
    \label{eq:6-app}
    \com{\Cg^{\bB} (a, b)} \subseteq \com{\Cg^{\bA} (a, b)}.
\end{equation}
Let $\alpha := \Cg^{\bA} (a, b)$, $\beta := \Cg^{\bB} (a, b)$ and
$\delta:=\com{\Cg^{\bA} (a, b)} \cap B^2$. 
To check~(\ref{eq:6-app}) we verify that $\CC{\beta}{\beta}{\delta}$.
Let $\bu$, $\bv \in B^{k}$, and $\br$, $\bs \in B^{\ell}$, and
$t\in \Clo_{k+\ell}(\bB)$.  Assume
$u_i \rbeta v_i$ and $r_i \rbeta s_i$
and $t(\bu, \br) \rdelta t(\bu, \bs)$.
We establish~(\ref{eq:6-app}) by proving that
$t(\bv, \br) \rdelta t(\bv, \bs)$.
Clearly,
$\beta \subseteq \alpha$, so 
$u_i \rbeta v_i$ and $r_i \rbeta s_i$ imply
$u_i \ralpha v_i$ and $r_i \ralpha s_i$.  Moreover,
\[
(t(\bu, \br), t(\bu, \bs)) \in
\delta \subseteq \alpha \quad \Rightarrow \quad
(t(\bv, \br), t(\bv, \bs)) \in \alpha.
\]
Finally, 
$(t(\bv, \br), t(\bv, \bs)) \in B^2$. Altogether, we have
$(t(\bv, \br), t(\bv, \bs)) \in \delta$, as desired.


\subsection{Proof of Theorem~\ref{thm:glob-loc-diff-terms}}
\label{sec:proof-thm:glob}
\begin{theorem}[\ref{thm:glob-loc-diff-terms}]
  Let $\sV$ be a variety.  Let $\scA$ be a collection of finite idempotent
  algebras in $\sV$. Fix $n\geq 2$ and 
  let $S= ((A_0, \chi_0), (A_1, \chi_1), \dots, (A_{n-1}, \chi_{n-1}))\in \scS(\scA)^n$.
  Then there exists a term that is a \glocal difference term for $S$
  if and only if each 2-element subsequence $((A_i,\chi_i), (A_j,\chi_j))$ of $S$
  has a \glocal difference term.
\end{theorem}
\begin{proof}
  One direction is clear; if $d$ is a \glocal difference term for every
  element $(A_i, \chi_i)$ of $S$, then  every pair $((A_i,\chi_i),
  (A_j,\chi_j))$ of elements of $S$ also has a \glocal difference
  term---namely, $d$.

  For the converse, suppose that
  for each pair $((A_i,\chi_i), (A_j,\chi_j))$ of elements of $S$ there exists a
  term $p_{ij}$ that is a \glocal difference term for both
  $(A_i,\chi_i)$ and $(A_j,\chi_j)$.
  We will prove by induction on the length of $S$ that
  %% , for every $n\geq 2$ every subsequence $S \in \scS(\scA)^n$
  there exists a term $d$ that is a \glocal difference term for every
  $(A_i, \chi_i)$ in $S$.

  In the base case, $n = |S| = 2$, the claim holds by assumption.
  Fix $n\geq 2$ and assume for every
  $2\leq k \leq n$ that every sequence in $\scS(\scA)^k$
  has a \glocal difference term. Let
  $S = ((A_0, \chi_0), (A_1, \chi_1), \dots, (A_{n},\chi_{n})) \in \scS(\scA)^{n+1}$.
  %% We prove there exists a term $d$ that is a \glocal difference term for every
  %% $(A_i, \chi_i)$ in $S$.
  We prove  $S$ has a \glocal difference term.

  Since $|S| \geq 3$ and $\chi_i \in \{0,1\}$ for all $i$, there must exist
  indices $i\neq j$ such that $\chi_i = \chi_j$. Assume without loss of generality
  that one of these indices is $j=0$.  Define the subsequence
  $S' = ((A_1, \chi_1), \dots,(A_{n},\chi_{n}))$ of $S$. %% \in \scS(\scA)^{n}$
  Since $|S'| = n$, the sequence $S'$ has a \glocal difference term $p$.
  Thus, for all $1\leq i \leq n$,
  for all $a, b\in A_i$  we have
  \begin{align*}
    \text{ if $\chi_i=0$, then } &
    a \comr{\Cg(a,b)} d(a,b,b);\\
    \text{ if $\chi_i=1$, then } &
    %% d^{\bB_i}(b,b,b') = b'.
    d(a,a,b) = b.
  \end{align*}
  We split the remainder of the proof into two cases.

\vskip3mm

%--------------------------------------
\noindent \underline{Case $\chi_0 = 0$:}
Without loss of generality, suppose that
$\chi_1 = \chi_2 = \cdots =\chi_k = 1$,
and
$\chi_{k+1} = \chi_{k+2} = \cdots = \chi_{n} = 0$.
Define
%% the set
%% \[P_0 = \{p(b, b', b')  \in B_0 \mid b, b' \in B_0\},\]
%% and let
\[
T = ((A_0, 0), (A_1, 1), (A_2, 1), \dots, (A_k, 1)).
\]
Note that $|T| < |S|$.
Let $t$ be a \glocal difference term for $T$.
We will prove that the term $d(x,y,z) = t(x, p(x,y,y), p(x,y,z))$
is a \glocal difference term for $S$.

The first element of $S$ is $(A_0, 0)$, so we need to show for all $a$, $b \in A_0$
that
\[
d(a,b,b) \comr{\Cg(a,b)} a.
\]
Fix $a, b \in A_0$.
By definition of $d$, and since
$t$ is a \glocal difference term for $(A_0, 0)$, we have
\begin{equation}
  \label{eq:100100}
  d(a,b,b) 
  =t(a, c, c)\comr{\Cg(a, c)} a,
\end{equation}
where $c = p(a,b,b)$.
Now, $(a, c) = (p(a,a,a), p(a,b,b)) \in \Cg(a, b)$, therefore,
$\Cg(a, c) \leq \Cg(a,b')$.
It follows from this and monotonicity of the commutator that
$\com{\Cg(a, c)} \leq \com{\Cg(a,b)}$,
This and~(\ref{eq:100100}) imply
$d(a,b,b)\comr{\Cg(a,b)} a$,
as desired.

Next, consider the (possibly empty) set of indices $\{i \mid 1\leq i \leq k\}$.
For such indices $\chi_i =1$, so we will prove
for all $a$, $b \in A_i$ that $d(a,a,b) = b$.
Fix $a, b \in A_i$ and observe that
\begin{align}
  %% d^{\bB_i}(b,b,b') &=
  d(a,a,b) &=
  t(a, p(a,a,a), p(a,a,b)) \label{eq:210200}\\
  &=t(a,a,b) \label{eq:220201}\\
  &=b. \label{eq:230202}
\end{align}
Equation~(\ref{eq:210200}) holds by definition of $d$,~(\ref{eq:220201})
because $p$ is an idempotent \glocal difference term for
$S'$, and~(\ref{eq:230202}) because $t$ is a \glocal difference term for $T$.

The indices of the remaining elements of $S$
belong to the set $\{j \mid k<j\leq n\}$ (which is nonempty since we
assumed $\chi_0 = \chi_i = 0$ for some $i>0$).
For such indices we have $\chi_j = 0$.
Thus, fixing $a, b \in A_j$, we check that
$d(a,b,b)\comr{\Cg(a,b)} a$.
%% Fix $a, b \in A_j$. 
By definition,
\begin{equation}
  \label{eq:451}
%% d^{\bA_j}(a,b,b) =t^{\bA_j}(a, p^{\bA_j}(a,b,b), p^{\bA_j}(a,b,b)).  
d(a,b,b) =t(a, p(a,b,b), p(a,b,b)).  
\end{equation}
Also, $p(a,b,b) \comr{\Cg(a,b)} a$,
since $p$ is a \glocal difference term for $S'$.
%% $(p(a,b,b), a)\in [\Cg(a,b), \Cg(a,b)]$.
This and (\ref{eq:451}) imply
that
%% $(d(a, b,b), t(a,a,a))$ belongs to $\com{\Cg(a,b)}$.
$d(a, b,b) \comr{\Cg(a,b)} t(a,a,a))$.
Finally, by idempotence of $t$ we have
$d(a,b,b)\comr{\Cg(a,b)} a$,
as desired.
\\[6pt]
%--------------------------------------
\underline{Case $\chi_0 = 1$:}
Without loss of generality, suppose $\chi_1 = \chi_2 =\cdots =\chi_k = 0$,
and $\chi_{k+1} = \chi_{k+2} = \cdots = \chi_{n} = 1$.
%% Define the set
%% \[P_1 = \{p(b, b', b')  \in B_0 \mid b, b' \in B_0\},\]
Define
\[
T = ((A_0, 1), (A_1, 0), (A_2, 0), \dots, (A_k, 0)).
\]
and note that $|T| < |S|$, so $T$ has a \glocal difference term $t$.
We will prove that the term $d(x,y,z) = t(p(x,y,z), p(y,y,z), z)$
is a \glocal difference term for $S$.

The first pair in $S$ is $(A_0, 1)$, so we want to show for all $a$, $b \in A_0$ that
$d(a,a,b) = b$.
Fix $a$, $b \in A_0$. By definition of $d$,
we have $d(a,a,b) = t(p(a,a,b), p(a,a,b), b) =b$.
The last equality holds since $t$ is a \glocal difference term for $T$, in particular,
for $(A_0, 1)$.

Next, consider the (possibly empty) set of indices $\{i \mid 1\leq i \leq k\}$.
For such indices $\chi_i =0$, so we will prove
for all $a$, $b \in A_i$ that
\[
d(a,b,b) \comr{\Cg(a,b)} a.
\]
Fix $a, b\in A_i$.
By definition of $d$ and idempotence of $p$, we have
\begin{align}
  d(a,b,b) &=
  t(p(a,b,b), p(b,b,b), b)   \label{eq:444}\\
  &=t(p(a,b,b), b, b). \nonumber
\end{align}
Next, since $p$ is a \glocal difference term for $S'$,
hence for $(A_i, 0)$, we have
\begin{equation}
  \label{eq:555}
  t(p(a,b,b), b, b)
 \comr{\Cg(a,b)}
 t(a, b, b).
\end{equation}
Finally, since $t$ is a \glocal difference term for $T$, hence for
$(A_i, 0)$,  %% $(1\leq i \leq k)$,
we have 
\[
t(a, b, b) \comr{\Cg(a,b)} a.
\]
Combining this with (\ref{eq:444}) and (\ref{eq:555}) yields
$d(a,b,b) \comr{\Cg(a,b)} a$,
as desired.

The indices of the remaining elements of $S$
belong to the set $\{j \mid k<j\leq n\}$ (which is nonempty since we
assumed $\chi_0 = \chi_i = 1$ for some $i>0$).
For such indices we have $\chi_j = 1$.
Thus, fixing $a, b \in A_j$, we check that $d(a,a,b) = b$.
Indeed, $p(a,a,b) = b$, since $p$ is a \glocal difference term for $S'$; 
this, along with idempotence of $t$, yields
$d(a,a,b) =t(p(a,a,b), p(a,a,b), b)=t(b, b, b) =b$.
\end{proof}

\subsection{Proof of Corollary~\ref{cor:glob-loc-diff-term}}
\label{sec:proof-cor:glob}
\begin{corollary}[\ref{cor:glob-loc-diff-term}]
  Let $\sV$ be a variety.  Let $\scA$ be a collection of finite idempotent
  algebras in $\sV$. %% that is closed under the taking of subalgebras.
  Then there exists a term $d$ that interprets as a difference term operation
  for every algebra in $\scA$
  if and only if each pair $((A,i), (B,j)) \in \scS(\scA)^2$ has a \glocal
  difference term.
\end{corollary}
The proof of this result is also easy and very similar to the proof
of~\ref{cor:loc-diff-term}; nevertheless, it appears in the appendix
(see Section~\ref{sec:proof-thm:glob}).
\begin{proof}
  One direction is clear, since a term that is a difference term operation for
  every $\bA \in \scA$ is obviously a \glocal difference term for
  every $(A, i) \in \scS(\scA)$.
  For the converse, suppose
  each pair in $\scS(\scA)^2$ has a \glocal
  difference term. Then, by Theorem~\ref{thm:glob-loc-diff-terms},
  there is a single term $d$ that is a \glocal difference term for every 
  $(A, i) \in \scS(\scA)$, 
  and therefore $d$ interprets as a difference term operation for every $\bA \in \scA$.
  To see this, choose an arbitrary $\bA = \<A, \dots\> \in \scA$ and fix $a, b \in A$. 
  Then $a \comr{\Cg(a,b)} d^{\bA}(a,b,b)$,
  since $d$ is a \glocal difference term for $(A,0)$,
  and $d^{\bA}(a,a,b) = b$, since $d$ is a \glocal
  difference term for $(A,1)$. 
  %% Since $a, b$ were arbitrary elements of $A$, we conclude that
  %% $d$ is a difference term operation for $\bA$.
\end{proof}

\end{document}












































%%% I'M NOT SURE WHETHER LOCAL MINORITY TERMS REALLY WORK %%%

\section{Local minority terms}
Let $\sV$ be a variety.  A term $m$ in the language of $\sV$
is called a \defn{minority term} if for every $\bA \in \sV$ and
all $a, b \in A$ it is the case that 
\[
m(a,b,b) =m(b,a,b) = m(b,b,a) = a.
\]
%% Let $\bA = \<A, \dots\>$ be an algebra in a variety $\sV$, let $t$ be a term
%% of $\sV$.
If $t$ is a term of $\sV$ and $\bA = \<A, \dots\>$ an algebra in $\sV$, 
then we call $t$ a \defn{local minority term} for the triple
$(a,b,i) \in A\times A \times \{0,1,2\}$ provided
\begin{align}
\text{ if $i=0$, then } & t(a, b, b)= a\label{eq:2}\\
\text{ if $i=1$, then } & t(b,a,b) = a\label{eq:4}\\
\text{ if $i=2$, then } & t(b,b,a) = a\label{eq:5}. 
\end{align}
We call $t$ a
\defn{local minority term} for the sequence
\[
((a_0, b_0, \chi_0), (a_1, b_1, \chi_1), \dots, (a_{n-1}, b_{n-1}, \chi_{n-1}))
\in (A\times A \times \{0,1,2\})^n\]
provided it is a local minority term for each triple in the sequence.
We call $t$ a \defn{\glocal minority term} for 
$(A,i)$ provided conditions~(\ref{eq:2}),~(\ref{eq:4}), and~(\ref{eq:5}) hold
for all $a, b \in A$.
If $\scA$ is a collection of algebras in $\sV$, and if
$S = ((A_0, \chi_0), (A_1, \chi_1), \dots, (A_{n-1}, \chi_{n-1}))$
is a sequence of pairs $(A_i, \chi_i) \in \scA \times \{0,1,2\}$, then
we call $t$ a \defn{\glocal minority term for $S$} if it is a
\glocal minority term for every $(A_i, \chi_i)$ in the sequence
$S$.

\begin{thm}
  Let $n\geq 3$ and let
  $S  = ((a_0, b_0, \chi_0), \dots, (a_{n-1}, b_{n-1}, \chi_{n-1}))
  \in (A\times A \times \{0,1,2\})^n$.
  Suppose for all
  $0\leq i, j, k <n$ that the subsequence 
  $((a_i, b_i, \chi_i), (a_j, b_j, \chi_j), (a_k, b_k, \chi_k))$ of $S$ 
  has a local minority term.  Then $S$ has a local minority term.
\end{thm}
\begin{proof}
  The proof is by induction on the length, $|S|$, of the sequence.  In the base
  case, $|S| = 3$, the claim is true by assumption.
  Fix $n\geq 3$ and assume the claim holds for all sequences of length
  $3\leq k\leq n$.
  We prove the claim holds for an arbitrary length-$(n+1)$ sequence, 
  $S = ((a_0, b_0, \chi_0), (a_1, b_1, \chi_1), \dots, (a_{n}, b_{n}, \chi_{n}))$.
  Since $|S|>3$, there exists $i \neq j$ such that $\chi_i = \chi_j$.
  Assume without loss of generality that $j=0$.
  Let $\sigma' = ((a_1, b_1, \chi_1), \dots, (a_{n}, b_{n}, \chi_{n}))$, which
  has a local minority term $p$ by the induction hypothesis.

  We split the remainder of the proof into two cases.

  \vskip3mm

  %--------------------------------------
  \noindent \underline{Case $\chi_0 = 0$:}
  Without loss of generality, suppose for some $1\leq k \leq j < n$ that
  $\chi_1 =  \cdots =\chi_k = 1$,
  $\chi_{k+1}  = \cdots = \chi_{j} = 2$, and
  $\chi_{j+1} = \cdots = \chi_{n} = 0$.
  Define
  $T = ((a_0, b_0, \chi_0), (a_1, b_1, \chi_1), \dots, (a_j, b_j, \chi_j))$.
  %% T = ((A_0 \chi_0), (A_1, \chi_1), (A_2, \chi_2), \dots, (A_j, \chi_j)).
  Note that $|T| < |S|$, so $T$ has a local minority term $t$.
  Define
  %%%%%%%%%
                $m(x,y,z) = t(x, p(x,y,y), p(x,y,z))$.
  %%%%%%%%%
  We will prove that $m$ is a local minority term for $S$.

  %% The first triple in $S$ is $(a_0, b_0, 0)$, so we prove for all $a$, $b \in A_0$
  The first triple in $S$ is $(a_0, b_0, 0)$, so we first check that
  $m(a_0,b_0,b_0)= a_0$. Indeed,
  \[
  m(a_0,b_0,b_0) = t(a_0, p(a_0, b_0, b_0), p(a_0, b_0, b_0)) = a_0.
  \]
  The second equality holds because $t$ is a local minority term for $T$.

  %%------
  For indices in the (possibly empty) set $\{i \mid 0 < i \leq k\}$, we have
  $\chi_i = 1$, so we check that $m(b_i, a_i, b_i) = a_i$, as follows:
  \[
  m(b_i,a_i,b_i) = t(b_i, p(b_i, a_i, a_i), p(b_i, a_i, b_i)) = t(b_i, b_i, a_i)
  = a_i.
  \]
  The second equality holds because $p$ is a local minority term for $S'$, the
  third holds because $t$ is a local minority term for $T$.

  %%------
  Next for indices in the (possibly empty) set $\{i \mid k< i \leq j\}$, we have
  $\chi_i = 2$, so we check that $m(b_i, b_i, a_i) = a_i$.  Indeed,
  \[
  m(b_i,b_i,a_i) = t(b_i, p(b_i, b_i, b_i), p(b_i, b_i, a_i)) = t(b_i, b_i, a_i)
  = a_i.
  \]
  The second equality holds by idempotence and because $p$ is a
  local minority term for $S'$; the third equality holds since $t$ is a local minority
  term for $T$.

  Finally, we consider indices in the set $\{i \mid j< i \leq n\}$, which we know is
  nonempty since we assumed $\chi_i = \chi_0 = 0$ for some $i>0$.
  For such indices, $\chi_i=0$ so we check that
  $m(a_i,b_i,b_i)= a_0$, as follows:
  \[
  m(a_i,b_i,b_i) = t(a_i, p(a_i, b_i, b_i), p(a_i, b_i, b_i)) =
   t(a_i, a_i, a_i) =a_i.
  \]
  The second equality holds since $p$ is a local minority term for $S'$,
  and the last equality holds by idempotence.
  \\
  \underline{Case $\chi_0 = 1$:}\\
  \\
  \underline{Case $\chi_0 = 2$:} 
  
  %% \[
  %% T = ((a_0, b_0, \chi_0), (a_1, b_1, \chi_1), \dots, (a_{n}, b_{n}, \chi_{n}))$.
  
\end{proof}

\draftsecskip












































\appendix

%% \section{Facts about centralizers and abelian algebras}
%% \label{sec:proofs-elem-facts}

\section{More About Abelian Algebras}
\label{sec:abelian-algebras}
Here are some additional facts about abelian algebras that are sometimes useful.

\begin{lem}
If $\Clo(\bA)$ is trivial (i.e., generated by the projections),
then $\bA$ is abelian.
\end{lem}
In fact, it can be shown that $\bA$ is \emph{strongly abelian} in this case, but
we won't prove this stronger result. The proof that $\bA$ is abelian is
elementary is a nice and easy example of a standard proof technique---induction on
term height.\footnote{This proof would be a good one to try in a proof assistant
  like Coq, since such tools excel at inductive arguments like this one.}
\begin{proof}
We want to show $\sansC(1_A, 1_A)$.  Equivalently, we must show
that for all $t\in \Clo(\bA)$ (say, $(\ell+m)$-ary) 
and all $a, b \in A^\ell$, we have $\ker t(a,\cdot)=\ker t(b,\cdot)$.
We prove this by induction on the height of the term $t$.  Height-one terms are
projections and the result is obvious for these.  Let $n>1$ and assume the result
holds for all terms  of height less than
$n$.  Let $t$ be a term of height $n$, say, $k$-ary.  Then for some terms 
$g_1, \dots, g_k$ of height less than $n$ and for some $j\leq k$, we have
$t = p^k_j [g_1, g_2, \dots, g_k] = g_j$ and since $g_j$ has height less than
$n$, we have
\[
\ker t(a,\cdot)=\ker g_j(a,\cdot) = \ker g_j(b,\cdot)=\ker t(b,\cdot).
\]\end{proof}


\begin{lem}
 An algebra $\bA$ is abelian if and only if there is some 
 $\theta \in \Con (\bA^2)$ that has the diagonal $D(A):= \{(a,a): a \in A\}$ 
 as a congruence class.
\end{lem}
\begin{proof}
($\Leftarrow$) Assume $\Theta$ is such a congruence.  Fix 
  $k<\omega$,
  $t^{\bA}\in \Clo_{k+1}(\bA)$, 
  $u, v \in A$, and
  $\bx, \by \in A^k$.
  We will prove the implication~(\ref{eq:22}), which in the present context is
\begin{equation*}
t^\bA(\bx,u) = t^\bA(\by,u) \quad \Longrightarrow \quad 
t^{\bA}(\bx,v) = t^{\bA}(\by,v).
\end{equation*}
Since $D(A)$ is a class of $\Theta$, we have 
  $(u,u) \mathrel{\Theta} (v,v)$, and since $\Theta$ is a reflexive relation, we have
  $(x_i,y_i)  \mathrel{\Theta} (x_i,y_i)$ for all $i$.  Therefore,
\begin{equation}
  \label{eq:9}  
  t^{\bA\times \bA}((x_1,y_1), \dots, (x_k,y_k), (u,u))
  \mathrel{\Theta}
  t^{\bA\times \bA}((x_1,y_1), \dots, (x_k,y_k), (v,v)).
\end{equation}
  since $t^{\bA \times \bA}$ is a term operation of $\bA\times \bA$.
  Note that~(\ref{eq:9}) is equivalent to
  \begin{equation}
    \label{eq:13}
    (t^{\bA}(\bx, u), t^{\bA}(\by,u))
    \mathrel{\Theta}
    (t^{\bA}(\bx, v), t^{\bA}(\by, v)).
  \end{equation}
  If $t^{\bA}(\bx, u)= t^{\bA}(\by, u)$ then 
  the first pair in~(\ref{eq:13}) belongs to the $\Theta$-class
  $D(A)$, so the second pair must also belong this $\Theta$-class.
  That is, $t^{\bA}(\bx, v)= t^{\bA}(\by, v)$, as desired.

  \vskip2mm

  \noindent ($\Rightarrow$) Assume $\bA$ is abelian. We show
  $\Cg^{\bA^2}(D(A)^2)$ has $D(A)$ as a block.  Assume
  \begin{equation}
    \label{eq:16}
  ((x,x), (c,c')) \in \Cg^{\bA^2}(D(A)^2).
  \end{equation}
  It suffices to prove that $c=c'$.  Recall, \malcev's congruence generation
  theorem states that (\ref{eq:16}) holds iff
  %$(x,x) \theta (c,c') \in \Cg^{\bA^2}(D(A)^2)$ iff %% for $0\leq i \leq n$ and 
  %% $0\leq j \leq n-1$, there exist
  \begin{align*}
  \exists \,& (z_0,z_0'), (z_1,z_1'), \dots, (z_n,z_n') \in A^2\\
    \exists \,& ((x_0,x_0'), (y_0,y_0')), ((x_1,x_1'), (y_1,y_1')), \dots, 
    ((x_{n-1},x_{n-1}'), (y_{n-1},y_{n-1}')) \in D(A)^2\\
    \exists \, & f_0, f_1, \dots, f_{n-1}\in F^*_{\bA^2}
  \end{align*}
  %% \begin{align*}
  %% (z_i,z_i') &\in A^2\\
  %% ((x_j,x_j'), (y_j,y_j')) &\in D(A)^2\\
  %% f_j &\in F^*_{\bA^2}
  %% \end{align*}
  such that 
  \begin{align}
    \label{eq:7}
    \{(x, x),(z_1,z_1')\} &= \{f_0(x_0,x_0'), f_0(y_0,y_0')\}\\
\nonumber
     \{(z_1,z_1'),(z_2,z_2')\} &= \{f_1(x_1,x_1'), f_1(y_1,y_1')\}\\
\nonumber
     & \vdots\\
    \label{eq:8}
     \{(z_{n-1},z_{n-1}'),(c, c')\} &= \{f_{n-1}(x_{n-1},x_{n-1}'), f_{n-1}(y_{n-1},y_{n-1}')\}
 \end{align}
The notation $f_i\in F^*_{\bA^2}$ means 
\begin{align*}
f_i(x, x') &= g_i^{\bA^2}((a_1, a_1'), (a_2, a_2'), \dots, (a_k, a_k'), (x, x'))\\
&= (g_i^{\bA}(a_1, a_2, \dots, a_k, x), g_i^{\bA}(a_1', a_2', \dots, a_k', x')),
\end{align*}
for some $g_i^{\bA} \in \Clo_{k+1}(\bA)$ and some constants 
$\ba = (a_1, \dots, a_k)$ and $\ba' = (a_1', \dots, a_k')$ in $A^k$. 
Now, $((x_i,x_i'), (y_i,y_i'))\in D(A)^2$ implies 
$x_i=x_i'$, and $y_i=y_i'$, so in fact we have 
\[
     \{(z_i,z_i'),(z_{i+1},z_{i+1}')\} = \{f_i(x_i,x_i), f_i(y_i,y_i)\} \quad (0\leq i < n).
\]
Therefore, by Equation~(\ref{eq:7}) we have either 
\[
     (x,x)= (g_i^{\bA}(\ba, x_0), g_i^{\bA}(\ba', x_0)) \quad \text{ or } \quad 
     (x,x)= (g_i^{\bA}(\ba, y_0), g_i^{\bA}(\ba', y_0)).
\]
Thus, either $g_i^{\bA}(\ba, x_0) =  g_i^{\bA}(\ba', x_0)$ %\quad \text{ or } \quad 
or $g_i^{\bA}(\ba, y_0) =  g_i^{\bA}(\ba', y_0)$.
By the abelian assumption, if one of these equations holds, then so does the
other. This and and Equation (\ref{eq:7}) imply $z_1 = z_1'$.  Applying the same
argument inductively, we find that $z_i = z_i'$ for all $1\leq i < n$ and so, by
(\ref{eq:8}) and the abelian property, we have $c= c'$.
\end{proof}

\begin{lem}
Suppose $\rho\colon A_1 \to A_2$ is a bijection and suppose the graph
$\{(x, \rho x) \mid x \in A_1\}$ is a block of some congruence
$\beta \in \Con (A_1 \times A_2)$.  Then both $\bA_1$ and $\bA_2$ are abelian.
\end{lem}
\begin{proof}
  Define the relation $\alpha\subseteq (A_1\times A_1)^2$ as follows: for
  $((a,a'), (b,b')) \in (A_1\times A_1)^2$,
  \[
  (a,a')\mathrel{\alpha} (b,b')
  \quad \iff \quad
  (a, \rho a') \mathrel{\beta} (b, \rho b')
  \]
  We prove that the diagonal $D(A_1)$ is a block of $\alpha$ by showing that
  $(a, a) \mathrel{\alpha} (b,b')$ implies $b = b'$.
  Indeed, if $(a, a) \mathrel{\alpha} (b,b')$, then
  $(a, \rho a) \mathrel{\beta} (b, \rho b')$, which means that
  $(b, \rho b')$ belongs to the block and
  $(a, \rho a)/\beta = \{(x, \rho x): x\in A_1\}$.  Therefore,
  $\rho b  = \rho b'$, so $b = b'$ since $\rho$ is injective.
  This proves that $\bA_1$ is abelian.

  To prove $\bA_2$ is abelian, we reverse the roles of $A_1$ and $A_2$ in the
  foregoing argument.  
  If $\{(x, \rho x) \mid x \in A_1\}$ is a block of $\beta$,
  then 
  $\{(\rho^{-1}(\rho x), \rho x) \mid \rho x \in A_2\}$ is a block of $\beta$; that
  is, $\{(\rho^{-1} y, y) \mid y \in A_2\}$ is a block of $\beta$.  Define 
  the relation $\alpha\subseteq (A_2\times A_2)^2$ as follows: for
  $((a,a'), (b,b')) \in (A_2\times A_2)^2$,
  \[
  (a,a')\mathrel{\alpha} (b,b')
  \quad \iff \quad
  (\rho^{-1}a, \rho a') \mathrel{\beta} (\rho^{-1}b, \rho b').
  \]
  As above, we can prove that the diagonal $D(A_2)$ is a block of $\alpha$
  by using the injectivity of $\rho^{-1}$ to show that $(a, a) \mathrel{\alpha}
  (b,b')$
  implies $b = b'$.
\end{proof}

%\bibliographystyle{amsplain} %% or amsalpha
%% \bibliographystyle{alpha-url}
%% \printbibliography
\bibliographystyle{alphaurl}
\bibliography{inputs/refs}


\end{document}







\subsection{Definitions} %: tolerance, centralizing, abelian}
Let $\bA = \<A, F^{\bA}\>$ be an algebra.
A reflexive, symmetric, compatible binary relation $T\subseteq A^2$ is called a
\defn{tolerance of $\bA$}.  
As a compatible binary relation, a tolerance is a subuniverse of $\bA^2$.
If $T$ is a tolerance of $\bA$, and if $(\bu, \bv) \in A^m\times A^m$
is a pair of $m$-tuples of $A$, then we write 
$\bu \mathrel{\bT} \bv$ just in case $\bu(i) \mathrel{T} \bv(i)$ for all $i\in \mm$. 
(Here we have surreptitiously introduced another very convenient notation, namely,
$\mm := \{0, 1, 2, \dots, m-1\}$.)

Suppose $S$ and $T$ are tolerances on $\bA$.  An \defn{$S,T$-matrix} 
is a $2\times 2$ array of the form
\[
\begin{bmatrix*}[r] t(\ba,\bu) & t(\ba,\bv)\\ t(\bb,\bu)&t(\bb,\bv)\end{bmatrix*},
\]
where $t$, $\ba$, $\bb$, $\bu$, $\bv$ have the following properties:
\begin{enumerate}[(i)]
\item $t\in \Clo_{\ell + m}(\bA)$,
\item $(\ba, \bb)\in A^\ell\times A^\ell$ and $\ba \mathrel{\bS} \bb$,
\item $(\bu, \bv)\in A^m\times A^m$ and $\bu \mathrel{\bT} \bv$.
\end{enumerate}
Let $\delta$ be a congruence relation of $\bA$.
If the entries of every $S,T$-matrix satisfy
\begin{equation}
  \label{eq:22}
t(\ba,\bu) \mathrel{\delta} t(\ba,\bv)\quad \iff \quad t(\bb,\bu) \mathrel{\delta} t(\bb,\bv),
\end{equation}
then we say that $S$ \defn{centralizes $T$ modulo} $\delta$ and we write 
$\sansC(S, T; \delta)$.
That is, $\sansC(S, T; \delta)$ holds iff 
(\ref{eq:22}) holds \emph{for all}
$\ell$, $m$, $t$, $\ba$, $\bb$, $\bu$, $\bv$ satisfying properties (i)--(iii).
The condition $\sansC(S, T; 0_{A})$ is sometimes called the 
\defn{$S, T$-term condition}, and when it holds we say  that
$S$ \defn{centralizes} $T$, and write
$\sansC(S, T)$.
%% REMOVING THIS since I don't think we ever use the commutator notation again.
%% The \defn{commutator} of $\bS$ and $\bT$, denoted by $[\bS, \bT]$,
%% is the least congruence $\delta$ such that $\sansC(\bS, \bT; \delta)$ 
%% holds.  

A tolerance $T$ is called \defn{abelian} if
$\sansC(T, T)$. %(i.e., $[\bT, \bT] = 0_A$).  
An algebra $\bA$ is called \defn{abelian} if $1_A$ is abelian.
%% (i.e., $[1_A, 1_A] = 0_A$).
%% The \defn{centralizer of $\bT$ modulo $\delta$}, denoted by
%% $(\delta : \bT )$, is the largest congruence $\alpha$ on $\bA$ such that 
%% $\sansC(\alpha, \bT ; \delta)$ holds.

\begin{rem}
An algebra $\bA$ is abelian iff $\sansC(1_A, 1_A)$ iff
\[
\forall \ell \in \{0,1,2,\dots \}, 
\quad \forall m \in  \{1,2,\dots \},
\quad \forall t\in \Clo_{\ell + m}(\bA),
\quad \forall (a, b)\in A^\ell\times A^\ell,
\]
\[
\ker t(a, \cdot)=\ker t(b, \cdot).
\]
\end{rem}










\begin{lem}[Lemma \ref{lem:M3-abelian}]
If $\alpha_1$, $\alpha_2$, $\alpha_3 \in \Con(\bA)$ are pairwise complements,
then $\sansC(1_A, \alpha_i)$ for each $i=1,2,3$.  If, in addition, $\bA$ is
idempotent and has a Taylor term operation, then $\sansC(1_A, 1_A)$; that is, $\bA$ is abelian.
\end{lem}
\begin{proof}
  The goal is to prove $\sansC(1_A, 1_A)$.
  By Lemma~\ref{lem:centralizers}~(\ref{fact:centralizing_over_meet}), we have
  $\sansC(\alpha_1, \alpha_2; \alpha_1 \meet \alpha_2)$.  
  Since $\alpha_1 \meet \alpha_2= 0_A$, this means
  $\sansC(\alpha_1, \alpha_2)$.
  Similarly, $\sansC(\alpha_3, \alpha_2)$.  Therefore, by 
  Lemma~\ref{lem:centralizers}~(\ref{fact:centralizing_over_join1}), we have
  $\sansC(\alpha_1 \join \alpha_3, \alpha_2)$. This is equivalent to 
  $\sansC(1_A, \alpha_2)$, since $\alpha_1 \join \alpha_3 = 1_A$. 
  The same argument \emph{mutatis-mutandis} yields
  $\sansC(1_A,\alpha_1)$ and $\sansC(1_A,\alpha_3)$. 
  Before proceeding, note that $\sansC(\alpha_1, \alpha_1)$, by 
  Lemma~\ref{lem:centralizers}~(\ref{fact:monotone_centralizers1}).
  Now, if $\bA$ is idempotent and has a Taylor term operation, then
  by \ref{thm:kearnes-kiss-3.27} we have 
  $\sansC(\alpha_1 \join \alpha_2,\alpha_1 \join \alpha_2; \alpha_2)$.
  That is, $\sansC(1_A,1_A; \alpha_2)$.
  Similarly, $\sansC(1_A,1_A; \alpha_3)$.
  By~\ref{lem:centralizers}~(\ref{fact:centralizing_over_meet2}) then, 
  $\sansC(1_A,1_A; \alpha_2 \meet\alpha_3)$. 
  That is, $\sansC(1_A,1_A)$.
\end{proof}











































\noindent [{\it wjd: I'm not sure about item
    (\ref{fact:dual_monotone_centralizers}) in the next lemma.}]

\begin{lem}
\label{lem:centralizers}
Let $\bA$ be an algebra with congruences 
$\alpha, \beta, \gamma, \alpha', \beta' \in \Con(\bA)$, and let 
$\bB$ be a subalgebra of $\bA$. Then,
\begin{enumerate}
\item \label{fact:centralizing_over_meet}
  $\sansC(\alpha, \beta; \alpha \meet \beta)$;
\item \label{fact:centralizing_over_meet2}
  if $\sansC(\alpha, \beta; \gamma)$ and $\sansC(\alpha, \beta; \gamma')$, then
  $\sansC(\alpha, \beta; \gamma \meet \gamma')$;
\item \label{fact:centralizing_over_join1}
  if $\sansC(\alpha, \beta; \gamma)$ and $\sansC(\alpha', \beta; \gamma)$, then
  $\sansC(\alpha \join \alpha', \beta; \gamma)$;
%% \item \label{fact:centralizing_over_join2}
%%   if $\sansC(\alpha, \beta; \gamma)$ and $\sansC(\alpha, \beta'; \gamma)$, then
%%   $\sansC(\alpha, \beta \join \beta'; \gamma)$;
\item \label{fact:monotone_centralizers1}
  if $\sansC(\alpha, \beta; \gamma)$ and $\alpha' \leq \alpha$, then 
  $\sansC(\alpha', \beta; \gamma)$;
\item \label{fact:monotone_centralizers2}
  if $\sansC(\alpha, \beta; \gamma)$ and $\beta' \leq \beta$, then
  $\sansC(\alpha, \beta'; \gamma)$;
\item \label{fact:dual_monotone_centralizers}
  if $\sansC(\alpha, \beta; \gamma)$ and $\gamma \leq \gamma'$, then
  $\sansC(\alpha, \beta; \gamma')$;
\item \label{item:subalg}
  if $\sansC(\alpha, \beta; \delta)$ holds in $\bA$, 
  then $\sansC(\alpha\cap B^2, \beta\cap B^2;\delta\cap B^2)$ holds in $\bB$;
\item \label{item:factors}
  if $\delta' \leq \delta$, then $\sansC(\alpha, \beta; \delta)$ holds 
  in $\bA$ if and only if $\sansC(\alpha/\delta', \beta/\delta'; \delta/\delta')$
  holds in $\bA/\delta'$.
\end{enumerate}
\end{lem}

\noindent [{\it wjd: I don't remember what made me think (\ref{fact:dual_monotone_centralizers})
is true. Maybe it holds in the \cm case?}]

\begin{rem}
By (\ref{fact:centralizing_over_meet}), 
if $\alpha \meet \beta = 0_{\bA}$,  
then $\sansC(\beta, \alpha)$ and $\sansC(\alpha, \beta)$.
By (\ref{fact:dual_monotone_centralizers}),
if an algebra $\bA$ is abelian, 
then $\sansC(1_A, 1_A; \theta)$ for all $\theta \in \Con(\bA)$, so
in this case (\ref{item:factors}) implies that %$\sansC(1_{\bA/\theta}, 1_{\bA/\theta})$ 
$\bA/\theta$ is abelian for every $\theta \in \Con(\bA)$.
\end{rem}

We close this section with a collection of lemmas that can be useful for showing 
that an algebra is abelian.  Proofs of these facts appear in Appendix
Section~\ref{sec:proofs-elem-facts}.

We denote the diagonal of $A$ by $D(A) := \{(a,a): a \in A\}$. 
\begin{lem}
\label{lem:diagonal}
An algebra $\bA$ is abelian if and only if there is some $\theta \in \Con (\bA^2)$ that has
the diagonal set $D(A)$ as a congruence class.
\end{lem}

Lemma~\ref{lem:diagonal} can be used to prove the next result
which states that if there is a congruence of $\bA_1 \times \bA_2$ that has the
graph of a bijection between $A_1$ and $A_2$ as a block, then both $\bA_1$ and
$\bA_2$ are abelian algebras.

\begin{lem}
  \label{lem:bijection_abelian}
Suppose $\rho \colon A_0 \to A_1$ is a bijection and suppose the graph
$\{(x, \rho x) \mid x \in A_0\}$ is a block of some congruence
$\beta \in \Con (A_0 \times A_1)$.  Then both $\bA_0$ and $\bA_1$ are abelian.
\end{lem}

\begin{lem}
\label{lem:triv-clone-implies-abelian}
If $\Clo(\bA)$ is trivial (i.e., generated by the projections),
then $\bA$ is abelian.
\end{lem}

%% \begin{lem}\label{lem:M3-abelian}
%% If $\alpha_1$, $\alpha_2$, $\alpha_3 \in \Con(\bA)$ are pairwise complements,
%% then $\sansC(1_A, \alpha_i)$ for each $i=1,2,3$.  If, in addition, $\bA$ is
%% idempotent and has a Taylor term operation, then $\sansC(1_A, 1_A)$; that is, $\bA$ is abelian.
%% \end{lem}














\subsection{Alternative development}
Here is the development of similar notions from Hobby and McKenzie~\cite[Ch.~3]{HM:1988}.
Let $\alpha$, $\beta$, $\delta$ be congruences of an algebra $\bA$.
We use the formula $\sansC(\alpha, \beta; \delta)$
(in words, $\alpha$ centralizes $\beta$ modulo $\delta$) as an abbreviation for the
following property: For every $n > 1$, for every $f \in \Pol_n(\bA)$,
for all $(u,v)\in \alpha$, and for all $(x_i, y_i)\in \beta$ $(1< i<n)$, 
the following equivalence holds:
\begin{equation}
  \label{eq:1}
  f(u, x_1, \dots, x_{n-1}) \mathrel{\delta}  f(u, y_1, \dots, y_{n-1})
  \quad \iff \quad
  f(v, x_1, \dots, x_{n-1}) \mathrel{\delta}  f(v, y_1, \dots, y_{n-1}).
\end{equation}
